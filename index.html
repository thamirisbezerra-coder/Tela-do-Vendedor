<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela do Vendedor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease; }
        /* Style for notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            padding: 2px 5px;
            border-radius: 50%;
            background: red;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }
         /* Style for seller notification items */
        .seller-notification-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .seller-notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .seller-notification-item blockquote {
            border-left: 3px solid #d1d5db; /* gray-300 */
            padding-left: 0.75rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-style: italic;
            color: #4b5563; /* gray-600 */
        }
        /* Style for manager/seller replies */
        .manager-reply, .seller-reply {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .manager-reply {
            background-color: #f3f4f6; /* gray-100 */
            border-left: 3px solid #9ca3af; /* gray-400 */
        }
         .seller-reply {
            background-color: #f0f9ff; /* blue-50 */
            border-left: 3px solid #60a5fa; /* blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }

        /* Style for status indicators (dots) */
        .status-dot {
            display: inline-block;
            width: 0.6rem; /* Smaller dot */
            height: 0.6rem;
            border-radius: 50%;
            margin-right: 0.5rem; /* Space between dot and text */
            vertical-align: middle; /* Align dot with text */
        }
        .dot-yellow { background-color: #facc15; } /* yellow-400 */
        .dot-green { background-color: #4ade80; } /* green-400 */

    </style>
</head>
<body class="bg-gray-100">

    <!-- Access View -->
    <div id="access-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-md p-8 text-center">
            <div class="mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-20 w-20 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Ol√°, vendedor(a) Doremus!</h1>
                <p class="text-gray-600 mt-2">Chegou o seu painel de feedbacks de amostras. Colabore conosco para continuarmos atendendo da melhor forma :)</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="session-id-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">ID da Sess√£o</label>
                    <input type="text" id="session-id-input" placeholder="Cole o ID da sess√£o aqui" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="seller-name-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">O seu Nome de Vendedor</label>
                    <input type="text" id="seller-name-input" placeholder="Escreva seu nome igual ao anexo no e-mail" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">C√≥digo de Acesso</label>
                    <input type="text" id="access-code-input" placeholder="Insira o c√≥digo de 6 d√≠gitos" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
            </div>
            <button id="load-data-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">Aceder Amostras</button>
            <p id="access-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            <p class="text-xs text-gray-400 mt-8">Doremus, 2025</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden flex flex-col items-center justify-center min-h-screen text-center">
        <h1 id="loading-message" class="text-2xl font-bold text-gray-700">A carregar as suas amostras...</h1>
        <!-- Optional: Add a spinner -->
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl">
             <header class="mb-8 text-center relative flex justify-between items-start">
                 <div> <!-- Wrapper for title and subtitle -->
                     <h1 id="welcome-title" class="text-3xl font-bold text-gray-800 text-left">Ol√°!</h1>
                     <p class="text-gray-600 mt-2 text-left">Este √© o seu painel para gest√£o de feedbacks de amostras.</p>
                 </div>
                 <div class="flex items-center gap-4"> <!-- Wrapper for buttons -->
                     <!-- Notification Bell -->
                     <div class="relative flex flex-col items-center">
                         <button id="seller-notification-btn" class="relative text-gray-500 hover:text-gray-700" title="Ver respostas do gestor">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                             <span id="seller-notification-count" class="notification-badge hidden">0</span>
                         </button>
                         <p id="notification-prompt" class="hidden text-xs text-blue-600 font-semibold animate-pulse">‚Üì Verificar</p>
                     </div>
                     <button id="logout-btn" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg text-sm hover:bg-red-600 transition-colors h-fit">Sair</button>
                 </div>
            </header>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-200">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Como Funciona?</h3>
                    <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <li>Expanda um pedido para ver as amostras (indicadas por <span class="status-dot dot-yellow"></span> Pendente ou <span class="status-dot dot-green"></span> Respondido).</li>
                        <li>Clique em <strong>"Atualizar"</strong> ou <strong>"Editar"</strong> na amostra desejada.</li>
                        <li>Selecione uma op√ß√£o de feedback e escreva a observa√ß√£o.</li>
                        <li>Quando todas as amostras de um pedido estiverem respondidas (<span class="status-dot dot-green"></span>), clique em <strong>"Sinalizar Gestor"</strong>.</li>
                        <li>Mesmo ap√≥s sinalizar, voc√™ pode <strong>Editar</strong> ou <strong>Excluir</strong> um feedback na se√ß√£o "Conclu√≠dos". Excluir reabrir√° a pend√™ncia do pedido.</li>
                        <li>Verifique as respostas do gestor clicando no <strong class="text-blue-600">sino üîî</strong>.</li>
                    </ol>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">D√∫vidas?</h3>
                    <p class="text-sm text-gray-600">Se encontrar algum problema ou tiver alguma quest√£o sobre o preenchimento, n√£o hesite em me contatar.</p>
                    <p class="text-sm text-gray-600 mt-2">Pode me chamar no <strong>chat</strong> ou enviar um <strong>e-mail</strong>.</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-800">Thamiris Bezerra</p>
                        <p class="text-sm text-gray-600">thamiris.bezerra@doremus.com.br</p>
                    </div>
                </div>
            </div>

            <div id="pending-section" class="hidden">
                <h2 id="pending-orders-count" class="text-2xl font-bold text-gray-800 mb-4">Pedidos Pendentes</h2>
                <div id="pending-orders-list" class="space-y-4"></div>
            </div>

            <div id="completed-section" class="mt-12 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Conclu√≠dos e Sinalizados</h2>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>

            <div id="no-data-message" class="hidden text-center bg-white p-8 rounded-2xl shadow-sm border">
                 <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                 <h2 class="mt-4 text-2xl font-bold text-gray-800">Nenhuma amostra encontrada.</h2>
                 <p class="text-gray-600 mt-2">Verifique se os dados de acesso est√£o corretos.</p>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-4 flex-shrink-0" id="modal-title">Atualizar Feedback</h3>
            <p class="text-gray-600 mb-2 flex-shrink-0">Selecione uma das op√ß√µes abaixo para a amostra:</p>
            <p class="font-semibold text-gray-800 mb-6 flex-shrink-0" id="modal-sample-info"></p>

            <div id="feedback-options" class="grid grid-cols-2 gap-3 mb-6 overflow-y-auto">
                <!-- Feedback buttons populated by JS -->
            </div>

            <div class="flex-shrink-0">
                <label for="observation" class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√£o (Obrigat√≥rio)</label>
                <textarea id="observation" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Justifique o motivo do feedback..."></textarea>
            </div>

            <div class="mt-8 flex justify-end space-x-3 flex-shrink-0">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="save-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

     <!-- Seller Notifications Modal (Added z-30) -->
     <div id="seller-notifications-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
             <div class="flex justify-between items-center mb-4 border-b pb-2">
                  <h3 class="text-xl font-bold">Respostas do Gestor</h3>
                  <button id="close-seller-notifications-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
             </div>
             <div id="seller-notifications-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                  <p class="text-gray-500">Nenhuma resposta recebida.</p>
                  <!-- Notifications populated by JS -->
             </div>
              <div class="mt-6 flex justify-end">
                   <button id="close-seller-notifications-btn-bottom" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
              </div>
         </div>
     </div>

     <!-- Seller Reply Modal (NEW - Added z-40) -->
     <div id="seller-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
             <h3 class="text-xl font-bold mb-4">Responder ao Gestor</h3>
             <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                 <p id="seller-reply-context" class="text-gray-600"></p>
                 <p id="seller-reply-original-msg" class="font-semibold italic"></p>
             </div>
             <div class="space-y-4">
                  <div>
                       <label for="seller-reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta</label>
                       <textarea id="seller-reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta..."></textarea>
                  </div>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-seller-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-seller-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
             </div>
         </div>
     </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Corrected imports
        import { getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, setDoc, serverTimestamp, query, where, writeBatch, limit, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; // Added Timestamp
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // IMPORTANT: Keep your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Feedback choices remain the same
        const FEEDBACK_CHOICES = [
            'A - COM PEDIDO',
            'A - APROVADA SEM PEDIDO',
            'P - AMOSTRA N√ÉO TESTADA',
            'P - EM AN√ÅLISE',
            'P - AMOSTRA SEM FEEDBACK',
            'R - APRESENTA√á√ÉO PR√ì ATIVA',
            'R - CALIBRE',
            'R - EXTRAVIADA',
            'R - FORA DA ESPECIFICA√á√ÉO DO CLIENTE',
            'R - FORA DO PERFIL DO CLIENTE',
            'R - FRACA / ESTOURANDO / COM CHUVEIRO',
            'R - PRODUTO DESCONTINUADO',
            'R - QUANTIDADE INSUFICIENTE',
            'R - REPRESENTA√á√ÉO / DISTRIBUIDOR',
            'R - SEM RETORNO DO CLIENTE',
            'E - INNOVATION / EVENTOS',
            'E - EVENTO',
            'R - EXPORTACAO'
        ];

        // --- DOM Elements ---
        const accessView = document.getElementById('access-view');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const loadDataBtn = document.getElementById('load-data-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const accessError = document.getElementById('access-error');
        const noDataMessage = document.getElementById('no-data-message');
        const welcomeTitle = document.getElementById('welcome-title');

        // Seller Notification Elements
        const sellerNotificationBtn = document.getElementById('seller-notification-btn');
        const sellerNotificationCount = document.getElementById('seller-notification-count');
        const sellerNotificationsModal = document.getElementById('seller-notifications-modal');
        const sellerNotificationsList = document.getElementById('seller-notifications-list');
        const closeSellerNotificationsBtn = document.getElementById('close-seller-notifications-btn');
        const closeSellerNotificationsBtnBottom = document.getElementById('close-seller-notifications-btn-bottom');
        const notificationPrompt = document.getElementById('notification-prompt');

        // Seller Reply Modal Elements (NEW)
        const sellerReplyModal = document.getElementById('seller-reply-modal');
        const sellerReplyContext = document.getElementById('seller-reply-context');
        const sellerReplyOriginalMsg = document.getElementById('seller-reply-original-msg');
        const sellerReplyMessageInput = document.getElementById('seller-reply-message-input');
        const cancelSellerReplyBtn = document.getElementById('cancel-seller-reply-btn');
        const sendSellerReplyBtn = document.getElementById('send-seller-reply-btn');
        let currentNotificationForReply = null; // Store notification being replied to

        // Feedback Modal Elements
        const feedbackModal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSampleInfo = document.getElementById('modal-sample-info');
        const feedbackOptionsContainer = document.getElementById('feedback-options');
        const observationInput = document.getElementById('observation');
        const cancelFeedbackModalBtn = document.getElementById('cancel-modal-btn'); // Renamed for clarity
        const saveFeedbackBtn = document.getElementById('save-button'); // Renamed for clarity

        // --- State Variables ---
        let currentSample = null; // Sample being edited in feedback modal
        let selectedFeedback = null; // Feedback selected in modal
        let currentSellerDocRef = null; // Firestore reference to the seller's document
        let allSellerSamples = []; // Local cache of seller's samples
        let unsubscribe = null; // Listener for seller data updates
        let sellerNotificationListenerUnsubscribe = null; // Listener for notifications TO the seller
        let currentSessionId = null; // Current active session ID
        let currentSellerOriginalName = null; // Store the original name (case-sensitive) for queries
        let sellerNotifications = []; // Local cache of notifications for the seller

        // --- Utility Functions ---
        const normalizeText = (text = '') => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        const sanitizeForFirebaseId = (text) => normalizeText(text).replace(/\//g, "-");

        // --- Authentication & Data Loading ---
        async function attemptLogin(sessionId, sellerName, accessCode, isAutoLogin = false) {
            if (!sessionId || !sellerName || !accessCode) {
                if (!isAutoLogin) accessError.textContent = 'Todos os campos s√£o obrigat√≥rios.';
                return false;
            }

            const sellerId = sanitizeForFirebaseId(sellerName); // Use normalized ID for lookup
            currentSessionId = sessionId;
            currentSellerOriginalName = sellerName; // Store original name for display and queries

            try {
                const docRef = doc(db, "sessoes", sessionId, "vendedores", sellerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().accessCode === accessCode) {
                    currentSellerDocRef = docRef;
                    welcomeTitle.textContent = `Ol√°, ${docSnap.data().originalName}!`; // Use original name from DB
                    currentSellerOriginalName = docSnap.data().originalName; // Ensure we store the correct case from DB

                    // Save credentials only on manual login success
                    if (!isAutoLogin) {
                        localStorage.setItem('sellerSessionId', sessionId);
                        localStorage.setItem('sellerName', currentSellerOriginalName); // Save original name
                        localStorage.setItem('sellerAccessCode', accessCode);
                    }

                    accessError.textContent = '';
                    accessView.classList.add('hidden');
                    loadingState.classList.remove('hidden');

                    requestNotificationPermission(); // Request browser notification permission
                    startRealtimeListener(); // Start listening for sample updates
                    listenForSellerNotifications(); // Start listening for replies from manager
                    return true;
                } else {
                    // Handle login failure
                    if (isAutoLogin) {
                        localStorage.clear(); // Clear invalid stored credentials
                        loadingState.classList.add('hidden');
                        accessView.classList.remove('hidden'); // Show login screen
                    } else if (docSnap.exists()) {
                        accessError.textContent = 'C√≥digo de Acesso inv√°lido. Tente novamente.';
                    } else {
                        accessError.textContent = 'Sess√£o ou Vendedor n√£o encontrado. Verifique os dados.';
                    }
                    return false;
                }
            } catch (e) {
                if (!isAutoLogin) accessError.textContent = 'Erro ao conectar. Verifique sua internet ou o ID da Sess√£o.';
                console.error("Erro de autentica√ß√£o ou busca:", e);
                if (isAutoLogin) {
                    localStorage.clear();
                    loadingState.classList.add('hidden');
                    accessView.classList.remove('hidden');
                }
                return false;
            } finally {
                // Re-enable button only on manual login attempt failure
                if (!isAutoLogin && loadDataBtn) {
                     loadDataBtn.disabled = false;
                     loadDataBtn.textContent = 'Aceder Amostras';
                }
            }
        }

        // --- Event Listeners ---
        loadDataBtn.addEventListener('click', () => {
             loadDataBtn.disabled = true;
             loadDataBtn.textContent = 'A verificar...';
            const sessionId = document.getElementById('session-id-input').value.trim();
            const sellerName = document.getElementById('seller-name-input').value.trim();
            const accessCode = document.getElementById('access-code-input').value.trim();
            attemptLogin(sessionId, sellerName, accessCode);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('sellerSessionId');
            localStorage.removeItem('sellerName');
            localStorage.removeItem('sellerAccessCode');
            if (unsubscribe) unsubscribe();
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();
            window.location.reload(); // Reload to show login screen
        });

        // --- Event listeners for notification modals ---
        sellerNotificationBtn.addEventListener('click', showSellerNotifications);
        closeSellerNotificationsBtn.addEventListener('click', hideSellerNotifications);
        closeSellerNotificationsBtnBottom.addEventListener('click', hideSellerNotifications);
        // Seller Reply Modal Listeners
        cancelSellerReplyBtn.addEventListener('click', () => {
            sellerReplyModal.classList.add('hidden');
            showSellerNotifications(); // Re-open the notifications list
        });
        sendSellerReplyBtn.addEventListener('click', sendReplyToManager);

        // Feedback Modal Listeners
        feedbackOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('feedback-choice-btn')) {
                // Deselect others, select clicked
                feedbackOptionsContainer.querySelectorAll('.feedback-choice-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedFeedback = e.target.dataset.feedback;
                validateFeedbackForm();
            }
        });
        cancelFeedbackModalBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
        observationInput.addEventListener('input', validateFeedbackForm);
        saveFeedbackBtn.addEventListener('click', saveFeedback); // Changed function name


        // --- Realtime Data & Notification Listeners ---
        function startRealtimeListener() {
            if (unsubscribe) unsubscribe(); // Ensure previous listener is stopped
            if (!currentSellerDocRef) {
                 console.error("Seller document reference not set.");
                 // Handle error, maybe redirect to login
                 loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro.</h1><p class="mt-2">N√£o foi poss√≠vel carregar os dados. Tente fazer login novamente.</p>`;
                 return;
            }
            unsubscribe = onSnapshot(currentSellerDocRef, (doc) => {
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');

                const sellerData = doc.data();
                allSellerSamples = sellerData?.amostras || []; // Update local cache

                if (allSellerSamples.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    document.getElementById('pending-section').classList.add('hidden');
                    document.getElementById('completed-section').classList.add('hidden');
                } else {
                    noDataMessage.classList.add('hidden');
                    // Separate samples into pending (not finalized) and completed (finalized)
                    const pendingSamplesForDisplay = allSellerSamples.filter(s => !s.finalizedByVendor);
                    const completedSamples = allSellerSamples.filter(s => s.finalizedByVendor);

                    renderOrders(pendingSamplesForDisplay, 'pending');
                    renderOrders(completedSamples, 'completed');
                }
            }, (error) => {
                console.error("Erro no listener do Firebase:", error);
                loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro de conex√£o.</h1><p class="mt-2">Tente recarregar a p√°gina.</p>`;
                mainContent.classList.add('hidden'); // Hide main content on error
            });
        }

        // Listen for notifications specifically FOR this seller
        function listenForSellerNotifications() {
            if (!currentSessionId || !currentSellerOriginalName) {
                console.warn("Cannot listen for seller notifications: Session ID or Seller Name missing.");
                return;
            }
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();

            // Query using the ORIGINAL seller name (case-sensitive)
            const q = query(
                collection(db, "sessoes", currentSessionId, "notificacoesVendedor"),
                where("sellerName", "==", currentSellerOriginalName)
                // Removed orderBy - will sort client-side after fetching
            );

            sellerNotificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 const previousUnreadCount = sellerNotifications.filter(n => !n.read).length;

                 // Fetch and map data
                 sellerNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                 // Sort client-side by timestamp descending (newest first)
                 sellerNotifications.sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));

                 const currentUnreadCount = sellerNotifications.filter(n => !n.read).length;

                 updateSellerNotificationBadge(); // Update bell icon count

                 // Trigger browser notification only if new unread messages arrived from Firestore
                 if (currentUnreadCount > previousUnreadCount && !snapshot.metadata.hasPendingWrites) {
                     snapshot.docChanges().forEach((change) => {
                         // Check only for added documents that are not from local cache changes and are unread
                         if (change.type === "added" && !change.doc.metadata.fromCache) {
                             const newData = change.doc.data();
                             if (!newData.read) {
                                 showBrowserNotification(
                                     `Resposta de ${newData.managerName}`,
                                     `Ref. ${newData.produto} (${newData.pedido}): ${newData.replyMessage}`
                                 );
                             }
                         }
                     });
                 }
            }, (error) => {
                console.error("Erro ao escutar notifica√ß√µes do vendedor:", error);
                // Handle error gracefully
            });
        }

        // --- UI Rendering Functions ---

        // Render pending or completed orders list
        function renderOrders(samplesToDisplay, type) {
            const isPendingSection = type === 'pending';
            const container = document.getElementById(`${type}-orders-list`);
            const section = document.getElementById(`${type}-section`);

            if (!container || !section) return; // Basic safety check

            if (samplesToDisplay.length === 0) {
                section.classList.add('hidden');
                // Update pending count text even if the list is empty now
                if (isPendingSection) {
                     const countEl = document.getElementById('pending-orders-count');
                     if (countEl) countEl.textContent = `Nenhum Pedido Pendente`;
                 }
                return;
            }

            section.classList.remove('hidden');
            container.innerHTML = ''; // Clear previous content

            // Group samples by order ID (using the filtered samplesToDisplay)
            const groupedByOrder = samplesToDisplay.reduce((acc, sample) => {
                const key = sample.pedido;
                if (!acc[key]) acc[key] = { ...sample, samples: [] }; // Use first sample for order info
                acc[key].samples.push(sample);
                return acc;
            }, {});

            // Sort orders within the group (e.g., by Pedido number, numerically if possible)
             const sortedOrderKeys = Object.keys(groupedByOrder).sort((a, b) => {
                 const numA = parseInt(a, 10);
                 const numB = parseInt(b, 10);
                 if (!isNaN(numA) && !isNaN(numB)) {
                     return numA - numB; // Sort numerically
                 }
                 return a.localeCompare(b); // Fallback to string sort
             });

            if (isPendingSection) {
                const countEl = document.getElementById('pending-orders-count');
                 if (countEl) countEl.textContent = `${sortedOrderKeys.length} Pedido(s) ${sortedOrderKeys.length > 1 ? '' : ' '}com Pend√™ncias`;
            }

            // Create collapsible group for each order using sorted keys
             sortedOrderKeys.forEach(orderId => {
                 const order = groupedByOrder[orderId];
                const orderGroup = document.createElement('div');
                // Check if ALL samples within THIS specific order group are answered
                const allSamplesInThisOrderAnswered = order.samples.every(s => !s.isPending);
                // Determine border color based on section type and completion status *within this order*
                const statusColor = isPendingSection ? (allSamplesInThisOrderAnswered ? 'blue' : 'yellow') : 'green';
                orderGroup.className = `bg-white rounded-2xl shadow-sm border-l-4 border-${statusColor}-400 fade-in`;

                // Generate HTML for each sample row within the order
                const samplesTableRowsHTML = order.samples.map(sample => {
                    // Format quantity
                    const qty = parseFloat(String(sample.qtde || '0').replace(',', '.'));
                    let formattedQty = '';
                    if (!isNaN(qty)) {
                        formattedQty = qty >= 1 || qty === 0 ? `${qty.toFixed(3).replace('.', ',')}kg` : `${Math.round(qty * 1000)}g`;
                    } else {
                        formattedQty = sample.qtde || 'N/A';
                    }

                    // Display feedback/observation or "Pendente"
                    const feedbackDisplay = sample.isPending
                        ? '<span class="text-yellow-600 font-semibold">Pendente</span>'
                        : `<div>${sample.feedback || 'N/A'}</div><div class='text-gray-500 font-normal text-xs'>${sample.observation || ''}</div>`;

                    // Buttons
                    // *** MODIFICATION: Show Edit/Delete in both sections ***
                    const deleteButtonHtml = !sample.isPending // Show delete if not pending (in either section)
                        ? `<button class="delete-btn bg-red-100 text-red-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-red-200" data-sample-id='${sample.id}'>Excluir</button>`
                        : '';
                    const updateButtonText = sample.isPending ? 'Atualizar' : 'Editar';
                    // Show Update/Edit button in both sections
                    const updateButtonHtml = `<button class="update-btn bg-blue-100 text-blue-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-blue-200" data-sample-id='${sample.id}'>${updateButtonText}</button>`;


                    // Status dot and color logic
                    const dotColorClass = sample.isPending ? 'dot-yellow' : 'dot-green';

                    return `
                        <tr class="border-b last:border-b-0">
                            <td class="p-3">
                                <span class="status-dot ${dotColorClass}"></span>
                                <div class="inline-block align-middle">
                                    <p class="font-semibold">${sample.produto}</p>
                                    <p class="text-xs text-gray-500">${sample.descricao || ''}</p>
                                </div>
                            </td>
                            <td class="p-3">${formattedQty}</td>
                            <td class="p-3 hidden md:table-cell">${sample.originalStatus || 'N/A'}</td>
                            <td class="p-3">${feedbackDisplay}</td>
                            <td class="p-3 text-right space-x-2">
                                ${updateButtonHtml}
                                ${deleteButtonHtml}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Assemble the order group HTML
                orderGroup.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer order-header">
                        <div>
                            <h3 class="font-bold text-lg flex items-center"><span class="w-3 h-3 bg-${statusColor}-400 rounded-full mr-3"></span>${order.pedido} - ${order.razaoSocial || 'Cliente Desconhecido'}</h3>
                            <p class="text-sm text-gray-500 ml-6">Nota Fiscal: ${order.notaFiscal || 'N/A'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="overflow-x-auto samples-table hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>
                                    <th class="p-3 font-medium text-gray-500">Produto</th>
                                    <th class="p-3 font-medium text-gray-500">Qtde.</th>
                                    <th class="p-3 font-medium text-gray-500 hidden md:table-cell">Status Atual</th>
                                    <th class="p-3 font-medium text-gray-500">Feedback</th>
                                    <th class="p-3"></th> <!-- Actions column -->
                                </tr>
                            </thead>
                            <tbody>${samplesTableRowsHTML}</tbody>
                        </table>
                        ${isPendingSection && allSamplesInThisOrderAnswered ? `
                        <div class="p-4 border-t text-right bg-blue-50">
                            <p class="text-sm text-gray-700 text-left mb-2">Todas as amostras deste pedido foram respondidas. Clique abaixo para notificar o gestor.</p>
                            <button class="signal-manager-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700" data-order-id="${order.pedido}">Sinalizar Gestor</button>
                        </div>` : ''}
                        ${!isPendingSection ? `
                        <div class="p-3 border-t text-xs text-gray-500 bg-gray-50 text-center">
                             Este pedido j√° foi sinalizado para o gestor. Edite ou exclua um feedback se necess√°rio.
                        </div>` : ''} {/* Updated text for completed section */}
                    </div>
                `;

                container.appendChild(orderGroup);
            });

            // Add event listeners AFTER appending all groups
            container.querySelectorAll('.order-header').forEach(header => {
                header.addEventListener('click', () => {
                    const tableDiv = header.nextElementSibling;
                    const arrow = header.querySelector('svg');
                    tableDiv?.classList.toggle('hidden'); // Use optional chaining
                    arrow?.classList.toggle('rotate-180');
                });
            });

             // Add listeners only within the specific container (pending or completed)
             container.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Find in the main 'allSellerSamples' array
                    const sampleToUpdate = allSellerSamples.find(s => s.id === btn.dataset.sampleId);
                    if (sampleToUpdate) openFeedbackModal(sampleToUpdate);
                });
            });
             container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const sampleId = e.currentTarget.dataset.sampleId;
                    if (!confirm('Tem a certeza que quer excluir este feedback e voltar a amostra para pendente? O pedido voltar√° para a se√ß√£o de pend√™ncias.')) { // Updated confirmation
                        return;
                    }
                    e.currentTarget.disabled = true;
                    // *** MODIFICATION: Reset finalizedByVendor when deleting ***
                    await updateSampleData(sampleId, {
                        isPending: true,
                        feedback: '',
                        observation: '',
                        finalizedByVendor: false, // Move back to pending section
                        editedAfterCompletion: false,
                        lastUpdate: new Date()
                    });
                });
            });
              container.querySelectorAll('.signal-manager-btn').forEach(btn => {
                  btn.addEventListener('click', async (e) => {
                      const orderId = e.currentTarget.dataset.orderId;
                      e.currentTarget.disabled = true;
                      e.currentTarget.textContent = 'Sinalizado!';

                      // Update samples locally first for responsiveness
                      const updatedSamplesLocally = allSellerSamples.map(sample => {
                          if (sample.pedido === orderId && !sample.isPending) { // Only mark finalized if already answered
                              return { ...sample, finalizedByVendor: true };
                          }
                          return sample;
                      });
                      allSellerSamples = updatedSamplesLocally; // Update local cache

                      // Update Firestore
                      try {
                          await updateDoc(currentSellerDocRef, { amostras: updatedSamplesLocally });
                          console.log(`Pedido ${orderId} marcado como finalizado pelo vendedor.`);

                          // Send notification to manager
                          const sellerName = currentSellerOriginalName;
                          const message = `<strong>${sellerName}</strong> sinalizou o pedido: <strong>${orderId}</strong> como conclu√≠do.`;
                          const notifId = sanitizeForFirebaseId(`${sellerName}-${orderId}-concluido-${Date.now()}`);
                          const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                          await setDoc(notifRef, {
                              message,
                              color: 'purple',
                              timestamp: serverTimestamp(), // OK here
                              triggerPopup: false
                          });

                      } catch(error) {
                          console.error("Erro ao sinalizar gestor ou atualizar amostras:", error);
                          alert("Erro ao sinalizar. Tente novamente.");
                          e.currentTarget.disabled = false;
                          e.currentTarget.textContent = 'Sinalizar Gestor';
                          // Consider reverting local state on error
                      }
                       // Re-rendering happens via listener
                  });
              });
        }

        // --- Feedback Modal Functions ---
        function openFeedbackModal(sample) {
            currentSample = sample;
            selectedFeedback = sample.feedback || null; // Pre-select current feedback
            observationInput.value = sample.observation || '';
            modalSampleInfo.textContent = `${sample.produto} - ${sample.descricao || ''}`;
            modalTitle.textContent = sample.isPending ? 'Atualizar Feedback' : 'Editar Feedback'; // Adjust title

            feedbackOptionsContainer.innerHTML = ''; // Clear previous options
            // Create buttons for each feedback choice
            FEEDBACK_CHOICES.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.dataset.feedback = choice;
                button.className = 'feedback-choice-btn border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg hover:bg-gray-100 transition-all';
                // Highlight the pre-selected choice
                if (choice === selectedFeedback) button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                feedbackOptionsContainer.appendChild(button);
            });

            validateFeedbackForm(); // Check initial form validity
            feedbackModal.classList.remove('hidden'); // Show modal
        }

        // Enable/disable save button based on selection and observation
        function validateFeedbackForm() {
             // Observation is mandatory, feedback selection is mandatory
             saveFeedbackBtn.disabled = !observationInput.value.trim() || !selectedFeedback;
        }

        // Save feedback and observation to Firestore
        async function saveFeedback() { // Renamed from original save-button listener
            if (saveFeedbackBtn.disabled) return;

             // Determine if this is an edit of a previously completed feedback OR a new feedback on a finalized order
             const isEditing = !currentSample.isPending; // Check if it was already "not pending" before opening modal
             const oldFeedback = currentSample.feedback;
             const oldObservation = currentSample.observation;
             const newFeedback = selectedFeedback;
             const newObservation = observationInput.value.trim();
             // Mark as edited only if feedback or observation actually changed
             const wasEdited = isEditing && (oldFeedback !== newFeedback || oldObservation !== newObservation);
             // Also mark as edited if the sample was already finalized by the vendor
             const editedAfterFinalized = currentSample.finalizedByVendor && (oldFeedback !== newFeedback || oldObservation !== newObservation);

            const updates = {
                isPending: false, // Mark as no longer pending
                feedback: newFeedback,
                observation: newObservation,
                // Keep existing finalizedByVendor status unless deleting
                // editedAfterCompletion: wasEdited || editedAfterFinalized, // Mark if edited after initial completion OR after finalization
                editedAfterCompletion: editedAfterFinalized, // Only mark if edited *after* signaling manager
                lastUpdate: new Date() // *** CORRECTION: Use client-side timestamp ***
            };

            feedbackModal.classList.add('hidden'); // Close modal immediately
            await updateSampleData(currentSample.id, updates); // Update Firestore

            // Send notification to manager *only* if it was edited *after* being finalized/signaled
            if (editedAfterFinalized) {
                try {
                    const sellerName = currentSellerOriginalName;
                    const message = `<strong>${sellerName}</strong> <i>editou</i> o feedback (ap√≥s sinalizar) para <strong>${currentSample.produto}</strong> (Pedido ${currentSample.pedido}): ${newFeedback}`;
                    const notifId = sanitizeForFirebaseId(`edit-after-final-${currentSample.id}-${Date.now()}`);
                    const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);

                    await setDoc(notifRef, {
                        message,
                        color: 'red', // Use red for edits after finalization
                        timestamp: serverTimestamp(), // serverTimestamp is OK here
                        triggerPopup: true // Trigger browser popup for manager on these critical edits
                    });
                    console.log("Notifica√ß√£o de edi√ß√£o P√ìS-FINALIZA√á√ÉO enviada.");
                } catch (notifError) {
                    console.error("Erro ao enviar notifica√ß√£o de edi√ß√£o P√ìS-FINALIZA√á√ÉO:", notifError);
                    // Log error but don't block user
                }
            }
        }

        // --- Generic Update Function (Handles Firestore update and local cache) ---
        async function updateSampleData(sampleId, updates) {
            try {
                const sampleIndex = allSellerSamples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1) {
                    throw new Error("Sample not found in local cache for update.");
                }
                // Create a new array with the updated sample
                const updatedSamples = [...allSellerSamples];
                // *** Ensure lastUpdate is a Firestore Timestamp if using new Date() ***
                const updatesWithTimestamp = {
                     ...updates,
                     // Convert client-side Date to Firestore Timestamp before saving
                     lastUpdate: updates.lastUpdate instanceof Date ? Timestamp.fromDate(updates.lastUpdate) : updates.lastUpdate
                 };
                updatedSamples[sampleIndex] = { ...updatedSamples[sampleIndex], ...updatesWithTimestamp };

                // Update Firestore with the entire array
                await updateDoc(currentSellerDocRef, { amostras: updatedSamples });

                // Update local state *after* successful Firestore update
                // The listener will eventually update this, but doing it here provides quicker UI feedback if needed
                // allSellerSamples = updatedSamples; // Optional: Update local state immediately

                console.log(`Sample ${sampleId} updated successfully.`);
                 // UI update will be handled by the onSnapshot listener

            } catch (error) {
                console.error("Falha ao atualizar a amostra:", error); // Log detailed error
                // Show user-friendly alert
                alert(`N√£o foi poss√≠vel guardar a altera√ß√£o. A sua tela pode estar dessincronizada. Tente recarregar a p√°gina.\n\nDetalhe do erro: ${error.message}`);
                // Re-enable delete button if the failed update was a delete attempt
                 const deleteButton = document.querySelector(`.delete-btn[data-sample-id='${sampleId}']`);
                 if(deleteButton) deleteButton.disabled = false;
            }
        }


        // --- Seller Notification Functions (Integrated) ---

        // Update the notification badge count and prompt visibility
        function updateSellerNotificationBadge() {
             if(!sellerNotificationCount || !notificationPrompt) return; // Safety check
            const unreadCount = sellerNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                sellerNotificationCount.textContent = unreadCount;
                sellerNotificationCount.classList.remove('hidden');
                notificationPrompt.classList.remove('hidden'); // Show "Verificar" prompt
            } else {
                sellerNotificationCount.classList.add('hidden');
                notificationPrompt.classList.add('hidden'); // Hide prompt
            }
        }

        // Show the modal with notifications for the seller
        function showSellerNotifications() {
            sellerNotificationsList.innerHTML = ''; // Clear previous list
            if (sellerNotifications.length === 0) {
                 sellerNotificationsList.innerHTML = '<p class="text-gray-500">Nenhuma resposta recebida.</p>';
            } else {
                 // Sort again just in case (though listener should keep it sorted)
                 sellerNotifications.sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));

                 sellerNotifications.forEach(notif => {
                     const itemDiv = document.createElement('div');

                     // Check if this notification has a reply from the seller stored within it
                     const hasSellerReply = notif.sellerReplyMessage && notif.sellerReplyMessage.trim() !== '';

                     // Generate Reply button HTML (changes text if already replied)
                     const replyButtonHtml = `<button class="seller-reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">
                                                  ${hasSellerReply ? 'Ver/Responder' : 'Responder'}
                                             </button>`;
                    // Generate Mark as Read button HTML (or "Lida" span if already read)
                     const readButtonHtml = !notif.read
                         ? `<button class="mark-as-read-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">‚úì Marcar como Lida</button>`
                         : `<span class="text-green-500 text-xs font-semibold ml-2">‚úì Lida</span>`;

                     // Apply styling for unread items
                     itemDiv.className = `seller-notification-item text-sm ${!notif.read ? 'font-semibold bg-blue-50 p-2 rounded' : 'text-gray-600 p-2'}`;
                     itemDiv.innerHTML = `
                         <p class="mb-1">
                             <span class="font-bold">${notif.managerName}</span> respondeu sobre
                             <strong>${notif.produto}</strong> (Pedido: ${notif.pedido}):
                         </p>
                         <div class="manager-reply">${notif.replyMessage}</div>

                         ${hasSellerReply ? `
                         <div class="seller-reply">
                              <p><strong>Voc√™ respondeu:</strong> ${notif.sellerReplyMessage}</p>
                         </div>` : ''}

                         ${notif.originalObservation ? `<blockquote>Observa√ß√£o Original: "${notif.originalObservation}"</blockquote>` : ''}

                         <div class="flex justify-between items-center mt-2">
                              <p class="text-xs text-gray-400">${notif.timestamp?.toDate() ? notif.timestamp.toDate().toLocaleString('pt-BR') : 'Data indispon√≠vel'}</p> {/* Added null check */}
                              <div class="flex gap-2">
                                   ${replyButtonHtml}
                                   ${readButtonHtml}
                              </div>
                         </div>
                     `;
                     sellerNotificationsList.appendChild(itemDiv);
                 });

                 // Add event listeners for buttons inside the modal list
                 sellerNotificationsList.querySelectorAll('.mark-as-read-btn').forEach(btn => {
                     btn.addEventListener('click', markNotificationAsRead);
                 });
                 sellerNotificationsList.querySelectorAll('.seller-reply-btn').forEach(btn => {
                     btn.addEventListener('click', openSellerReplyModal);
                 });
            }
            sellerNotificationsModal.classList.remove('hidden'); // Show modal
             notificationPrompt.classList.add('hidden'); // Hide prompt once modal is opened
        }

        // Hide the seller notification modal
        function hideSellerNotifications() {
            sellerNotificationsModal.classList.add('hidden');
        }

        // Mark a specific notification as read in Firestore
        async function markNotificationAsRead(e) {
            const notifId = e.target.dataset.notifId;
            e.target.disabled = true;
            e.target.textContent = 'A marcar...';
            const notifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", notifId);
            try {
                await updateDoc(notifRef, { read: true });
                // Listener will update UI, but manually update local state and re-render modal for instant feedback
                 const notifIndex = sellerNotifications.findIndex(n => n.id === notifId);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                 }
                 showSellerNotifications(); // Re-render modal list
                 updateSellerNotificationBadge(); // Update badge count
            } catch (err) {
                console.error("Erro ao marcar como lida:", err);
                // Re-enable button on error
                e.target.disabled = false;
                e.target.textContent = '‚úì Marcar como Lida';
            }
        }

        // Open the modal for the seller to reply to the manager
        function openSellerReplyModal(e) {
            const notifId = e.target.dataset.notifId;
            const notification = sellerNotifications.find(n => n.id === notifId);
            if (!notification) return;

            currentNotificationForReply = notification; // Store context

            // Populate the reply modal
            sellerReplyContext.textContent = `Em resposta a ${notification.managerName} (Ref. ${notification.produto}):`;
            sellerReplyOriginalMsg.textContent = `"${notification.replyMessage}"`;
            sellerReplyMessageInput.value = notification.sellerReplyMessage || ''; // Pre-fill if editing previous reply

            sellerNotificationsModal.classList.add('hidden'); // Hide the notification list
            sellerReplyModal.classList.remove('hidden'); // Show the reply modal
        }

        // Send the seller's reply TO THE MANAGER
        async function sendReplyToManager() {
            if (!currentNotificationForReply || !currentSessionId || !currentSellerOriginalName) return;

            const replyMessage = sellerReplyMessageInput.value.trim();
            if (!replyMessage) {
                alert("Por favor, escreva a sua resposta."); // Simple alert for now
                return;
            }

            sendSellerReplyBtn.disabled = true;
            sendSellerReplyBtn.textContent = 'A Enviar...';

            try {
                // 1. Data for the "respostasVendedor" collection (for manager to listen to)
                const replyDataForManager = {
                    sellerName: currentSellerOriginalName,
                    replyMessage: replyMessage,
                    originalManagerMessage: currentNotificationForReply.replyMessage,
                    originalManagerName: currentNotificationForReply.managerName,
                    pedido: currentNotificationForReply.pedido,
                    produto: currentNotificationForReply.produto,
                    timestamp: serverTimestamp(), // OK here
                    readByManager: false // Manager hasn't read this yet
                };
                const managerRepliesRef = collection(db, "sessoes", currentSessionId, "respostasVendedor");
                await addDoc(managerRepliesRef, replyDataForManager);

                // 2. Update the original notification ("notificacoesVendedor") to include the seller's reply and mark as read
                const originalNotifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", currentNotificationForReply.id);
                await updateDoc(originalNotifRef, {
                    sellerReplyMessage: replyMessage, // Add seller's reply content
                    read: true // Mark original notification as read (since seller replied)
                });

                 // Update local state immediately for UI refresh
                 const notifIndex = sellerNotifications.findIndex(n => n.id === currentNotificationForReply.id);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                      sellerNotifications[notifIndex].sellerReplyMessage = replyMessage;
                 }
                 updateSellerNotificationBadge(); // Update badge count

                 sellerReplyModal.classList.add('hidden'); // Close reply modal
                 showSellerNotifications(); // Re-open the notification list to show the updated thread

            } catch (error) {
                console.error("Erro ao enviar resposta ao gestor:", error);
                alert("Ocorreu um erro ao enviar a resposta. Tente novamente.");
            } finally {
                sendSellerReplyBtn.disabled = false;
                sendSellerReplyBtn.textContent = 'Enviar Resposta';
                currentNotificationForReply = null; // Clear context
            }
        }


        // --- Browser Notification Functions ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("Este navegador n√£o suporta notifica√ß√µes desktop");
                return;
            }
            // Request permission only if not already denied
            if (Notification.permission !== 'denied') {
                 Notification.requestPermission().then(permission => {
                     console.log("Permiss√£o de notifica√ß√£o:", permission);
                     // Optionally update UI based on new permission state
                 });
            }
        }

        function showBrowserNotification(title, body) {
            if (Notification.permission === 'granted') {
                 if (document.visibilityState === 'visible') { // Don't show if tab is active
                      console.log("Tab is active, skipping browser notification.");
                      return;
                 }
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/fluency/96/send-letter.png' // Example icon
                });
            }
        }


        // --- Initial Load Logic ---
        async function checkLocalStorage() {
            const savedSessionId = localStorage.getItem('sellerSessionId');
            const savedSellerName = localStorage.getItem('sellerName');
            const savedAccessCode = localStorage.getItem('sellerAccessCode');

            if (savedSessionId && savedSellerName && savedAccessCode) {
                 loadingMessage.textContent = 'A verificar sess√£o guardada...';
                 accessView.classList.add('hidden');
                 loadingState.classList.remove('hidden');
                 const loginSuccess = await attemptLogin(savedSessionId, savedSellerName, savedAccessCode, true); // Try auto-login
                 if (!loginSuccess) {
                     console.log("Auto-login falhou. A mostrar ecr√£ de login.");
                     // attemptLogin handles showing login view on auto-login failure
                 }
            } else {
                 // No saved credentials, show login view
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
            }
        }

        // --- Initial Anonymous Sign-in and Local Storage Check ---
        (async () => {
             try {
                 await signInAnonymously(auth); // Ensure user is signed in
                 await checkLocalStorage(); // Check for saved session
             } catch (error) {
                 console.error("Firebase Auth Error:", error);
                 accessError.textContent = "N√£o foi poss√≠vel conectar ao servi√ßo.";
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
             }
        })();

    </script>
</body>
</html>












