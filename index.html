<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de P&D (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .manager-reply, .seller-reply, .pd-note {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .manager-reply {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 3px solid #9ca3af; /* border-gray-400 */
        }
        .seller-reply {
            background-color: #f0f9ff; /* bg-blue-50 */
            border-left: 3px solid #60a5fa; /* border-blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
        .pd-note {
             background-color: #fffbeb; /* bg-amber-50 */
             border-left: 3px solid #fcd34d; /* border-amber-300 */
        }
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }
        .post-it-card {
            background-color: #fffbeb; /* bg-amber-50 */
            border: 1px solid #fde68a; /* border-amber-200 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Painel P&D (v2)</h1>
            <p class="text-gray-600 text-center mb-8">Selecione o seu nome para aceder ao painel.</p>
            
            <div id="pd-login-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Botões de login P&D serão inseridos aqui pelo JS -->
            </div>
            
            <div class="mt-8">
                <input type="password" id="pd-password-input" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a sua senha...">
                <button id="pd-login-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Tela Principal (Dashboard) -->
    <div id="dashboard" class="hidden container mx-auto p-4 md:p-8">
        
        <header class="flex justify-between items-center mb-8">
            <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Painel P&D</h1>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button id="notification-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-count-badge" class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                    </button>
                </div>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg text-sm hover:bg-red-600">Sair</button>
            </div>
        </header>

        <!-- Estado de Carregamento (NOVO) -->
        <div id="loading-state" class="hidden text-center p-12">
            <h2 class="text-2xl font-semibold text-gray-700">A carregar dados...</h2>
            <p id="loading-message" class="text-gray-500 mt-2">A processar amostras. Isto pode demorar um momento...</p>
        </div>

        <!-- Conteúdo do Dashboard (NOVO) -->
        <div id="dashboard-content" class="hidden">
        
            <!-- Gráficos -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Status Geral das Amostras</h3>
                    <div style="height: 250px;"><canvas id="segment-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Distribuição de Feedbacks</h3>
                    <div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div>
                </div>
            </section>

            <!-- Feeds Lado a Lado -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                <!-- Coluna Post-its -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Post-its (Notas Internas P&D)</h2>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border mb-4">
                        <textarea id="post-it-input" class="w-full border-gray-300 rounded-lg shadow-sm text-sm" rows="3" placeholder="Escreva uma nota interna rápida... (Ex: Ligar para Felipe sobre amostra X)"></textarea>
                        <button id="add-post-it-btn" class="mt-2 w-full bg-amber-500 text-white font-bold py-2 rounded-lg hover:bg-amber-600">Adicionar Post-it</button>
                    </div>
                    <div id="post-it-list" class="space-y-3 h-[28rem] overflow-y-auto bg-gray-50 p-4 rounded-2xl shadow-inner no-scrollbar">
                        <p class="text-gray-500 placeholder-postit">Nenhum post-it adicionado.</p>
                    </div>
                </section>
                
                <!-- Coluna Feed Observações -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Feed de Observações (Vendedores)</h2>
                    <div class="mb-4">
                        <input id="observation-search-input" type="text" placeholder="Pesquisar por vendedor, cliente, produto..." class="border-gray-300 rounded-lg shadow-sm text-sm w-full">
                    </div>
                    <div id="observations-feed-list" class="space-y-4 h-[35rem] overflow-y-auto bg-white p-4 rounded-2xl shadow-sm border no-scrollbar">
                        <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>
                    </div>
                </section>
            </section>
        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal de Amostras por Feedback -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras com Feedback:</h3>
                <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="feedback-samples-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">A carregar detalhes...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta à Observação -->
    <div id="reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Responder à Observação</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="reply-modal-product"></p>
                <p class="text-xs text-gray-600 mb-1" id="reply-modal-seller"></p>
                <p class="italic" id="reply-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                <div>
                  <label for="reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta (P&D)</label>
                  <textarea id="reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="send-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Adicionar Post-it (Contextual) -->
    <div id="context-post-it-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Adicionar Nota P&D</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="post-it-modal-context"></p>
                <p class="text-xs text-gray-600 mb-1" id="post-it-modal-details"></p>
            </div>
            <div class="space-y-4">
                <div>
                  <label for="post-it-modal-message" class="block text-sm font-medium text-gray-700">Nota Interna</label>
                  <textarea id="post-it-modal-message" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua nota interna..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-post-it-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="send-post-it-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Guardar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações (Respostas dos Gestores/Vendedores) -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Notificações</h3>
                <button id="close-notification-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="notification-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">Nenhuma resposta recebida.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where,
            deleteDoc, collectionGroup, runTransaction
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definições de Acesso P&D
        const PD_PASSWORDS = {
            'Panificação (Adriana)': 'pd_adriana5',
            'Cárneos (Anderson)': 'pd_anderson3',
            'Aromas/Molhos (Carlos)': 'pd_carlos1',
            'Nutracêuticos (Daise)': 'pd_daise4',
            'Lácteos (Flavia)': 'pd_flavia2',
            'Sorvetes (Margarida)': 'pd_margarida7',
            'Nutrição Animal (Rebeca)': 'pd_rebeca6',
            'ADMIN': 'admin123'
        };
        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // --- Elementos DOM ---
        const loginView = document.getElementById('login-view');
        const pdLoginButtons = document.getElementById('pd-login-buttons');
        const pdPasswordInput = document.getElementById('pd-password-input');
        const pdLoginBtn = document.getElementById('pd-login-btn');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const dashboardContent = document.getElementById('dashboard-content');
        const postItInput = document.getElementById('post-it-input');
        const addPostItBtn = document.getElementById('add-post-it-btn');
        const postItList = document.getElementById('post-it-list');
        const observationsFeedList = document.getElementById('observations-feed-list');
        const observationSearchInput = document.getElementById('observation-search-input');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        const replyModal = document.getElementById('reply-modal');
        const replyModalProduct = document.getElementById('reply-modal-product');
        const replyModalSeller = document.getElementById('reply-modal-seller');
        const replyModalObservation = document.getElementById('reply-modal-observation');
        const replyMessageInput = document.getElementById('reply-message-input');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const sendReplyBtn = document.getElementById('send-reply-btn');
        const contextPostItModal = document.getElementById('context-post-it-modal');
        const postItModalContext = document.getElementById('post-it-modal-context');
        const postItModalDetails = document.getElementById('post-it-modal-details');
        const postItModalMessage = document.getElementById('post-it-modal-message');
        const cancelPostItBtn = document.getElementById('cancel-post-it-btn');
        const sendPostItBtn = document.getElementById('send-post-it-btn');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationCountBadge = document.getElementById('notification-count-badge');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Estado Global ---
        let currentSessionId = null;
        let currentPdManagerName = null;
        let allCurrentSamples = [];
        let sellerSegmentsCache = {}; // Cache de segmentos
        let sellerRepliesListenerUnsubscribe = null;
        let pdPostitsListenerUnsubscribe = null;
        let destaquesListenerUnsubscribe = null;
        let dataListenersUnsubscribe = [];
        let chartInstances = {};
        let currentSampleForReply = null;
        let currentSampleForPostIt = null;
        let allPdPostits = [];
        let highlightedSamplesCache = [];
        
        // Classe para gerir carregamento de dados (evita "piscar")
        class DataLoadManager {
            constructor(totalItems, onComplete) {
                this.totalItems = totalItems;
                this.loadedItems = 0;
                this.allData = [];
                this.onComplete = onComplete;
                this.hasCompleted = false;
            }

            itemLoaded(data) {
                this.loadedItems++;
                this.allData = this.allData.concat(data);
                
                const progress = this.totalItems > 0 ? (this.loadedItems / this.totalItems) * 100 : 100;
                loadingMessage.textContent = `A processar... (${this.loadedItems}/${this.totalItems} vendedores carregados)`;

                if (this.loadedItems === this.totalItems && !this.hasCompleted) {
                    this.hasCompleted = true;
                    this.onComplete(this.allData);
                }
            }
        }

        // --- Funções Utilitárias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança do Firebase.";
            }
            showAlert(message, title, color);
        }
        
        // --- Lógica de Carregamento de Dados (v2) ---
        
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }

        async function loadSellerSegments() {
            sellerSegmentsCache = {};
            try {
                const segmentsSnap = await getDocs(collection(db, "vendedorConfig"));
                segmentsSnap.forEach(doc => {
                    sellerSegmentsCache[doc.id] = doc.data().segmento;
                });
                console.log("Cache de segmentos carregado.");
            } catch (error) {
                handleFirestoreError(error, "carregar segmentos de vendedores");
            }
        }
        
        // Carrega TODOS os dados da sessão (v2)
        async function loadAllData(sessionId) {
            dashboard.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginView.classList.add('hidden');
            
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            currentSessionId = sessionId;
            allCurrentSamples = [];

            // 1. Carrega os segmentos
            await loadSellerSegments();

            // 2. Busca todos os vendedores da sessão (P&D vê todos)
            const sellersQuery = query(collection(db, "sessoes", sessionId, "vendedores"));
            const sellersSnapshot = await getDocs(sellersQuery);
            const sellerDocs = sellersSnapshot.docs;
            
            if (sellerDocs.length === 0) {
                 console.log("Nenhum vendedor encontrado para esta sessão.");
                 loadingState.classList.add('hidden');
                 dashboardContent.classList.remove('hidden');
                 processAndDisplayDashboard([]);
                 // Inicia outros listeners mesmo sem vendedores
                 listenForPdPostits(sessionId);
                 listenForSellerReplies(sessionId);
                 listenForDestaques(sessionId);
                 return;
            }

            // 3. Usa o DataLoadManager para carregar as sub-coleções
            const loadManager = new DataLoadManager(sellerDocs.length, (allSamples) => {
                allCurrentSamples = allSamples;
                processAndDisplayDashboard(allCurrentSamples);
                loadingState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            });
            
            loadingMessage.textContent = `A preparar para carregar ${sellerDocs.length} vendedores...`;

            // 4. Ouve as 'amostras' de cada vendedor
            sellerDocs.forEach(sellerDoc => {
                const sellerData = sellerDoc.data();
                const samplesQuery = query(
                    collection(db, sellerDoc.ref.path, "amostras")
                );

                const unsub = onSnapshot(samplesQuery, (samplesSnapshot) => {
                    const samples = samplesSnapshot.docs.map(sampleDoc => ({
                        ...sampleDoc.data(),
                        id: sampleDoc.id,
                        sellerName: sellerData.originalName
                    }));
                    loadManager.itemLoaded(samples);
                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras de ${sellerData.originalName}`);
                    loadManager.itemLoaded([]);
                });
                dataListenersUnsubscribe.push(unsub);
            });
            
            // 5. Ouve os outros listeners
            listenForPdPostits(sessionId);
            listenForSellerReplies(sessionId);
            listenForDestaques(sessionId);
        }


        // --- Lógica de Login P&D ---
        function populatePdButtons() {
            pdLoginButtons.innerHTML = '';
            Object.keys(PD_PASSWORDS).forEach(name => {
                const button = document.createElement('button');
                button.className = "p-4 bg-gray-100 rounded-lg font-semibold text-gray-700 hover:bg-blue-100 border border-transparent hover:border-blue-300 transition";
                button.textContent = name;
                button.dataset.name = name;
                button.addEventListener('click', () => {
                    pdLoginButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
                    button.classList.add('bg-blue-600', 'text-white');
                    currentPdManagerName = name;
                });
                pdLoginButtons.appendChild(button);
            });
        }

        async function login() {
            const password = pdPasswordInput.value;
            if (!currentPdManagerName) {
                loginError.textContent = 'Por favor, selecione o seu nome.';
                return;
            }
            
            if (PD_PASSWORDS[currentPdManagerName] === password) {
                loginError.textContent = '';
                pdLoginBtn.disabled = true;
                pdLoginBtn.textContent = 'A carregar...';

                localStorage.setItem('pdManagerName', currentPdManagerName);
                
                const sessionId = await getActiveSessionId();
                if (!sessionId) {
                    loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                    pdLoginBtn.disabled = false;
                    pdLoginBtn.textContent = 'Entrar';
                    return;
                }
                
                dashboardTitle.textContent = `Painel P&D: ${currentPdManagerName}`;
                await loadAllData(sessionId);

            } else {
                loginError.textContent = 'Senha incorreta.';
            }
        }
        
        function logout() {
            localStorage.removeItem('pdManagerName');
            currentSessionId = null;
            currentPdManagerName = null;
            allCurrentSamples = [];
            allPdPostits = [];
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            if(sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            if(pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            if(destaquesListenerUnsubscribe) destaquesListenerUnsubscribe();
            
            dashboard.classList.add('hidden');
            loginView.classList.remove('hidden');
            pdPasswordInput.value = '';
            pdLoginBtn.disabled = false;
            pdLoginBtn.textContent = 'Entrar';
            pdLoginButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
        }

        // --- Processamento e Renderização do Dashboard ---
        function processAndDisplayDashboard(samples) {
            renderCharts(samples);
            renderObservationsFeed(samples);
            // Post-its e Notificações são renderizados pelos seus próprios listeners
        }

        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';

            samples.forEach(s => {
                if (s.isPending) {
                    pending++;
                } else {
                    resolved++;
                    const feedback = s.feedback || '';
                    if (feedback) {
                        if (feedback.startsWith(APPROVED_PREFIX)) approved++;
                        else if (feedback.startsWith(REJECTED_PREFIX)) rejected++;
                        else if (feedback.startsWith(EVENTS_PREFIX)) events++;
                    }
                }
            });

            renderChart('segment-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            } else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            Chart.register(ChartDataLabels);
            chartInstances[canvasId] = new Chart(ctx, { 
                type, 
                data, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut' },
                        datalabels: { display: false },
                        ...options.plugins
                    },
                    ...options
                }
            });
        }
        
        function renderObservationsFeed(samples) {
            const searchTerm = normalizeText(observationSearchInput.value);
            
            const filteredSamples = samples.filter(s => 
                s.observation && (
                    !searchTerm ||
                    normalizeText(s.sellerName).includes(searchTerm) ||
                    normalizeText(s.produto).includes(searchTerm) ||
                    normalizeText(s.descricao).includes(searchTerm) ||
                    normalizeText(s.razaoSocial).includes(searchTerm) ||
                    normalizeText(s.observation).includes(searchTerm)
                )
            ).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
            
            observationsFeedList.innerHTML = '';
            if (filteredSamples.length === 0) {
                 observationsFeedList.innerHTML = '<p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>';
                 return;
            }
            
            filteredSamples.forEach(sample => {
                 const card = document.createElement('div');
                 card.className = "p-4 rounded-lg border bg-white";
                 const time = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR') : 'data inválida';
                 const isHighlighted = highlightedSamplesCache.includes(sample.id);
                 
                 const starIcon = isHighlighted ?
                    `<svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588 1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>` :
                    `<svg class="w-5 h-5 text-gray-400 hover:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.524 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.524 4.674c.3.921-.755 1.688-1.54 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.524-4.674a1 1 0 00-.363-1.118L2.98 10.1c-.783-.57-.38-1.81.588 1.81h4.914a1 1 0 00.951-.69l1.524-4.674z"></path></svg>`;
                 
                 card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-bold text-gray-800">${sample.produto}</p>
                            <p class="text-xs text-gray-500">${sample.razaoSocial || 'Cliente N/A'} (Pedido: ${sample.pedido})</p>
                        </div>
                        <button class="highlight-sample-btn p-1 rounded-full hover:bg-gray-200" data-sample-id="${sample.id}" title="Destacar Amostra">
                            ${starIcon}
                        </button>
                    </div>
                    <p class="text-gray-700 mb-3">"${sample.observation}"</p>
                    <div class="flex justify-between items-end text-xs text-gray-500 mt-3">
                         <div>
                             <p>- ${sample.sellerName}</p>
                             <p class="text-gray-400">${time}</p>
                         </div>
                         <div class="flex gap-2">
                             <button class="add-context-post-it-btn bg-amber-100 text-amber-700 hover:bg-amber-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                Adicionar Nota
                             </button>
                             <button class="reply-observation-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                Responder
                             </button>
                         </div>
                    </div>
                 `;
                 observationsFeedList.appendChild(card);
            });
            
            // Adiciona listeners
            observationsFeedList.querySelectorAll('.reply-observation-btn').forEach(btn => {
                 btn.addEventListener('click', openReplyModal);
            });
            observationsFeedList.querySelectorAll('.add-context-post-it-btn').forEach(btn => {
                 btn.addEventListener('click', openPostItModal);
            });
            observationsFeedList.querySelectorAll('.highlight-sample-btn').forEach(btn => {
                 btn.addEventListener('click', toggleDestaqueAmostra);
            });
        }

        // --- Lógica de Resposta e Notificação ---
        
        function openReplyModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForReply = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForReply) {
                 showAlert("Erro: Amostra não encontrada.");
                 return;
             }
             
             replyModalProduct.textContent = `${currentSampleForReply.produto} (${currentSampleForReply.pedido})`;
             replyModalSeller.textContent = `Observação de: ${currentSampleForReply.sellerName}`;
             replyModalObservation.textContent = `"${currentSampleForReply.observation}"`;
             replyMessageInput.value = '';
             replyModal.classList.remove('hidden');
        }

        async function sendReplyToSeller() {
            if (!currentSampleForReply || !currentSessionId) return;
            
            const replyMessage = replyMessageInput.value.trim();
            if (!replyMessage || !currentPdManagerName) {
                showAlert("A mensagem de resposta não pode estar vazia.");
                return;
            }

            sendReplyBtn.disabled = true;
            sendReplyBtn.textContent = 'A Enviar...';

            try {
                // ATUALIZAÇÃO v2: Envia todos os dados para o modal do vendedor
                const notificationData = {
                    managerName: currentPdManagerName, // Nome do P&D
                    replyMessage: replyMessage,
                    originalObservation: currentSampleForReply.observation,
                    sellerName: currentSampleForReply.sellerName,
                    pedido: currentSampleForReply.pedido,
                    produto: currentSampleForReply.produto,
                    razaoSocial: currentSampleForReply.razaoSocial || '', // NOVO
                    descricao: currentSampleForReply.descricao || '', // NOVO
                    timestamp: serverTimestamp(),
                    read: false,
                };

                const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
                await addDoc(sellerNotifsRef, notificationData);

                replyModal.classList.add('hidden');
                showAlert("Resposta enviada com sucesso.", "Sucesso", "text-green-600");
                
            } catch (error) {
                handleFirestoreError(error, "enviar resposta ao vendedor");
            } finally {
                sendReplyBtn.disabled = false;
                sendReplyBtn.textContent = 'Enviar Resposta';
                currentSampleForReply = null;
            }
        }
        
        // Ouve respostas dos vendedores (para o sino)
        function listenForSellerReplies(sessionId) {
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            
            // P&D ouve TODAS as respostas (incluindo as para P&D)
            const q = query(
                 collection(db, "sessoes", sessionId, "respostasVendedor"),
                 where("readByManager", "==", false) // v1: readByManager | v2: readByPd?
                 // Vamos assumir que P&D vê tudo que não foi lido pelo Gestor
            );

            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const replies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotificationBell(replies);
            }, (error) => {
                handleFirestoreError(error, "ouvir respostas dos vendedores");
            });
        }
        
        function renderNotificationBell(replies) {
             const unreadCount = replies.length;
             if (unreadCount > 0) {
                 notificationCountBadge.textContent = unreadCount;
                 notificationCountBadge.classList.remove('hidden');
             } else {
                 notificationCountBadge.classList.add('hidden');
             }
             // Recarrega o modal se estiver aberto
             if (!notificationModal.classList.contains('hidden')) {
                 openNotificationModal(replies);
             }
        }
        
        function openNotificationModal(replies) {
             notificationList.innerHTML = '';
             // Se 'replies' não for passado, busca do listener
             if (!replies) {
                 // Esta lógica precisa ser repensada, pois o listener é que deve
                 // ter os dados. Vamos assumir que o listener já populou
                 // uma variável global se for necessário, mas é melhor passar 'replies'.
                 notificationList.innerHTML = '<p class="text-gray-500">A carregar respostas...</p>';
                 return;
             }
             
             if (replies.length === 0) {
                 notificationList.innerHTML = '<p class="text-gray-500">Nenhuma resposta nova dos vendedores.</p>';
             } else {
                 replies.sort((a,b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));
                 
                 replies.forEach(reply => {
                     const item = document.createElement('div');
                     const isPdReply = reply.originalManagerName === currentPdManagerName; // Resposta a este P&D
                     item.className = `p-3 border-b border-gray-100 ${isPdReply ? 'bg-blue-50' : ''}`;
                     item.innerHTML = `
                        <p class="font-semibold">${reply.sellerName} respondeu (para ${reply.originalManagerName || 'Gestor'}):</p>
                        <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                        <p class="text-xs text-gray-500">Ref: ${reply.produto} (Pedido: ${reply.pedido})</p>
                        <div class="text-right mt-2">
                            <button class="mark-as-read-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded hover:bg-gray-300" data-reply-id="${reply.id}">Marcar como Lida</e_button>
                        </div>
                     `;
                     notificationList.appendChild(item);
                 });
             }
             notificationModal.classList.remove('hidden');
        }
        
        async function markReplyAsRead(e) {
             const button = e.target;
             const replyId = button.dataset.replyId;
             button.disabled = true;
             button.textContent = 'A marcar...';
             
             try {
                 const replyRef = doc(db, "sessoes", currentSessionId, "respostasVendedor", replyId);
                 await updateDoc(replyRef, { readByManager: true });
                 // O listener vai atualizar
                 notificationModal.classList.add('hidden');
             } catch (error) {
                 handleFirestoreError(error, "marcar resposta como lida");
                 button.disabled = false;
                 button.textContent = 'Marcar como Lida';
             }
        }
        
        // --- Lógica de Post-its (P&D) ---
        
        function listenForPdPostits(sessionId) {
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            
            const q = query(
                collection(db, "sessoes", sessionId, "pdPostits"),
                orderBy("timestamp", "desc")
            );
            
            pdPostitsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allPdPostits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderPostIts();
            }, (error) => {
                 handleFirestoreError(error, "ouvir post-its de P&D");
            });
        }
        
        function renderPostIts() {
             postItList.innerHTML = '';
             if (allPdPostits.length === 0) {
                 postItList.innerHTML = '<p class="text-gray-500 placeholder-postit">Nenhum post-it adicionado.</p>';
                 return;
             }
             
             allPdPostits.forEach(note => {
                 const card = document.createElement('div');
                 card.className = "post-it-card flex flex-col justify-between";
                 const time = note.timestamp?.toDate() ? note.timestamp.toDate().toLocaleString('pt-BR') : '';
                 
                 card.innerHTML = `
                    <div>
                        <p class="text-sm text-gray-800">${note.message}</p>
                        ${note.context ? `<p class="mt-2 pt-2 border-t border-amber-200 text-xs text-gray-600 font-medium">${note.context}</p>` : ''}
                        ${note.pedido ? `<p class="text-xs text-gray-500">Pedido: ${note.pedido} ${note.dataFaturamento ? `(NF: ${note.dataFaturamento})` : ''}</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <span class="font-semibold text-purple-700">${note.pdManagerName}</span>
                        <div class="flex items-center gap-2">
                           <span class="text-gray-400">${time}</span>
                           <button class="delete-post-it-btn text-gray-400 hover:text-red-500" data-note-id="${note.id}" title="Excluir nota">&times;</button>
                        </div>
                    </div>
                 `;
                 postItList.appendChild(card);
             });
        }
        
        function openPostItModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForPostIt = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForPostIt) {
                 showAlert("Erro: Amostra não encontrada.");
                 return;
             }
             
             postItModalContext.textContent = `${currentSampleForPostIt.produto} (${currentSampleForPostIt.sellerName})`;
             postItModalDetails.textContent = `Pedido: ${currentSampleForPostIt.pedido} | Cliente: ${currentSampleForPostIt.razaoSocial}`;
             postItModalMessage.value = '';
             contextPostItModal.classList.remove('hidden');
        }
        
        async function addPostItFromInput() {
             const message = postItInput.value.trim();
             if (!message) return;
             await sendPostIt(message, null);
             postItInput.value = '';
        }
        
        async function sendPostIt(message, contextSample) {
            if (!message || !currentPdManagerName || !currentSessionId) {
                showAlert("Não é possível guardar a nota. Verifique se está logado e se a mensagem não está vazia.");
                return;
            }

            const button = contextSample ? sendPostItBtn : addPostItBtn;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'A guardar...';

            try {
                const noteData = {
                    message: message,
                    pdManagerName: currentPdManagerName,
                    timestamp: serverTimestamp(),
                    context: contextSample ? `${contextSample.produto} (${contextSample.sellerName})` : null,
                    pedido: contextSample ? contextSample.pedido : null,
                    dataFaturamento: contextSample ? contextSample.emissaoNF : null // Usando emissaoNF como data
                };
                
                await addDoc(collection(db, "sessoes", currentSessionId, "pdPostits"), noteData);
                
                if (contextPostItModal.classList.contains('hidden')) {
                    showAlert("Nota rápida adicionada.", "Sucesso", "text-green-600");
                } else {
                    contextPostItModal.classList.add('hidden');
                }
                
            } catch (error) {
                handleFirestoreError(error, "guardar post-it");
            } finally {
                button.disabled = false;
                button.textContent = originalText;
                currentSampleForPostIt = null;
            }
        }
        
        async function deletePostIt(e) {
             const button = e.currentTarget;
             const noteId = button.dataset.noteId;
             if (!noteId || !currentSessionId) return;
             
             if (!confirm("Tem a certeza que quer excluir este post-it?")) return;
             
             button.disabled = true;
             try {
                 await deleteDoc(doc(db, "sessoes", currentSessionId, "pdPostits", noteId));
                 // O listener 'listenForPdPostits' vai atualizar a UI
             } catch (error) {
                 handleFirestoreError(error, "excluir post-it");
                 button.disabled = false;
             }
        }
        
        // --- Destaques (v2) ---
        function listenForDestaques(sessionId) {
            if (destaquesListenerUnsubscribe) destaquesListenerUnsubscribe();
            
            const destaquesRef = doc(db, "sessoes", sessionId, "configuracoes", "destaquesAmostras");
            
            destaquesListenerUnsubscribe = onSnapshot(destaquesRef, (docSnap) => {
                 highlightedSamplesCache = docSnap.exists() ? (docSnap.data().lista || []) : [];
                 // Re-renderiza o feed de observações para mostrar/ocultar estrelas
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                 }
            }, (error) => {
                 handleFirestoreError(error, "ouvir destaques");
            });
        }
        
        async function toggleDestaqueAmostra(e) {
            e.stopPropagation();
            const sampleId = e.currentTarget.dataset.sampleId;
            if (!currentSessionId || !sampleId) return;

            const destaquesRef = doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras");
            const button = e.currentTarget;
            button.disabled = true;

            try {
                await runTransaction(db, async (transaction) => {
                    const destaquesDoc = await transaction.get(destaquesRef);
                    const currentList = destaquesDoc.exists() ? (destaquesDoc.data().lista || []) : [];
                    let updatedList = [...currentList];

                    if (updatedList.includes(sampleId)) {
                        updatedList = updatedList.filter(id => id !== sampleId);
                    } else {
                        updatedList.push(sampleId);
                    }
                    transaction.set(destaquesRef, { lista: updatedList });
                });
            } catch (error) {
                handleFirestoreError(error, "atualizar destaques");
            } finally {
                 button.disabled = false; // O listener irá atualizar o ícone
            }
        }


        // --- Event Listeners Globais ---
        pdLoginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        observationSearchInput.addEventListener('input', () => renderObservationsFeed(allCurrentSamples));
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        
        // Modais de Resposta e Post-it
        cancelReplyBtn.addEventListener('click', () => replyModal.classList.add('hidden'));
        sendReplyBtn.addEventListener('click', sendReplyToSeller);
        cancelPostItBtn.addEventListener('click', () => contextPostItModal.classList.add('hidden'));
        sendPostItBtn.addEventListener('click', () => {
             const message = postItModalMessage.value.trim();
             sendPostIt(message, currentSampleForPostIt);
        });
        
        // Caixa de Post-it principal
        addPostItBtn.addEventListener('click', addPostItFromInput);
        postItList.addEventListener('click', (e) => {
             const button = e.target.closest('.delete-post-it-btn');
             if (button) deletePostIt({ currentTarget: button });
        });

        // Modal de Notificações (Respostas dos Gestores)
        notificationBtn.addEventListener('click', () => {
             // Re-busca as respostas não lidas ao abrir
             const q = query(
                 collection(db, "sessoes", currentSessionId, "respostasVendedor"),
                 where("readByManager", "==", false)
             );
             getDocs(q).then(snapshot => {
                 const replies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 openNotificationModal(replies);
             });
        });
        closeNotificationBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
        notificationList.addEventListener('click', (e) => {
            const button = e.target.closest('.mark-as-read-btn');
            if (button) markReplyAsRead({ target: button });
        });
        
        // --- INICIALIZAÇÃO ---
        (async () => {
            try {
                await signInAnonymously(auth);
                populatePdButtons();
                
                // Tenta login automático
                const savedPdName = localStorage.getItem('pdManagerName');
                if (savedPdName && PD_PASSWORDS[savedPdName]) {
                    currentPdManagerName = savedPdName;
                    pdLoginBtn.disabled = true;
                    pdLoginBtn.textContent = 'A carregar...';
                    
                    const sessionId = await getActiveSessionId();
                    if (!sessionId) {
                        loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                        logout();
                        return;
                    }
                    
                    dashboardTitle.textContent = `Painel P&D: ${currentPdManagerName}`;
                    await loadAllData(sessionId);
                }
                
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Erro crítico ao conectar com o Firebase. Verifique a configuração.</p>';
            }
        })();

    </script>
</body>
</html>


































