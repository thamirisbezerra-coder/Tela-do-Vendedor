<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela do Vendedor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Changed background color slightly */
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease; }
        /* Style for notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            padding: 2px 5px;
            border-radius: 50%;
            background: red;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px; /* Ensure it's roughly circular even with single digit */
            text-align: center;
        }
         /* Style for seller notification items */
        .seller-notification-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .seller-notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .seller-notification-item blockquote {
            border-left: 3px solid #d1d5db; /* gray-300 */
            padding-left: 0.75rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-style: italic;
            color: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="access-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-md p-8 text-center">
            <div class="mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-20 w-20 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Olá, vendedor(a) Doremus!</h1>
                <p class="text-gray-600 mt-2">Chegou o seu painel de feedbacks de amostras. Colabore conosco para continuarmos atendendo da melhor forma :)</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="session-id-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">ID da Sessão</label>
                    <input type="text" id="session-id-input" placeholder="Cole o ID da sessão aqui" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="seller-name-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">O seu Nome de Vendedor</label>
                    <input type="text" id="seller-name-input" placeholder="Escreva seu nome igual ao anexo no e-mail" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">Código de Acesso</label>
                    <input type="text" id="access-code-input" placeholder="Insira o código de 6 dígitos" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
            </div>
            <button id="load-data-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">Aceder Amostras</button>
            <p id="access-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            <p class="text-xs text-gray-400 mt-8">Doremus, 2025</p>
        </div>
    </div>

    <div id="loading-state" class="hidden flex flex-col items-center justify-center min-h-screen text-center">
        <h1 id="loading-message" class="text-2xl font-bold text-gray-700">A carregar as suas amostras...</h1>
    </div>

    <div id="main-content" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl">
             <header class="mb-8 text-center relative flex justify-between items-center">
                 <div> <!-- Wrapper for title and subtitle -->
                    <h1 id="welcome-title" class="text-3xl font-bold text-gray-800 text-left">Olá!</h1>
                    <p class="text-gray-600 mt-2 text-left">Este é o seu painel para gestão de feedbacks de amostras.</p>
                 </div>
                 <div class="flex items-center gap-4"> <!-- Wrapper for buttons -->
                     <!-- Notification Bell -->
                     <button id="seller-notification-btn" class="relative text-gray-500 hover:text-gray-700" title="Ver respostas do gestor">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="seller-notification-count" class="notification-badge hidden">0</span>
                     </button>
                     <button id="logout-btn" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg text-sm hover:bg-red-600 transition-colors">Sair</button>
                 </div>
            </header>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-200">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Como Funciona?</h3>
                    <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <li>Expanda um pedido para ver as amostras.</li>
                        <li>Clique em <strong>"Atualizar"</strong> na amostra desejada.</li>
                        <li>Selecione uma opção de feedback e escreva a observação.</li>
                        <li>Quando todas as amostras de um pedido forem respondidas, clique em <strong>"Sinalizar Gestor"</strong> para o notificar.</li>
                    </ol>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Dúvidas?</h3>
                    <p class="text-sm text-gray-600">Se encontrar algum problema ou tiver alguma questão sobre o preenchimento, não hesite em me contatar.</p>
                    <p class="text-sm text-gray-600 mt-2">Pode me chamar no <strong>chat</strong> ou enviar um <strong>e-mail</strong>.</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-800">Thamiris Bezerra</p>
                        <p class="text-sm text-gray-600">thamiris.bezerra@doremus.com.br</p>
                    </div>
                </div>
            </div>

            <div id="pending-section" class="hidden">
                <h2 id="pending-orders-count" class="text-2xl font-bold text-gray-800 mb-4"></h2>
                <div id="pending-orders-list" class="space-y-4"></div>
            </div>

            <div id="completed-section" class="mt-12 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Concluídos e Sinalizados</h2>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>
            
            <div id="no-data-message" class="hidden text-center bg-white p-8 rounded-2xl shadow-sm border">
                 <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                 <h2 class="mt-4 text-2xl font-bold text-gray-800">Nenhuma amostra encontrada.</h2>
                 <p class="text-gray-600 mt-2">Verifique se os dados de acesso estão corretos.</p>
            </div>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-4 flex-shrink-0" id="modal-title">Atualizar Feedback</h3>
            <p class="text-gray-600 mb-2 flex-shrink-0">Selecione uma das opções abaixo para a amostra:</p>
            <p class="font-semibold text-gray-800 mb-6 flex-shrink-0" id="modal-sample-info"></p>

            <div id="feedback-options" class="grid grid-cols-2 gap-3 mb-6 overflow-y-auto"></div>
            
            <div class="flex-shrink-0">
                <label for="observation" class="block text-sm font-medium text-gray-700 mb-2">Observação (Obrigatório)</label>
                <textarea id="observation" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Justifique o motivo do feedback..."></textarea>
            </div>

            <div class="mt-8 flex justify-end space-x-3 flex-shrink-0">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="save-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

     <!-- Seller Notifications Modal (Added z-30) -->
     <div id="seller-notifications-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                 <h3 class="text-xl font-bold">Respostas do Gestor</h3>
                 <button id="close-seller-notifications-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="seller-notifications-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                 <p class="text-gray-500">Nenhuma resposta recebida.</p>
            </div>
             <div class="mt-6 flex justify-end">
                 <button id="close-seller-notifications-btn-bottom" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
             </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Corrected imports - removed orderBy and limit from firestore as they require index
        import { getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, setDoc, serverTimestamp, query, where, writeBatch, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; 
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const FEEDBACK_CHOICES = [
            'A - COM PEDIDO', 
            'A - APROVADA SEM PEDIDO', 
            'P - AMOSTRA NÃO TESTADA',
            'P - EM ANÁLISE',
            'P - AMOSTRA SEM FEEDBACK',
            'R - APRESENTAÇÃO PRÓ ATIVA', 
            'R - CALIBRE', 
            'R - EXTRAVIADA', 
            'R - FORA DA ESPECIFICAÇÃO DO CLIENTE', 
            'R - FORA DO PERFIL DO CLIENTE', 
            'R - FRACA / ESTOURANDO / COM CHUVEIRO', 
            'R - PRODUTO DESCONTINUADO', 
            'R - QUANTIDADE INSUFICIENTE', 
            'R - REPRESENTAÇÃO / DISTRIBUIDOR', 
            'R - SEM RETORNO DO CLIENTE', 
            'E - INNOVATION / EVENTOS', 
            'E - EVENTO',
            'R - EXPORTACAO'
        ];

        const accessView = document.getElementById('access-view');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const loadDataBtn = document.getElementById('load-data-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const accessError = document.getElementById('access-error');
        const noDataMessage = document.getElementById('no-data-message');
        const welcomeTitle = document.getElementById('welcome-title');
        
        // Seller Notification Elements (integrated)
        const sellerNotificationBtn = document.getElementById('seller-notification-btn');
        const sellerNotificationCount = document.getElementById('seller-notification-count');
        const sellerNotificationsModal = document.getElementById('seller-notifications-modal');
        const sellerNotificationsList = document.getElementById('seller-notifications-list');
        const closeSellerNotificationsBtn = document.getElementById('close-seller-notifications-btn');
        const closeSellerNotificationsBtnBottom = document.getElementById('close-seller-notifications-btn-bottom');
        
        let currentSample = null;
        let selectedFeedback = null;
        let currentSellerDocRef = null;
        let allSellerSamples = [];
        let unsubscribe = null; // Listener for seller data
        let sellerNotificationListenerUnsubscribe = null; // Listener for notifications TO the seller
        let currentSessionId = null; 
        let currentSellerOriginalName = null; // Store the original name for notification query
        let sellerNotifications = []; // Store seller notifications

        const normalizeText = (text = '') => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        const sanitizeForFirebaseId = (text) => normalizeText(text).replace(/\//g, "-");

        async function attemptLogin(sessionId, sellerName, accessCode, isAutoLogin = false) {
            if (!sessionId || !sellerName || !accessCode) {
                if (!isAutoLogin) accessError.textContent = 'Todos os campos são obrigatórios.';
                return false;
            }
            
            const sellerId = sanitizeForFirebaseId(sellerName);
            currentSessionId = sessionId; 
            currentSellerOriginalName = sellerName; // Store original name initially

            try {
                const docRef = doc(db, "sessoes", sessionId, "vendedores", sellerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().accessCode === accessCode) {
                    currentSellerDocRef = docRef;
                    welcomeTitle.textContent = `Olá, ${docSnap.data().originalName}!`; // Use originalName from DB
                    currentSellerOriginalName = docSnap.data().originalName; // Ensure we use the correct casing from DB

                    if (!isAutoLogin) {
                        localStorage.setItem('sellerSessionId', sessionId);
                        localStorage.setItem('sellerName', currentSellerOriginalName); // Store original name
                        localStorage.setItem('sellerAccessCode', accessCode);
                    }
                    
                    accessError.textContent = '';
                    accessView.classList.add('hidden');
                    loadingState.classList.remove('hidden');
                    
                    requestNotificationPermission(); // Request permission on login
                    startRealtimeListener(); // Start listening for sample updates
                    listenForSellerNotifications(); // Start listening for replies
                    return true;
                } else {
                    if (isAutoLogin) {
                        localStorage.clear();
                        loadingState.classList.add('hidden');
                        accessView.classList.remove('hidden');
                    } else if (docSnap.exists()) {
                        accessError.textContent = 'Código de Acesso inválido. Tente novamente.';
                    } else {
                        accessError.textContent = 'Sessão ou Vendedor não encontrado. Verifique os dados.';
                    }
                    return false;
                }
            } catch (e) {
                if (!isAutoLogin) accessError.textContent = 'Erro ao conectar. Verifique sua internet ou o ID da Sessão.';
                console.error("Erro de autenticação ou busca:", e);
                // If autologin fails, clear local storage and show login
                if(isAutoLogin) {
                    localStorage.clear();
                    loadingState.classList.add('hidden');
                    accessView.classList.remove('hidden');
                }
                return false;
            } finally {
                 if (!isAutoLogin) { // Reset button only on manual login attempt fail
                     loadDataBtn.disabled = false;
                     loadDataBtn.textContent = 'Aceder Amostras';
                 }
            }
        }
        
        loadDataBtn.addEventListener('click', () => {
             loadDataBtn.disabled = true; // Disable button immediately
             loadDataBtn.textContent = 'A verificar...';
            const sessionId = document.getElementById('session-id-input').value.trim();
            const sellerName = document.getElementById('seller-name-input').value.trim();
            const accessCode = document.getElementById('access-code-input').value.trim();
            attemptLogin(sessionId, sellerName, accessCode);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('sellerSessionId');
            localStorage.removeItem('sellerName');
            localStorage.removeItem('sellerAccessCode');
            if(unsubscribe) unsubscribe();
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe(); // Stop notification listener
            window.location.reload();
        });

        // --- FIX: Added event listener for the notification bell ---
        sellerNotificationBtn.addEventListener('click', showSellerNotifications);
        closeSellerNotificationsBtn.addEventListener('click', hideSellerNotifications);
        closeSellerNotificationsBtnBottom.addEventListener('click', hideSellerNotifications);


        function startRealtimeListener() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(currentSellerDocRef, (doc) => {
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');
                
                const sellerData = doc.data();
                allSellerSamples = sellerData.amostras || [];

                if (allSellerSamples.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    document.getElementById('pending-section').classList.add('hidden');
                    document.getElementById('completed-section').classList.add('hidden');
                    return;
                }
                noDataMessage.classList.add('hidden');

                const pendingSamples = allSellerSamples.filter(s => s.isPending && !s.finalizedByVendor); // Filter correctly
                const completedSamples = allSellerSamples.filter(s => s.finalizedByVendor); // Show samples marked as finalized
                
                renderOrders(pendingSamples, 'pending');
                renderOrders(completedSamples, 'completed');
            }, (error) => {
                console.error("Erro no listener do Firebase:", error);
                loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro de conexão.</h1><p class="mt-2">Tente recarregar a página.</p>`;
            });
        }
            
        function renderOrders(samples, type) {
            const isPendingSection = type === 'pending';
            const container = document.getElementById(`${type}-orders-list`);
            const section = document.getElementById(`${type}-section`);

            if (samples.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';
            
            const groupedByOrder = samples.reduce((acc, sample) => {
                const key = sample.pedido;
                if (!acc[key]) acc[key] = { ...sample, samples: [] }; // Use first sample for order info
                acc[key].samples.push(sample);
                return acc;
            }, {});

            if(isPendingSection) document.getElementById('pending-orders-count').textContent = `${Object.keys(groupedByOrder).length} Pedido(s) com Pendências`;

            Object.values(groupedByOrder).forEach(order => {
                const orderGroup = document.createElement('div');
                // Check if *all* samples within *this specific order* are answered (not globally)
                const allSamplesInThisOrderAnswered = order.samples.every(s => !s.isPending); 
                const statusColor = isPendingSection ? (allSamplesInThisOrderAnswered ? 'blue' : 'yellow') : 'green'; // Blue if pending but ready to signal
                orderGroup.className = `bg-white rounded-2xl shadow-sm border-l-4 border-${statusColor}-400 fade-in`; // Add fade-in
                
                const samplesTableRowsHTML = order.samples.map(sample => {
                     const qty = parseFloat(String(sample.qtde).replace(',', '.'));
                     let formattedQty = '';
                     if (!isNaN(qty)) {
                         if (qty >= 1 || qty === 0) { // Handle 0kg case
                              formattedQty = `${qty.toFixed(3).replace('.', ',')}kg`;
                         } else {
                              formattedQty = `${Math.round(qty * 1000)}g`;
                         }
                     } else {
                          formattedQty = sample.qtde; // Fallback to original string if not a number
                     }


                    return `
                    <tr class="border-b last:border-b-0">
                        <td class="p-3">
                            <p class="font-semibold">${sample.produto}</p>
                            <p class="text-xs text-gray-500">${sample.descricao}</p>
                        </td>
                        <td class="p-3">${formattedQty}</td>
                        <td class="p-3 hidden md:table-cell">${sample.originalStatus}</td>
                        <td class="p-3 font-semibold">${sample.isPending ? '<span class="text-gray-500">Pendente</span>' : `<div>${sample.feedback}</div><div class='text-gray-500 font-normal text-xs'>${sample.observation}</div>`}</td>
                        <td class="p-3 text-right space-x-2">
                             ${isPendingSection || !sample.finalizedByVendor ? `<button class="update-btn bg-blue-100 text-blue-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-blue-200" data-sample-id='${sample.id}'>${sample.isPending ? 'Atualizar' : 'Editar'}</button>` : ''}
                            ${!sample.isPending && (isPendingSection || !sample.finalizedByVendor) ? `<button class="delete-btn bg-red-100 text-red-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-red-200" data-sample-id='${sample.id}'>Excluir</button>` : ''}
                        </td>
                    </tr>
                `}).join('');

                orderGroup.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer order-header"> <!-- Added order-header class -->
                        <div>
                             <h3 class="font-bold text-lg flex items-center"><span class="w-3 h-3 bg-${statusColor}-400 rounded-full mr-3"></span>${order.pedido} - ${order.razaoSocial}</h3>
                             <p class="text-sm text-gray-500 ml-6">Nota Fiscal: ${order.notaFiscal || 'N/A'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="overflow-x-auto samples-table hidden"> <!-- Added samples-table class and hidden -->
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>
                                    <th class="p-3 font-medium text-gray-500">Produto</th>
                                    <th class="p-3 font-medium text-gray-500">Qtde.</th>
                                    <th class="p-3 font-medium text-gray-500 hidden md:table-cell">Status Atual</th>
                                    <th class="p-3 font-medium text-gray-500">Feedback</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody>${samplesTableRowsHTML}</tbody>
                        </table>
                         ${isPendingSection && allSamplesInThisOrderAnswered ? `
                         <div class="p-4 border-t text-right bg-blue-50">
                             <p class="text-sm text-gray-700 text-left mb-2">Todas as amostras deste pedido foram respondidas. Clique abaixo para notificar o gestor.</p>
                             <button class="signal-manager-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700" data-order-id="${order.pedido}">Sinalizar Gestor</button>
                         </div>` : ''}
                          ${!isPendingSection ? `
                          <div class="p-3 border-t text-xs text-gray-500 bg-gray-50 text-center">
                               Este pedido já foi sinalizado para o gestor.
                          </div>` : ''}
                    </div>
                `;
                
                container.appendChild(orderGroup);
            });

             // Add event listeners for expand/collapse AFTER rendering all orders
             container.querySelectorAll('.order-header').forEach(header => {
                header.addEventListener('click', () => {
                    const tableDiv = header.nextElementSibling;
                    const arrow = header.querySelector('svg');
                    tableDiv.classList.toggle('hidden');
                    arrow.classList.toggle('rotate-180');
                 });
             });

            container.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sampleToUpdate = allSellerSamples.find(s => s.id === btn.dataset.sampleId);
                    if(sampleToUpdate) openModal(sampleToUpdate);
                });
            });
            container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => { // Make async
                    const sampleId = e.currentTarget.dataset.sampleId;
                    // Confirmation dialog
                    if (!confirm('Tem a certeza que quer excluir este feedback e voltar a amostra para pendente?')) {
                        return; // Stop if user cancels
                    }
                    e.currentTarget.disabled = true;
                    // Reset feedback and mark as pending again
                    await updateSampleData(sampleId, { isPending: true, feedback: '', observation: '', finalizedByVendor: false }); // Wait for update
                    e.currentTarget.disabled = false; // Re-enable after update (or remove if row disappears)
                });
            });
             container.querySelectorAll('.signal-manager-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    e.currentTarget.disabled = true;
                    e.currentTarget.textContent = 'Sinalizado!';

                    // Find all samples for this order ID to mark them finalizedByVendor
                    const updatedSamples = allSellerSamples.map(sample => {
                        if (sample.pedido === orderId) {
                            // Ensure it's not pending before marking as finalized
                            return { ...sample, finalizedByVendor: !sample.isPending }; 
                        }
                        return sample;
                    });

                    // Update the local state immediately for UI responsiveness
                    allSellerSamples = updatedSamples; 

                    // Update Firestore
                    try {
                         await updateDoc(currentSellerDocRef, { amostras: updatedSamples });
                         console.log(`Pedido ${orderId} marcado como finalizado pelo vendedor.`);
                         // Notification logic might need adjustment if you only notify on ALL samples finalized globally
                         // For now, let's keep the notification simple for signaling this order
                         const sellerName = welcomeTitle.textContent.replace('Olá, ', '').replace('!', '');
                         const message = `<strong>${sellerName}</strong> sinalizou o pedido: <strong>${orderId}</strong> como concluído.`;
                         const notifId = sanitizeForFirebaseId(`${sellerName}-${orderId}-concluido-${Date.now()}`);
                         const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                         await setDoc(notifRef, { 
                             message, 
                             color: 'purple', // Color for order signaled
                             timestamp: serverTimestamp(),
                             triggerPopup: false // Don't trigger popup for single order signal
                         });

                    } catch(error) {
                         console.error("Erro ao sinalizar gestor ou atualizar amostras:", error);
                         alert("Erro ao sinalizar. Tente novamente.");
                         // Revert local state and button if update fails? (More complex UI handling)
                         e.currentTarget.disabled = false;
                         e.currentTarget.textContent = 'Sinalizar Gestor';
                    }
                    
                    // Re-render UI after update
                    renderOrders(updatedSamples.filter(s => s.isPending && !s.finalizedByVendor), 'pending');
                    renderOrders(updatedSamples.filter(s => s.finalizedByVendor), 'completed');

                });
            });
        }
        
        function openModal(sample) {
            currentSample = sample;
            selectedFeedback = sample.feedback || null;
            const observationInput = document.getElementById('observation');
            observationInput.value = sample.observation || '';
            document.getElementById('modal-sample-info').textContent = `${sample.produto} - ${sample.descricao}`;
            
            const feedbackOptionsContainer = document.getElementById('feedback-options');
            feedbackOptionsContainer.innerHTML = '';
            FEEDBACK_CHOICES.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.dataset.feedback = choice;
                button.className = 'feedback-choice-btn border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg hover:bg-gray-100 transition-all';
                if(choice === selectedFeedback) button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                feedbackOptionsContainer.appendChild(button);
            });
            
            validateForm();
            document.getElementById('feedback-modal').classList.remove('hidden');
        }

        document.getElementById('feedback-options').addEventListener('click', (e) => {
            if (e.target.classList.contains('feedback-choice-btn')) {
                document.querySelectorAll('.feedback-choice-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedFeedback = e.target.dataset.feedback;
                validateForm();
            }
        });

        function closeModal() { document.getElementById('feedback-modal').classList.add('hidden'); }
        function validateForm() {
            const saveButton = document.getElementById('save-button');
             // Observation is now mandatory
            saveButton.disabled = !document.getElementById('observation').value.trim() || !selectedFeedback; 
        }
        
        document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
        document.getElementById('observation').addEventListener('input', validateForm);
        
        document.getElementById('save-button').addEventListener('click', () => {
            if (document.getElementById('save-button').disabled) return;
            
            const updates = {
                isPending: false, // Mark as answered
                feedback: selectedFeedback,
                observation: document.getElementById('observation').value.trim(),
                editedAfterCompletion: !currentSample.isPending, // Track edits
                // lastUpdate: serverTimestamp() // Use server timestamp for consistency
            };

            closeModal();
            updateSampleData(currentSample.id, updates);
        });

        async function updateSampleData(sampleId, updates) {
            try {
                // Find index without modifying original array directly in map
                const sampleIndex = allSellerSamples.findIndex(s => s.id === sampleId);
                if (sampleIndex === -1) {
                    throw new Error("Sample not found in local cache.");
                }
                // Create updated array
                const updatedSamples = [...allSellerSamples]; 
                updatedSamples[sampleIndex] = { ...updatedSamples[sampleIndex], ...updates };

                // Update Firestore
                await updateDoc(currentSellerDocRef, { amostras: updatedSamples });
                
                // Update local state *after* successful Firestore update
                allSellerSamples = updatedSamples; 
                
                // Re-rendering will happen via the onSnapshot listener, no need to call renderOrders here
                console.log(`Sample ${sampleId} updated successfully.`);

            } catch (error) {
                console.error("Falha ao atualizar a amostra:", error);
                alert("Não foi possível guardar o feedback. A sua tela pode estar dessincronizada. Tente recarregar a página.");
                 // Optionally re-enable button if update fails, although re-render might remove it
                 const deleteButton = document.querySelector(`.delete-btn[data-sample-id='${sampleId}']`);
                 if(deleteButton) deleteButton.disabled = false;
            }
        }
        
        // --- Seller Notification Functions (Integrated) ---

        function listenForSellerNotifications() {
            if (!currentSessionId || !currentSellerOriginalName) { // Use original name here
                 console.warn("Cannot listen for seller notifications: Session ID or Seller Name missing.");
                 return;
            }
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe(); 

            // Corrected Query: Removed orderBy, will sort client-side
            const q = query(
                collection(db, "sessoes", currentSessionId, "notificacoesVendedor"),
                where("sellerName", "==", currentSellerOriginalName) // Query using original name
            );

            sellerNotificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const previousUnreadCount = sellerNotifications.filter(n => !n.read).length;
                
                // Fetch and map data
                sellerNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort client-side
                sellerNotifications.sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));

                const currentUnreadCount = sellerNotifications.filter(n => !n.read).length;

                updateSellerNotificationBadge();

                if (currentUnreadCount > previousUnreadCount && !snapshot.metadata.hasPendingWrites) { // Avoid triggering on own writes if possible
                    snapshot.docChanges().forEach((change) => {
                        // Check type 'added' and ensure it's not from local cache modification
                         if (change.type === "added" && !change.doc.metadata.fromCache) {
                             const newData = change.doc.data();
                             if (!newData.read) { 
                                 showBrowserNotification(
                                     `Resposta de ${newData.managerName}`,
                                     `Ref. ${newData.produto} (${newData.pedido}): ${newData.replyMessage}`
                                 );
                             }
                        }
                    });
                }
            }, (error) => {
                console.error("Erro ao escutar notificações do vendedor:", error);
                // Handle error appropriately, maybe log it or inform user subtly
            });
        }


        function updateSellerNotificationBadge() {
             if(!sellerNotificationCount) return; // Add null check
            const unreadCount = sellerNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                sellerNotificationCount.textContent = unreadCount;
                sellerNotificationCount.classList.remove('hidden');
            } else {
                sellerNotificationCount.classList.add('hidden');
            }
        }

        async function showSellerNotifications() {
             sellerNotificationsList.innerHTML = ''; 
             if (sellerNotifications.length === 0) {
                 sellerNotificationsList.innerHTML = '<p class="text-gray-500">Nenhuma resposta recebida.</p>';
             } else {
                 const batch = writeBatch(db);
                 let needsUpdate = false;
                 // Use the already sorted sellerNotifications array
                 sellerNotifications.forEach(notif => { 
                     const itemDiv = document.createElement('div');
                     itemDiv.className = `seller-notification-item text-sm ${!notif.read ? 'font-semibold bg-blue-50 p-2 rounded' : 'text-gray-600 p-2'}`; // Highlight unread
                     itemDiv.innerHTML = `
                         <p class="mb-1">
                             <span class="font-bold">${notif.managerName}</span> respondeu sobre 
                             <strong>${notif.produto}</strong> (Pedido: ${notif.pedido}):
                         </p>
                         <p>${notif.replyMessage}</p>
                         ${notif.originalObservation ? `<blockquote>Observação Original: "${notif.originalObservation}"</blockquote>` : ''}
                         <p class="text-xs text-gray-400 mt-1 text-right">${notif.timestamp?.toDate().toLocaleString('pt-BR') ?? 'Data indisponível'}</p>
                     `;
                     sellerNotificationsList.appendChild(itemDiv);

                     if (!notif.read) {
                         const notifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", notif.id);
                         batch.update(notifRef, { read: true });
                         needsUpdate = true;
                     }
                 });

                 if (needsUpdate) {
                     try {
                         await batch.commit();
                         // The listener will shortly update the array and badge after commit reflects
                         console.log("Notificações marcadas como lidas.");
                     } catch (error) {
                         console.error("Erro ao marcar notificações como lidas:", error);
                     }
                 }
             }
             sellerNotificationsModal.classList.remove('hidden');
        }


        function hideSellerNotifications() {
             sellerNotificationsModal.classList.add('hidden');
        }

        // --- Browser Notification Functions ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("Este navegador não suporta notificações desktop");
                return;
            }
            if (Notification.permission !== 'denied') {
                 Notification.requestPermission().then(permission => {
                     console.log("Permissão de notificação:", permission);
                 });
            }
        }

        function showBrowserNotification(title, body) {
            if (Notification.permission === 'granted') {
                // Check if window/tab is active
                if(document.visibilityState === 'visible') {
                     console.log("Tab is active, skipping browser notification.");
                     return; // Don't show if user is looking at the page
                }
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/fluency/96/send-letter.png' 
                });
            }
        }


        // --- Initial Load ---
        async function checkLocalStorage() {
            const savedSessionId = localStorage.getItem('sellerSessionId');
            const savedSellerName = localStorage.getItem('sellerName');
            const savedAccessCode = localStorage.getItem('sellerAccessCode');
            
            if (savedSessionId && savedSellerName && savedAccessCode) {
                 loadingMessage.textContent = 'A verificar sessão guardada...';
                 accessView.classList.add('hidden');
                 loadingState.classList.remove('hidden');
                 const loginSuccess = await attemptLogin(savedSessionId, savedSellerName, savedAccessCode, true);
                 // If auto-login fails, attemptLogin handles showing the login view
                 if (!loginSuccess) {
                     console.log("Auto-login falhou. A mostrar ecrã de login.");
                     // attemptLogin already shows login view on failure during auto-login
                 }
            } else {
                 accessView.classList.remove('hidden'); // Show login if nothing saved
                 loadingState.classList.add('hidden');
            }
        }

        (async () => {
            try {
                await signInAnonymously(auth);
                await checkLocalStorage(); 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                accessError.textContent = "Não foi possível conectar ao serviço.";
                accessView.classList.remove('hidden'); 
                loadingState.classList.add('hidden');
            }
        })();

    </script>
</body>
</html>

>


























