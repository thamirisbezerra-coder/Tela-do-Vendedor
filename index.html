<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Vendedor | Doremus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .status-dot { display: inline-block; width: 0.5rem; height: 0.5rem; border-radius: 50%; margin-right: 0.35rem; }
        
        /* Estilos de Linha */
        .row-written-off { background-color: #f3e8ff !important; }
        .row-written-off td { color: #6b21a8 !important; border-color: #e9d5ff !important; }
        
        /* Ajuste Fino Tabela */
        .modern-table th { 
            font-size: 0.70rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #64748b; 
            font-weight: 700; 
            background-color: #f8fafc; 
            border-bottom: 2px solid #e2e8f0; 
            white-space: nowrap; 
            padding: 12px; 
        }
        .modern-table td { 
            font-size: 0.80rem; 
            color: #334155; 
            border-bottom: 1px solid #f1f5f9; 
            padding: 12px; 
            vertical-align: top; /* Alinha texto ao topo se quebrar linha */
        }
        .modern-table tr:hover td { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- LOGIN / ACCESS VIEW -->
    <div id="access-view" class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-r from-blue-700 to-indigo-800 transform skew-y-3 origin-top-left -translate-y-20 z-0"></div>
        
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 relative z-10 fade-in border border-slate-100">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/76mXWMJh/as-02.png" alt="Doremus Logo" class="h-16 mx-auto mb-4 object-contain">
                <h1 class="text-2xl font-bold text-slate-800">Painel de Amostras</h1>
                <p class="text-slate-500 text-sm mt-1">Bem-vindo(a) ao portal de feedbacks.</p>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="access-code-input" class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 text-center">Digite seu C√≥digo</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        </span>
                        <input type="text" id="access-code-input" class="w-full pl-12 pr-4 py-4 bg-slate-50 border-2 border-blue-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all outline-none text-slate-800 font-bold text-xl text-center tracking-widest placeholder-slate-300">
                    </div>
                </div>

                <button id="load-data-btn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold py-4 rounded-xl hover:shadow-lg hover:to-indigo-800 transition-all transform active:scale-[0.98] text-lg">
                    Entrar
                </button>
            </div>
            
            <div id="access-error" class="text-red-500 text-sm mt-6 text-center font-medium min-h-[20px]"></div>
        </div>
        <p class="text-slate-400 text-xs mt-6">¬© 2025 Doremus Aromes et Parfums</p>
    </div>

    <!-- LOADING STATE -->
    <div id="loading-state" class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-100 border-t-blue-600 mb-6"></div>
        <h2 id="loading-message" class="text-xl font-bold text-slate-800">A conectar...</h2>
        <p id="loading-detail" class="text-sm text-slate-500 mt-2">Buscando cadastro...</p>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="main-content" class="hidden min-h-screen pb-12">
        <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://i.postimg.cc/76mXWMJh/as-02.png" alt="Logo" class="h-8 md:h-10">
                        <div class="hidden md:block w-px h-6 bg-slate-300"></div>
                        <div>
                            <h1 id="welcome-title" class="text-sm md:text-base font-bold text-slate-800">Ol√°</h1>
                            <p id="session-info" class="text-xs text-slate-500">Sess√£o: ...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 md:gap-4">
                        <!-- Admin Button -->
                        <button id="admin-login-btn" class="p-2 text-slate-400 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors" title="√Årea Administrativa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        </button>

                         <button id="refresh-btn" class="p-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50 rounded-full transition-colors" title="Recarregar Dados">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        </button>
                        <div class="relative">
                            <button id="seller-notification-btn" class="p-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50 rounded-full transition-colors relative">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                <span id="seller-notification-count" class="notification-badge hidden">0</span>
                            </button>
                        </div>
                        <button id="logout-btn" class="flex items-center gap-2 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span class="hidden md:inline">Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- ORIENTA√á√ïES IMPORTANTES -->
            <div class="mb-8 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-xl shadow-sm">
                <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Orienta√ß√µes Importantes
                </h3>
                <ul class="space-y-3 text-sm text-blue-900">
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                        <span>Pedidos respondidos anteriormente como <strong>pendentes</strong> entram neste novo relat√≥rio para atualiza√ß√£o.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                        <span><strong>Coment√°rios s√£o fundamentais</strong>, principalmente nas reprova√ß√µes.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                        <span>Use o √≠cone de <strong>Nota</strong> no pedido para lembretes pessoais.</span>
                    </li>
                </ul>
            </div>

            <!-- STATS BAR -->
            <div class="flex flex-wrap gap-4 justify-between items-center mb-6 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                <div class="text-sm font-semibold text-slate-500">Resumo:</div>
                <div class="flex gap-4 text-xs font-medium text-slate-500">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500 shadow-sm"></span> Aprovadas: <span id="stats-approved" class="font-bold text-slate-700 text-sm">0</span></div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500 shadow-sm"></span> Reprovadas: <span id="stats-reproved" class="font-bold text-slate-700 text-sm">0</span></div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-400 shadow-sm"></span> Pendentes: <span id="stats-pending" class="font-bold text-slate-700 text-sm">0</span></div>
                </div>
            </div>

            <!-- PENDING SECTION (FOCAL POINT) -->
            <div id="pending-section" class="mb-10 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="bg-blue-600 text-white p-1 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </span>
                        Pend√™ncias
                    </h2>
                    <span id="pending-count-badge" class="bg-yellow-500 text-white text-sm font-bold px-3 py-1 rounded-full shadow-sm animate-pulse">0</span>
                </div>
                <div id="pending-orders-list" class="space-y-6"></div>
            </div>

            <div id="completed-section" class="mb-10 hidden">
                <div class="flex items-center justify-between mb-4 pt-8 border-t border-slate-200">
                    <h2 class="text-xl font-bold text-slate-400">Hist√≥rico / Conclu√≠dos</h2>
                </div>
                <div id="completed-orders-list" class="space-y-6 opacity-80 hover:opacity-100 transition-opacity"></div>
            </div>

            <!-- Empty State -->
            <div id="no-data-message" class="hidden text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300">
                <div class="bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Tudo em dia!</h3>
                <p class="text-slate-500">Voc√™ n√£o tem amostras pendentes no momento.</p>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40 transition-all duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] overflow-hidden transform transition-all scale-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="modal-title">Atualizar Feedback</h3>
                    <p class="text-slate-500 text-sm mt-1" id="modal-sample-info">Carregando...</p>
                </div>
                <button id="cancel-modal-btn" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Selecione o status:</p>
                <div id="feedback-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                    <!-- Buttons injected via JS -->
                </div>
                <label for="observation" class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Observa√ß√£o Complementar</label>
                <textarea id="observation" rows="3" class="w-full border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 p-3 text-sm text-slate-700 bg-slate-50" placeholder="Detalhe aqui o motivo do feedback..."></textarea>
                
                 <div class="mt-4 pt-4 border-t border-slate-100">
                    <label class="flex items-center gap-2 text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        Nota Pessoal (S√≥ voc√™ v√™)
                    </label>
                    <input type="text" id="personal-note" class="w-full border-slate-200 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm bg-indigo-50/50" placeholder="Lembrete pessoal...">
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button id="save-button" class="bg-blue-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    Salvar Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- SELLER NOTIFICATIONS MODAL -->
    <div id="seller-notifications-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-blue-50/50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">Mensagens do Gestor</h3>
                <button id="close-seller-notifications-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="seller-notifications-list" class="p-5 overflow-y-auto custom-scrollbar space-y-4 bg-slate-50 flex-1"></div>
        </div>
    </div>
    
    <!-- REPLY TO MANAGER MODAL -->
    <div id="seller-reply-modal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Responder ao Gestor</h3>
            <div class="bg-slate-100 p-3 rounded-lg border border-slate-200 mb-4 text-sm text-slate-600 italic">
                <p id="seller-reply-context" class="font-bold text-xs uppercase text-slate-400 mb-1">...</p>
                <p id="seller-reply-original-msg" class="font-medium text-slate-800">...</p>
            </div>
            <textarea id="seller-reply-message-input" rows="3" class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 p-3 mb-4" placeholder="Escreva sua resposta..."></textarea>
            <div class="flex justify-end gap-3">
                <button id="cancel-seller-reply-btn" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-semibold">Cancelar</button>
                <button id="send-seller-reply-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow">Enviar Resposta</button>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN MODAL -->
    <div id="admin-login-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[80]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center">
            <div class="mx-auto bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mb-4 text-purple-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-4">Acesso Administrativo</h3>
            <input type="password" id="admin-password-input" class="w-full border-slate-300 rounded-lg p-3 mb-4 text-center text-lg" placeholder="Senha">
            <div class="flex gap-2">
                <button id="cancel-admin-btn" class="flex-1 py-2 text-slate-500 hover:bg-slate-50 rounded-lg">Cancelar</button>
                <button id="confirm-admin-btn" class="flex-1 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700">Entrar</button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL MODAL (Wide Table) -->
    <div id="admin-panel-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[90]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl flex flex-col max-h-[95vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-purple-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Gerenciamento Administrativo
                </h3>
                <button id="close-admin-panel" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-0 overflow-hidden flex-1 flex flex-col bg-slate-50">
                <div class="p-4 bg-white border-b border-slate-200">
                     <p class="text-xs text-slate-500">
                        <strong>Reverter:</strong> Volta para amarelo (Pendente). <strong>Dar Baixa:</strong> Trava em roxo (Finalizado).
                    </p>
                </div>
                <div class="flex-1 overflow-auto custom-scrollbar p-2">
                    <table class="w-full text-left border-collapse modern-table bg-white shadow-sm rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th class="whitespace-nowrap">Pedido</th>
                                <th class="whitespace-nowrap">Raz√£o Social</th>
                                <th class="whitespace-nowrap">Produto</th>
                                <th class="w-1/4">Descri√ß√£o</th>
                                <th>Qtde</th>
                                <th>Nota Fiscal</th>
                                <th>Emiss√£o NF</th>
                                <th>Feedback</th>
                                <th class="text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="admin-items-list" class="divide-y divide-slate-100">
                            <!-- Items Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- THANK YOU MODAL (Celebration) -->
    <div id="thank-you-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[100]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center transform scale-100 relative overflow-hidden">
            <div class="absolute inset-0 bg-blue-50/50 z-0"></div>
            <div class="relative z-10">
                <div class="mb-6 animate-bounce">
                    <span class="text-7xl">üéâ</span>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">Parab√©ns e Obrigado!</h2>
                <p class="text-slate-600 text-lg mb-2">Voc√™ concluiu todas as pend√™ncias.</p>
                <p class="text-slate-500 text-sm mt-4 bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                    Agradecemos o preenchimento em mais um relat√≥rio e pela colabora√ß√£o.
                </p>
                <button onclick="document.getElementById('thank-you-modal').classList.add('hidden')" class="mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 px-8 rounded-xl hover:shadow-lg transition-all w-full">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- CUSTOM ALERT -->
    <div id="custom-alert" class="fixed inset-0 bg-slate-900/70 flex items-center justify-center p-4 hidden z-[70]">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 id="custom-alert-title" class="text-lg leading-6 font-medium text-slate-900">Aten√ß√£o</h3>
            <div class="mt-2">
                <p id="custom-alert-message" class="text-sm text-slate-500">Msg</p>
            </div>
            <div class="mt-5">
                <button id="custom-alert-ok-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-slate-800 text-base font-medium text-white hover:bg-slate-700 focus:outline-none sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, setDoc, 
            serverTimestamp, query, where, collectionGroup, getDocs, addDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const FEEDBACK_CHOICES = [
            'A - COM PEDIDO', 'A - APROVADA SEM PEDIDO',
            'P - AMOSTRA N√ÉO TESTADA', 'P - EM AN√ÅLISE', 'P - AMOSTRA SEM FEEDBACK',
            'R - APRESENTA√á√ÉO PR√ì ATIVA', 'R - CALIBRE', 'R - EXTRAVIADA',
            'R - FORA DA ESPECIFICA√á√ÉO DO CLIENTE', 'R - FORA DO PERFIL DO CLIENTE',
            'R - FRACA / ESTOURANDO / COM CHUVEIRO', 'R - PRODUTO DESCONTINUADO',
            'R - QUANTIDADE INSUFICIENTE', 'R - REPRESENTA√á√ÉO / DISTRIBUIDOR',
            'R - SEM RETORNO DO CLIENTE', 'R - EXPORTACAO',
            'E - INNOVATION / EVENTOS', 'E - EVENTO'
        ];

        // --- DOM Elements ---
        const accessView = document.getElementById('access-view');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const loadDataBtn = document.getElementById('load-data-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const accessError = document.getElementById('access-error');
        const welcomeTitle = document.getElementById('welcome-title');
        const sessionInfo = document.getElementById('session-info');

        // Modals
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackOptionsContainer = document.getElementById('feedback-options');
        const observationInput = document.getElementById('observation');
        const personalNoteInput = document.getElementById('personal-note');
        const cancelFeedbackModalBtn = document.getElementById('cancel-modal-btn');
        const saveFeedbackBtn = document.getElementById('save-button');
        const modalTitle = document.getElementById('modal-title');
        const modalSampleInfo = document.getElementById('modal-sample-info');
        const thankYouModal = document.getElementById('thank-you-modal');

        // Admin Elements
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const cancelAdminBtn = document.getElementById('cancel-admin-btn');
        const confirmAdminBtn = document.getElementById('confirm-admin-btn');
        const adminPanelModal = document.getElementById('admin-panel-modal');
        const closeAdminPanelBtn = document.getElementById('close-admin-panel');
        const adminItemsList = document.getElementById('admin-items-list');

        // Notifications
        const sellerNotificationBtn = document.getElementById('seller-notification-btn');
        const sellerNotificationCount = document.getElementById('seller-notification-count');
        const sellerNotificationsModal = document.getElementById('seller-notifications-modal');
        const sellerNotificationsList = document.getElementById('seller-notifications-list');
        const closeSellerNotificationsBtn = document.getElementById('close-seller-notifications-btn');
        
        // Reply
        const sellerReplyModal = document.getElementById('seller-reply-modal');
        const sellerReplyContext = document.getElementById('seller-reply-context');
        const sellerReplyOriginalMsg = document.getElementById('seller-reply-original-msg');
        const sellerReplyMessageInput = document.getElementById('seller-reply-message-input');
        const cancelSellerReplyBtn = document.getElementById('cancel-seller-reply-btn');
        const sendSellerReplyBtn = document.getElementById('send-seller-reply-btn');

        // Stats
        const statsApproved = document.getElementById('stats-approved');
        const statsReproved = document.getElementById('stats-reproved');
        const statsPending = document.getElementById('stats-pending');

        // Alert
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- State ---
        let currentSessionId = null;
        let currentSellerOriginalName = null;
        let currentSellerDocRef = null;
        let allSellerSamples = [];
        let sellerNotifications = [];
        let dataListenersUnsubscribe = null;
        let notificationListenerUnsubscribe = null;
        let currentSample = null;
        let selectedFeedback = null;
        let currentActiveSessionName = "Sess√£o";
        let currentNotificationForReply = null;

        // --- Utils ---
        function showAlert(message, title = "Aten√ß√£o") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function fireConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 }; // High Z-Index
            var random = function(min, max) { return Math.random() * (max - min) + min; }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { return clearInterval(interval); }
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function triggerThankYou() {
            fireConfetti();
            setTimeout(() => {
                thankYouModal.classList.remove('hidden');
            }, 500);
        }

        // --- Date Parsing Helper ---
        function formatDate(value) {
            if (!value) return '-';
            
            // Firestore Timestamp
            if (value && typeof value === 'object' && value.toDate) {
                return value.toDate().toLocaleDateString('pt-BR');
            }
            
            // Already formatted string
            if (typeof value === 'string' && value.includes('/')) {
                return value;
            }
            
            // Try ISO string
            const d = new Date(value);
            if (!isNaN(d.getTime())) {
                return d.toLocaleDateString('pt-BR');
            }
            
            return value; // Return as is if nothing else works
        }

        // --- Login Logic ---
        async function getActiveSession() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return { id: docSnap.data().current };
                }
                return null;
            } catch (error) { return null; }
        }

        async function attemptLogin() {
            const inputCodeRaw = document.getElementById('access-code-input').value.trim();
            if (!inputCodeRaw) { accessError.textContent = 'Digite o C√≥digo.'; return; }

            loadingMessage.textContent = 'A conectar...';
            accessView.classList.add('hidden');
            loadingState.classList.remove('hidden');
            
            let foundSessionId = null;
            let foundSellerDocSnap = null;

            try {
                const activeSession = await getActiveSession();
                
                if (activeSession) {
                    const vendedoresRef = collection(db, "sessoes", activeSession.id, "vendedores");
                    let q = query(vendedoresRef, where('accessCode', '==', inputCodeRaw));
                    let snap = await getDocs(q);
                    
                    if(snap.empty && !isNaN(inputCodeRaw)) {
                        q = query(vendedoresRef, where('accessCode', '==', parseInt(inputCodeRaw, 10)));
                        snap = await getDocs(q);
                    }
                    if(snap.empty) {
                        q = query(vendedoresRef, where('codigo', '==', inputCodeRaw));
                        snap = await getDocs(q);
                    }

                    if (!snap.empty) {
                        foundSellerDocSnap = snap.docs[0];
                        foundSessionId = activeSession.id;
                    }
                }

                if (!foundSessionId) {
                    let q = query(collectionGroup(db, 'vendedores'), where('accessCode', '==', inputCodeRaw));
                    let snap = await getDocs(q);
                     if (snap.empty && !isNaN(inputCodeRaw)) {
                         q = query(collectionGroup(db, 'vendedores'), where('accessCode', '==', parseInt(inputCodeRaw, 10)));
                         snap = await getDocs(q);
                     }
                    if (!snap.empty) {
                        foundSellerDocSnap = snap.docs[0];
                        if (foundSellerDocSnap.ref.parent && foundSellerDocSnap.ref.parent.parent) {
                            foundSessionId = foundSellerDocSnap.ref.parent.parent.id;
                        }
                    }
                }
            } catch (err) { console.error(err); }

            if (foundSessionId && foundSellerDocSnap) {
                currentSessionId = foundSessionId;
                currentSellerDocRef = foundSellerDocSnap.ref;
                currentSellerOriginalName = foundSellerDocSnap.data().originalName || "Vendedor";
                
                try {
                    const configSnap = await getDoc(doc(db, "sessoes", currentSessionId, "configuracoes", "geral"));
                    currentActiveSessionName = configSnap.exists() ? configSnap.data().nome : currentSessionId;
                } catch(e) {}

                sessionInfo.textContent = `Sess√£o: ${currentActiveSessionName}`;
                welcomeTitle.textContent = `Ol√°, ${currentSellerOriginalName}`;
                localStorage.setItem('sellerCodeV15', inputCodeRaw);
                
                startRealtimeListeners();
                listenForSellerNotifications();
            } else {
                accessError.textContent = 'C√≥digo n√£o encontrado.';
                loadingState.classList.add('hidden');
                accessView.classList.remove('hidden');
            }
        }

        // --- Data Handling ---
        function startRealtimeListeners() {
            if (dataListenersUnsubscribe) dataListenersUnsubscribe();

            dataListenersUnsubscribe = onSnapshot(currentSellerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const samples = data.amostras || [];
                    // Ensure ID in memory for UI matching
                    allSellerSamples = samples.map(s => ({ ...s, id: s.id || Math.random().toString(36).substr(2, 9) }));
                    
                    updateStats();
                    renderDashboard();
                    if(!adminPanelModal.classList.contains('hidden')) renderAdminView();
                }
            }, (error) => {
                showAlert("Erro de conex√£o: " + error.message);
            });
        }

        function updateStats() {
            let approved = 0, reproved = 0, pending = 0;
            allSellerSamples.forEach(s => {
                if (s.writtenOff) return; 
                const isFinalized = s.finalizedByVendor === true;
                if (!isFinalized && !s.writtenOff) {
                    pending++;
                } else if (s.feedback) {
                    if (s.feedback.startsWith('A')) approved++;
                    else if (s.feedback.startsWith('R')) reproved++;
                }
            });

            document.getElementById('stats-approved').textContent = approved;
            document.getElementById('stats-reproved').textContent = reproved;
            document.getElementById('stats-pending').textContent = pending;
            document.getElementById('pending-count-badge').textContent = pending;
        }

        // --- Main Render ---
        function renderDashboard() {
            loadingState.classList.add('hidden');
            mainContent.classList.remove('hidden');

            const pendingContainer = document.getElementById('pending-orders-list');
            const completedContainer = document.getElementById('completed-orders-list');
            const pendingSection = document.getElementById('pending-section');
            const completedSection = document.getElementById('completed-section');
            const noDataMessage = document.getElementById('no-data-message');

            if (allSellerSamples.length === 0) {
                noDataMessage.classList.remove('hidden');
                pendingSection.classList.add('hidden');
                completedSection.classList.add('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            const pendingSamples = allSellerSamples.filter(s => s.finalizedByVendor !== true && !s.writtenOff);
            const completedSamples = allSellerSamples.filter(s => s.finalizedByVendor === true || s.writtenOff);

            renderOrderCards(pendingSamples, pendingContainer, true);
            renderOrderCards(completedSamples, completedContainer, false);

            if (pendingSamples.length > 0) pendingSection.classList.remove('hidden');
            else pendingSection.classList.add('hidden');

            if (completedSamples.length > 0) completedSection.classList.remove('hidden');
            else completedSection.classList.add('hidden');
        }

        function renderOrderCards(samples, container, isPendingSection) {
            container.innerHTML = '';
            
            const grouped = samples.reduce((acc, sample) => {
                const key = sample.pedido || 'Sem Pedido';
                if (!acc[key]) acc[key] = { ...sample, items: [] };
                acc[key].items.push(sample);
                return acc;
            }, {});

            const sortedKeys = Object.keys(grouped).sort((a, b) => (parseInt(a)||0) - (parseInt(b)||0));

            sortedKeys.forEach(orderId => {
                const group = grouped[orderId];
                const allAnsweredInGroup = group.items.every(item => item.isPending === false);
                
                // --- BORDINHAS (Borders) ---
                let borderClass = 'border-l-4 ';
                if (isPendingSection) {
                    borderClass += allAnsweredInGroup ? 'border-green-500' : 'border-yellow-400';
                } else {
                    const hasWrittenOff = group.items.some(i => i.writtenOff);
                    borderClass += hasWrittenOff ? 'border-purple-300' : 'border-green-500 opacity-80';
                }

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-sm ${borderClass} overflow-hidden mb-4`;
                
                card.innerHTML = `
                    <div class="p-3 bg-white border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800"><span class="text-slate-400">#</span>${orderId}</h3>
                            <p class="text-xs text-slate-500 font-bold">${group.razaoSocial || 'Cliente'}</p>
                        </div>
                        ${isPendingSection && allAnsweredInGroup ? '<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded animate-pulse">Pronto p/ Enviar</span>' : ''}
                        ${!isPendingSection && !group.items.some(i=>i.writtenOff) ? '<span class="text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded">Enviado</span>' : ''}
                    </div>
                    <div class="overflow-x-auto custom-scrollbar bg-slate-50/50">
                        <table class="w-full text-left border-collapse modern-table">
                            <thead>
                                <tr>
                                    <th class="p-3 pl-4">Produto</th>
                                    <th class="p-3 min-w-[200px]">Descri√ß√£o</th>
                                    <th class="p-3">Qtde</th>
                                    <th class="p-3">NF</th>
                                    <th class="p-3">Emiss√£o NF</th>
                                    <th class="p-3">Feedback</th>
                                    <th class="p-3 text-right">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${group.items.map(item => {
                                    const isWrittenOff = item.writtenOff === true;
                                    const rowClass = isWrittenOff ? 'row-written-off' : '';
                                    const statusText = isWrittenOff ? 'BAIXADO' : (item.isPending !== false ? 'Pendente' : 'Respondido');
                                    
                                    // Robust Date Check
                                    const rawDate = item.emissao || item.dataEmissao || item.emissaoNF || item.dtEmissao;
                                    const emissionDate = formatDate(rawDate);
                                    
                                    let btnHtml = '';
                                    if(isWrittenOff) {
                                        btnHtml = `<span class="text-xs font-bold text-purple-600">üîí</span>`;
                                    } else {
                                        const btnStyle = item.isPending !== false 
                                            ? 'bg-yellow-50 text-yellow-700 border-yellow-200 hover:bg-yellow-100' // Pendente
                                            : 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100'; // Respondido
                                        
                                        btnHtml = `<button class="text-xs font-bold py-1.5 px-3 rounded-lg border ${btnStyle}" onclick="window.openFeedback('${item.id}')">${item.isPending !== false ? 'Responder' : 'Editar'}</button>`;
                                    }

                                    return `
                                    <tr class="${rowClass}">
                                        <td class="p-3 pl-4 whitespace-nowrap">
                                            <div class="font-medium text-slate-700 text-sm">${item.produto}</div>
                                        </td>
                                        <td class="p-3 whitespace-normal">
                                            <div class="text-xs text-slate-500 leading-relaxed">${item.descricao || ''}</div>
                                        </td>
                                        <td class="p-3 text-xs text-slate-500">${item.qtde || ''}</td>
                                        <td class="p-3 text-xs text-slate-500">${item.notaFiscal || ''}</td>
                                        <td class="p-3 text-xs text-slate-500">${emissionDate}</td>
                                        <td class="p-3">
                                            <div class="text-xs font-semibold ${isWrittenOff ? 'text-purple-700' : 'text-slate-700'}">${item.feedback || statusText}</div>
                                            <div class="text-[10px] text-slate-400 italic">${item.observation || ''}</div>
                                        </td>
                                        <td class="p-3 text-right">${btnHtml}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${isPendingSection && allAnsweredInGroup ? `
                        <div class="p-3 bg-green-50 flex justify-end">
                            <button class="bg-green-600 text-white text-sm font-bold py-2 px-6 rounded-lg shadow hover:bg-green-700 signal-btn transition-transform transform active:scale-95" data-order="${orderId}">
                                Enviar Pedido
                            </button>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });

            container.querySelectorAll('.signal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => signalManager(e.target.dataset.order));
            });
        }

        // --- Interaction Logic ---
        
        window.openFeedback = (id) => {
            const sample = allSellerSamples.find(s => s.id === id);
            if (!sample) return;
            
            currentSample = sample;
            selectedFeedback = sample.feedback || null;
            observationInput.value = sample.observation || '';
            personalNoteInput.value = sample.personalNote || '';
            
            modalTitle.textContent = sample.isPending !== false ? 'Novo Feedback' : 'Editar Feedback';
            modalSampleInfo.textContent = `${sample.produto}`;
            
            feedbackOptionsContainer.innerHTML = '';
            FEEDBACK_CHOICES.forEach(choice => {
                const btn = document.createElement('button');
                btn.textContent = choice;
                btn.className = `p-2 rounded text-[11px] font-bold border text-left transition-all ${selectedFeedback === choice ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`;
                btn.onclick = () => {
                    selectedFeedback = choice;
                    Array.from(feedbackOptionsContainer.children).forEach(b => {
                        b.className = `p-2 rounded text-[11px] font-bold border text-left transition-all ${b.textContent === choice ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`;
                    });
                };
                feedbackOptionsContainer.appendChild(btn);
            });

            feedbackModal.classList.remove('hidden');
        };

        saveFeedbackBtn.addEventListener('click', async () => {
            if (!selectedFeedback || !observationInput.value.trim()) {
                showAlert("Selecione um feedback e preencha a observa√ß√£o.");
                return;
            }

            saveFeedbackBtn.disabled = true;
            saveFeedbackBtn.textContent = 'Salvando...';

            try {
                // Fetch fresh data
                const sellerSnap = await getDoc(currentSellerDocRef);
                const sellerData = sellerSnap.data();
                let samples = sellerData.amostras || [];
                
                // Find item by ID or Content (Robustness)
                let index = samples.findIndex(s => s.id === currentSample.id);
                
                // Fallback: If ID mismatch (e.g. legacy data), try matching key fields
                if (index === -1) {
                    index = samples.findIndex(s => 
                        s.pedido == currentSample.pedido && 
                        s.produto == currentSample.produto &&
                        s.codigo == currentSample.codigo
                    );
                }
                
                if (index > -1) {
                    // Preserve ID if it exists, else use the one from memory
                    const existingId = samples[index].id || currentSample.id;
                    
                    samples[index] = {
                        ...samples[index],
                        id: existingId,
                        feedback: selectedFeedback,
                        observation: observationInput.value.trim(),
                        personalNote: personalNoteInput.value.trim(),
                        isPending: false,
                        lastUpdate: new Date(),
                        editedAfterCompletion: true
                    };
                    
                    await updateDoc(currentSellerDocRef, { amostras: samples });
                    feedbackModal.classList.add('hidden');
                    
                    const remaining = samples.filter(s => s.finalizedByVendor !== true && s.isPending !== false && !s.writtenOff).length;
                    if (remaining === 0) {
                        triggerThankYou();
                    }

                } else {
                    showAlert("Erro: Item n√£o encontrado no banco de dados.");
                }
            } catch (error) {
                console.error(error);
                showAlert("Erro ao salvar.");
            } finally {
                saveFeedbackBtn.disabled = false;
                saveFeedbackBtn.textContent = 'Salvar Feedback';
            }
        });

        async function signalManager(orderId) {
            try {
                const sellerSnap = await getDoc(currentSellerDocRef);
                let samples = sellerSnap.data().amostras || [];
                let updated = false;
                
                samples = samples.map(s => {
                    if (s.pedido == orderId && s.finalizedByVendor !== true) {
                        updated = true;
                        return { ...s, finalizedByVendor: true };
                    }
                    return s;
                });
                
                if (updated) {
                    await updateDoc(currentSellerDocRef, { amostras: samples });
                    fireConfetti();
                }
            } catch (e) { showAlert("Erro ao enviar."); }
        }

        // --- ADMIN SYSTEM ---

        adminLoginBtn.addEventListener('click', () => {
            adminPasswordInput.value = '';
            adminLoginModal.classList.remove('hidden');
        });

        cancelAdminBtn.addEventListener('click', () => adminLoginModal.classList.add('hidden'));

        confirmAdminBtn.addEventListener('click', () => {
            const pass = adminPasswordInput.value;
            if (pass === 'admin2025' || pass === 'doremus') { 
                adminLoginModal.classList.add('hidden');
                renderAdminView();
                adminPanelModal.classList.remove('hidden');
            } else {
                alert("Senha incorreta");
            }
        });

        closeAdminPanelBtn.addEventListener('click', () => adminPanelModal.classList.add('hidden'));

        function renderAdminView() {
            adminItemsList.innerHTML = '';
            
            allSellerSamples.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.writtenOff ? 'row-written-off' : 'hover:bg-slate-50';
                
                // Robust Date Check
                const rawDate = item.emissao || item.dataEmissao || item.emissaoNF || item.dtEmissao;
                const emissionDate = formatDate(rawDate);

                tr.innerHTML = `
                    <td>${item.pedido || ''}</td>
                    <td>${item.razaoSocial || ''}</td>
                    <td>${item.produto || ''}</td>
                    <td class="w-1/4 min-w-[200px] whitespace-normal text-xs leading-relaxed" title="${item.descricao || ''}">${item.descricao || ''}</td>
                    <td>${item.qtde || ''}</td>
                    <td>${item.notaFiscal || ''}</td>
                    <td>${emissionDate}</td>
                    <td class="max-w-[150px] truncate" title="${item.feedback || ''}">${item.feedback || '-'}</td>
                    <td class="text-right whitespace-nowrap">
                        ${!item.writtenOff ? `
                            <button class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded hover:bg-yellow-200 mr-1" onclick="window.adminAction('${item.id}', 'revert')">
                                Reverter
                            </button>
                            <button class="bg-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded hover:bg-purple-700" onclick="window.adminAction('${item.id}', 'writeoff')">
                                Baixar
                            </button>
                        ` : `
                            <span class="text-[10px] font-bold text-purple-600 mr-2">BAIXADO</span>
                            <button class="text-xs text-red-400 hover:text-red-600 underline" onclick="window.adminAction('${item.id}', 'undo_writeoff')">X</button>
                        `}
                    </td>
                `;
                adminItemsList.appendChild(tr);
            });
        }

        // --- FIXED ADMIN ACTIONS (Robust Search) ---
        window.adminAction = async (id, action) => {
            // Find the item in MEMORY to get search keys in case ID is missing in DB
            const memoryItem = allSellerSamples.find(s => s.id === id);
            if (!memoryItem) return alert("Erro: Item n√£o carregado na mem√≥ria. Tente recarregar.");

            const confirmMsg = action === 'revert' ? "Reverter para pendente?" : (action === 'writeoff' ? "Dar Baixa (Roxo)?" : "Desfazer baixa?");
            if(!confirm(confirmMsg)) return;

            try {
                const sellerSnap = await getDoc(currentSellerDocRef);
                const sellerData = sellerSnap.data();
                let samples = sellerData.amostras || [];
                
                // 1. Try finding by ID first
                let idx = samples.findIndex(s => s.id === id);
                
                // 2. If not found by ID, try finding by Content Composite Key (STRONGER MATCH)
                if (idx === -1) {
                    // Convert everything to strings to compare safely
                    idx = samples.findIndex(s => 
                        String(s.pedido) === String(memoryItem.pedido) && 
                        String(s.produto) === String(memoryItem.produto) && 
                        String(s.codigo) === String(memoryItem.codigo)
                    );
                }

                // 3. Fallback: If code fails, try without code but with order/product
                if (idx === -1) {
                     idx = samples.findIndex(s => 
                        String(s.pedido) === String(memoryItem.pedido) && 
                        String(s.produto) === String(memoryItem.produto)
                    );
                }

                if(idx > -1) {
                    // Force the valid ID onto the DB item so future searches work
                    samples[idx].id = id; 

                    if (action === 'revert') {
                        samples[idx] = { 
                            ...samples[idx], 
                            isPending: true, 
                            finalizedByVendor: false, 
                            writtenOff: false, 
                            feedback: null, 
                            observation: null,
                            editedAfterCompletion: false
                        };
                    } else if (action === 'writeoff') {
                        samples[idx] = { 
                            ...samples[idx], 
                            writtenOff: true, 
                            isPending: false, 
                            finalizedByVendor: true 
                        }; 
                    } else if (action === 'undo_writeoff') {
                        samples[idx] = { ...samples[idx], writtenOff: false };
                    }

                    await updateDoc(currentSellerDocRef, { amostras: samples });
                    // UI updates automatically via snapshot listener
                    alert("A√ß√£o realizada com sucesso!");
                } else {
                    alert("Erro cr√≠tico: Item n√£o encontrado no banco de dados para atualiza√ß√£o.");
                    console.log("Memory Item:", memoryItem);
                    console.log("Samples in DB:", samples);
                }
            } catch(e) { 
                console.error(e);
                alert("Erro ao executar a√ß√£o administrativa: " + e.message); 
            }
        };

        // --- Notification Logic ---
        function listenForSellerNotifications() {
            if(notificationListenerUnsubscribe) notificationListenerUnsubscribe();
            const q = query(collection(db, "sessoes", currentSessionId, "notificacoesVendedor"), where("sellerName", "==", currentSellerOriginalName));
            notificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                sellerNotifications = snapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
                const unread = sellerNotifications.filter(n => !n.read).length;
                sellerNotificationCount.textContent = unread;
                sellerNotificationCount.classList.toggle('hidden', unread === 0);
            });
        }
        sellerNotificationBtn.addEventListener('click', () => {
            sellerNotificationsList.innerHTML = sellerNotifications.length ? '' : '<p class="text-center text-gray-400 py-4">Sem notifica√ß√µes.</p>';
            sellerNotifications.forEach(n => {
                const d = document.createElement('div');
                d.className = `p-4 rounded-xl border mb-2 ${n.read ? 'bg-white' : 'bg-blue-50 border-blue-100'}`;
                d.innerHTML = `<div class="font-bold text-sm text-slate-700">${n.managerName}</div><div class="text-sm italic my-1">"${n.replyMessage}"</div>
                ${!n.read ? `<button class="text-xs text-blue-600 font-bold mt-2" onclick="window.openReply('${n.id}')">Responder</button>` : ''}`;
                sellerNotificationsList.appendChild(d);
            });
            sellerNotificationsModal.classList.remove('hidden');
        });
        window.openReply = (id) => {
            const n = sellerNotifications.find(x => x.id === id);
            currentNotificationForReply = n;
            sellerReplyContext.textContent = `${n.produto}`;
            sellerReplyOriginalMsg.textContent = `"${n.replyMessage}"`;
            sellerNotificationsModal.classList.add('hidden');
            sellerReplyModal.classList.remove('hidden');
        };
        sendSellerReplyBtn.addEventListener('click', async () => {
            if(!sellerReplyMessageInput.value.trim()) return;
            try {
                await updateDoc(doc(db, "sessoes", currentSessionId, "notificacoesVendedor", currentNotificationForReply.id), { read: true, sellerReplyMessage: sellerReplyMessageInput.value });
                await addDoc(collection(db, "sessoes", currentSessionId, "respostasVendedor"), {
                    sellerName: currentSellerOriginalName, replyMessage: sellerReplyMessageInput.value,
                    originalManagerMessage: currentNotificationForReply.replyMessage,
                    produto: currentNotificationForReply.produto, timestamp: serverTimestamp(), readByManager: false
                });
                sellerReplyModal.classList.add('hidden');
                showAlert("Resposta enviada!", "Sucesso");
            } catch(e) { console.error(e); }
        });

        cancelSellerReplyBtn.addEventListener('click', () => sellerReplyModal.classList.add('hidden'));
        closeSellerNotificationsBtn.addEventListener('click', () => sellerNotificationsModal.classList.add('hidden'));
        cancelFeedbackModalBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
        
        loadDataBtn.addEventListener('click', attemptLogin);
        logoutBtn.addEventListener('click', () => { localStorage.clear(); location.reload(); });
        refreshBtn.addEventListener('click', () => { loadingState.classList.remove('hidden'); startRealtimeListeners(); });

        (async () => {
            await signInAnonymously(auth);
            const saved = localStorage.getItem('sellerCodeV15');
            if(saved) { document.getElementById('access-code-input').value = saved; attemptLogin(); }
            else accessView.classList.remove('hidden');
        })();

    </script>
</body>
</html>













































