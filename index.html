<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela do Vendedor (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease; }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            padding: 2px 5px;
            border-radius: 50%;
            background: red;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }
        .seller-notification-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .seller-notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .seller-notification-item blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 0.75rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-style: italic;
            color: #4b5563;
        }
        .manager-reply, .seller-reply {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .manager-reply {
            background-color: #f3f4f6;
            border-left: 3px solid #9ca3af;
        }
         .seller-reply {
            background-color: #f0f9ff;
            border-left: 3px solid #60a5fa;
            margin-left: 1rem;
        }
        .status-dot {
            display: inline-block;
            width: 0.6rem;
            height: 0.6rem;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .dot-yellow { background-color: #facc15; }
        .dot-green { background-color: #4ade80; }

        /* Estilo para bot√£o de carregamento */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            margin-top: -10px;
            margin-left: -10px;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Access View -->
    <div id="access-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-md p-8 text-center">
            <div class="mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-20 w-20 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Ol√°, vendedor(a) Doremus! (v2)</h1>
                <p class="text-gray-600 mt-2">Este √© o seu painel de feedbacks de amostras.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="seller-name-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">O seu Nome de Vendedor</label>
                    <!-- CORRE√á√ÉO: Removido o exemplo do placeholder -->
                    <input type="text" id="seller-name-input" placeholder="Escreva seu nome" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">C√≥digo de Acesso</label>
                    <input type="text" id="access-code-input" placeholder="Insira o c√≥digo de 6 d√≠gitos" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
            </div>
            <button id="load-data-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">Aceder Amostras</button>
            <p id="access-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            <p class="text-xs text-gray-400 mt-8">Doremus, 2025 (v2)</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden flex flex-col items-center justify-center min-h-screen text-center p-4">
        <h1 id="loading-message" class="text-2xl font-bold text-gray-700">A carregar...</h1>
        <p id="loading-submessage" class="text-gray-600 mt-2">A procurar a sess√£o ativa e os seus dados...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl">
             <header class="mb-8 text-center relative flex justify-between items-start">
                 <div>
                     <h1 id="welcome-title" class="text-3xl font-bold text-gray-800 text-left">Ol√°!</h1>
                     <p class="text-gray-600 mt-2 text-left">Este √© o seu painel para gest√£o de feedbacks de amostras.</p>
                 </div>
                 <div class="flex items-center gap-4">
                     <div class="relative flex flex-col items-center">
                         <button id="seller-notification-btn" class="relative text-gray-500 hover:text-gray-700" title="Ver respostas do gestor">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                             <span id="seller-notification-count" class="notification-badge hidden">0</span>
                         </button>
                         <p id="notification-prompt" class="hidden text-xs text-blue-600 font-semibold animate-pulse">‚Üì Verificar</p>
                     </div>
                     <button id="logout-btn" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg text-sm hover:bg-red-600 transition-colors h-fit">Sair</button>
                 </div>
            </header>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-200">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Como Funciona?</h3>
                    <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <li>Expanda um pedido para ver as amostras (indicadas por <span class="status-dot dot-yellow"></span> Pendente ou <span class="status-dot dot-green"></span> Respondido).</li>
                        <li>Clique em <strong>"Atualizar"</strong> na amostra desejada (ou "Editar" se j√° respondeu).</li>
                        <li>Selecione uma op√ß√£o de feedback e escreva a observa√ß√£o.</li>
                        <li>Quando todas as amostras de um pedido forem respondidas (todas <span class="status-dot dot-green"></span>), clique em <strong>"Sinalizar Gestor"</strong> para o notificar.</li>
                        <li>Verifique as respostas do gestor clicando no <strong class="text-blue-600">sino üîî</strong>.</li>
                    </ol>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">D√∫vidas?</h3>
                    <p class="text-sm text-gray-600">Se encontrar algum problema ou tiver alguma quest√£o sobre o preenchimento, n√£o hesite em me contatar.</p>
                    <p class="text-sm text-gray-600 mt-2">Pode me chamar no <strong>chat</strong> ou enviar um <strong>e-mail</strong>.</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-800">Thamiris Bezerra</p>
                        <p class="text-sm text-gray-600">thamiris.bezerra@doremus.com.br</p>
                    </div>
                </div>
            </div>

            <div id="pending-section" class="hidden">
                <h2 id="pending-orders-count" class="text-2xl font-bold text-gray-800 mb-4">Pedidos Pendentes</h2>
                <div id="pending-orders-list" class="space-y-4"></div>
            </div>

            <div id="completed-section" class="mt-12 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Conclu√≠dos e Sinalizados</h2>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>

            <div id="no-data-message" class="hidden text-center bg-white p-8 rounded-2xl shadow-sm border">
                 <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                 <h2 class="mt-4 text-2xl font-bold text-gray-800">Nenhuma amostra encontrada.</h2>
                 <p class="text-gray-600 mt-2">Verifique se os dados de acesso est√£o corretos ou se a sess√£o est√° ativa.</p>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-4 flex-shrink-0" id="modal-title">Atualizar Feedback</h3>
            <p class="text-gray-600 mb-2 flex-shrink-0">Selecione uma das op√ß√µes abaixo para a amostra:</p>
            <p class="font-semibold text-gray-800 mb-6 flex-shrink-0" id="modal-sample-info"></p>

            <div id="feedback-options" class="grid grid-cols-2 gap-3 mb-6 overflow-y-auto">
            </div>

            <div class="flex-shrink-0">
                <label for="observation" class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√£o (Obrigat√≥rio)</label>
                <textarea id="observation" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Justifique o motivo do feedback..."></textarea>
            </div>

            <div class="mt-8 flex justify-end space-x-3 flex-shrink-0">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="save-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

     <!-- Seller Notifications Modal (Added z-30) -->
     <div id="seller-notifications-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
             <div class="flex justify-between items-center mb-4 border-b pb-2">
                  <h3 class="text-xl font-bold">Respostas do Gestor</h3>
                  <button id="close-seller-notifications-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
             </div>
             <div id="seller-notifications-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                  <p class="text-gray-500">Nenhuma resposta recebida.</p>
             </div>
              <div class="mt-6 flex justify-end">
                   <button id="close-seller-notifications-btn-bottom" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
              </div>
         </div>
     </div>

     <!-- Seller Reply Modal (NEW - Added z-40) -->
     <div id="seller-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
             <h3 class="text-xl font-bold mb-4">Responder ao Gestor</h3>
             <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                 <p id="seller-reply-context" class="text-gray-600"></p>
                 <p id="seller-reply-original-msg" class="font-semibold italic"></p>
             </div>
             <div class="space-y-4">
                  <div>
                       <label for="seller-reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta</label>
                       <textarea id="seller-reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta..."></textarea>
                  </div>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-seller-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-seller-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
             </div>
         </div>
     </div>

    <!-- Custom Alert/Modal for errors -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Opera√ß√£o</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro. Tente novamente.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, setDoc, 
            serverTimestamp, query, where, writeBatch, limit, addDoc, Timestamp, runTransaction, 
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            // CORRE√á√ÉO: Adicionado o '8' que faltava
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Op√ß√µes de Feedback
        const FEEDBACK_CHOICES = [
            'A - COM PEDIDO', 'A - APROVADA SEM PEDIDO', 'P - AMOSTRA N√ÉO TESTADA', 'P - EM AN√ÅLISE', 
            'P - AMOSTRA SEM FEEDBACK', 'R - APRESENTA√á√ÉO PR√ì ATIVA', 'R - CALIBRE', 'R - EXTRAVIADA', 
            'R - FORA DA ESPECIFICA√á√ÉO DO CLIENTE', 'R - FORA DO PERFIL DO CLIENTE', 
            'R - FRACA / ESTOURANDO / COM CHUVEIRO', 'R - PRODUTO DESCONTINUADO', 'R - QUANTIDADE INSUFICIENTE', 
            'R - REPRESENTA√á√ÉO / DISTRIBUIDOR', 'R - SEM RETORNO DO CLIENTE', 'E - INNOVATION / EVENTOS', 
            'E - EVENTO', 'R - EXPORTACAO'
        ];

        // --- Elementos DOM ---
        const accessView = document.getElementById('access-view');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const loadingSubmessage = document.getElementById('loading-submessage');
        const mainContent = document.getElementById('main-content');
        const loadDataBtn = document.getElementById('load-data-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const accessError = document.getElementById('access-error');
        const noDataMessage = document.getElementById('no-data-message');
        const welcomeTitle = document.getElementById('welcome-title');
        const sellerNotificationBtn = document.getElementById('seller-notification-btn');
        const sellerNotificationCount = document.getElementById('seller-notification-count');
        const sellerNotificationsModal = document.getElementById('seller-notifications-modal');
        const sellerNotificationsList = document.getElementById('seller-notifications-list');
        const closeSellerNotificationsBtn = document.getElementById('close-seller-notifications-btn');
        const closeSellerNotificationsBtnBottom = document.getElementById('close-seller-notifications-btn-bottom');
        const notificationPrompt = document.getElementById('notification-prompt');
        const sellerReplyModal = document.getElementById('seller-reply-modal');
        const sellerReplyContext = document.getElementById('seller-reply-context');
        const sellerReplyOriginalMsg = document.getElementById('seller-reply-original-msg');
        const sellerReplyMessageInput = document.getElementById('seller-reply-message-input');
        const cancelSellerReplyBtn = document.getElementById('cancel-seller-reply-btn');
        const sendSellerReplyBtn = document.getElementById('send-seller-reply-btn');
        let currentNotificationForReply = null;
        const feedbackModal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSampleInfo = document.getElementById('modal-sample-info');
        const feedbackOptionsContainer = document.getElementById('feedback-options');
        const observationInput = document.getElementById('observation');
        const cancelFeedbackModalBtn = document.getElementById('cancel-modal-btn');
        const saveFeedbackBtn = document.getElementById('save-button');
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Vari√°veis de Estado ---
        let currentSample = null;
        let selectedFeedback = null;
        let currentSellerDocRef = null; // Ref para /sessoes/{sid}/vendedores/{vid}
        let allSellerSamples = [];
        let unsubscribeSamples = null;
        let sellerNotificationListenerUnsubscribe = null;
        let currentSessionId = null;
        let currentSellerId = null; // Nome higienizado do vendedor
        let currentSellerOriginalName = null;
        let sellerNotifications = [];

        // --- Fun√ß√µes Utilit√°rias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';
        const sanitizeForFirebaseId = (text) => normalizeText(text).replace(/\//g, "-");

        // Alerta customizado
        function showAlert(message, title = "Erro na Opera√ß√£o", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; // Usar innerHTML para o <br>
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        // Tratamento de erros do Firestore
        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `N√£o foi poss√≠vel completar a opera√ß√£o: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Opera√ß√£o";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite di√°rio de uso do banco de dados foi atingido (Quota Exceeded). Novas altera√ß√µes n√£o ser√£o salvas hoje.<br><br>Por favor, tente novamente amanh√£.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            }
            showAlert(message, title, color);
        }

        // --- Autentica√ß√£o e Carregamento de Dados (v2) ---
        
        // Busca a sess√£o ativa
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Erro ao buscar sess√£o ativa:", error);
                return null;
            }
        }

        // Tenta fazer login
        async function attemptLogin(sellerName, accessCode, isAutoLogin = false) {
            if (!sellerName || !accessCode) {
                if (!isAutoLogin) accessError.textContent = 'Nome e C√≥digo s√£o obrigat√≥rios.';
                return false;
            }

            loadingState.classList.remove('hidden');
            loadingSubmessage.textContent = "A procurar sess√£o ativa...";
            accessView.classList.add('hidden');

            // 1. Encontra a sess√£o ativa (ex: sessao_v2_...)
            currentSessionId = await getActiveSessionId();
            if (!currentSessionId) {
                loadingState.classList.add('hidden');
                accessView.classList.remove('hidden');
                accessError.textContent = 'Nenhuma sess√£o de feedback ativa encontrada. Contate o gestor.';
                return false;
            }
            
            loadingSubmessage.textContent = `Sess√£o encontrada. A verificar credenciais...`;

            // 2. Prepara os IDs do vendedor
            currentSellerId = sanitizeForFirebaseId(sellerName);
            currentSellerOriginalName = sellerName;

            try {
                // 3. Tenta aceder ao documento do vendedor
                const docRef = doc(db, "sessoes", currentSessionId, "vendedores", currentSellerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().accessCode === accessCode) {
                    // Sucesso!
                    currentSellerDocRef = docRef;
                    const sellerData = docSnap.data();
                    welcomeTitle.textContent = `Ol√°, ${sellerData.originalName}!`;
                    currentSellerOriginalName = sellerData.originalName;

                    if (!isAutoLogin) {
                        localStorage.setItem('sellerName_v2', currentSellerOriginalName);
                        localStorage.setItem('sellerAccessCode_v2', accessCode);
                    }

                    accessError.textContent = '';
                    loadingMessage.textContent = 'A carregar as suas amostras...';
                    loadingSubmessage.textContent = '';

                    requestNotificationPermission();
                    startRealtimeListener(); // Ouve a sub-cole√ß√£o 'amostras'
                    listenForSellerNotifications(); // Ouve notifica√ß√µes
                    return true;
                } else {
                    // Falha no login
                    if (isAutoLogin) {
                        localStorage.clear();
                    } else if (docSnap.exists()) {
                        accessError.textContent = 'C√≥digo de Acesso inv√°lido. Tente novamente.';
                    } else {
                        accessError.textContent = 'Vendedor n√£o encontrado nesta sess√£o. Verifique o nome.';
                    }
                    loadingState.classList.add('hidden');
                    accessView.classList.remove('hidden');
                    return false;
                }
            } catch (e) {
                // Erro de rede ou outro
                if (!isAutoLogin) accessError.textContent = 'Erro ao conectar. Verifique sua internet.';
                console.error("Erro de autentica√ß√£o ou busca (v2):", e);
                if (isAutoLogin) localStorage.clear();
                loadingState.classList.add('hidden');
                accessView.classList.remove('hidden');
                return false;
            } finally {
                // Re-habilita o bot√£o de login
                if (!isAutoLogin && loadDataBtn) {
                     loadDataBtn.disabled = false;
                     loadDataBtn.textContent = 'Aceder Amostras';
                     loadDataBtn.classList.remove('btn-loading');
                }
            }
        }

        // --- Event Listeners ---
        loadDataBtn.addEventListener('click', () => {
             loadDataBtn.disabled = true;
             loadDataBtn.textContent = 'A verificar...';
             loadDataBtn.classList.add('btn-loading');
             
            const sellerName = document.getElementById('seller-name-input').value.trim();
            const accessCode = document.getElementById('access-code-input').value.trim();
            attemptLogin(sellerName, accessCode);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('sellerName_v2');
            localStorage.removeItem('sellerAccessCode_v2');
            if (unsubscribeSamples) unsubscribeSamples();
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();
            window.location.reload();
        });

        // Listeners dos Modais
        sellerNotificationBtn.addEventListener('click', showSellerNotifications);
        closeSellerNotificationsBtn.addEventListener('click', hideSellerNotifications);
        closeSellerNotificationsBtnBottom.addEventListener('click', hideSellerNotifications);
        cancelSellerReplyBtn.addEventListener('click', () => {
            sellerReplyModal.classList.add('hidden');
            showSellerNotifications();
        });
        sendSellerReplyBtn.addEventListener('click', sendReplyToManager);

        feedbackOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('feedback-choice-btn')) {
                feedbackOptionsContainer.querySelectorAll('.feedback-choice-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedFeedback = e.target.dataset.feedback;
                validateFeedbackForm();
            }
        });
        cancelFeedbackModalBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
        observationInput.addEventListener('input', validateFeedbackForm);
        saveFeedbackBtn.addEventListener('click', saveFeedback);


        // --- Listeners de Dados (v2) ---
        function startRealtimeListener() {
            if (unsubscribeSamples) unsubscribeSamples();
            if (!currentSellerDocRef) {
                 console.error("Seller document reference not set.");
                 loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro.</h1><p class="mt-2">N√£o foi poss√≠vel carregar os dados. Tente fazer login novamente.</p>`;
                 return;
            }
            
            // Ouve a sub-cole√ß√£o 'amostras'
            const samplesQuery = query(
                collection(db, currentSellerDocRef.path, "amostras")
            );

            unsubscribeSamples = onSnapshot(samplesQuery, (snapshot) => {
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');

                allSellerSamples = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (allSellerSamples.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    document.getElementById('pending-section').classList.add('hidden');
                    document.getElementById('completed-section').classList.add('hidden');
                } else {
                    noDataMessage.classList.add('hidden');
                    const pendingSamplesForDisplay = allSellerSamples.filter(s => !s.finalizedByVendor);
                    const completedSamples = allSellerSamples.filter(s => s.finalizedByVendor);

                    renderOrders(pendingSamplesForDisplay, 'pending');
                    renderOrders(completedSamples, 'completed');
                }
            }, (error) => {
                handleFirestoreError(error, `ouvir amostras (sess√£o: ${currentSessionId})`);
                loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro de conex√£o.</h1><p class="mt-2">Tente recarregar a p√°gina.</p>`;
                mainContent.classList.add('hidden');
            });
        }

        // Ouve notifica√ß√µes para este vendedor
        function listenForSellerNotifications() {
            if (!currentSessionId || !currentSellerOriginalName) {
                console.warn("N√£o √© poss√≠vel ouvir notifica√ß√µes: Sess√£o ou Nome do Vendedor em falta.");
                return;
            }
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();

            const q = query(
                collection(db, "sessoes", currentSessionId, "notificacoesVendedor"),
                where("sellerName", "==", currentSellerOriginalName)
            );

            sellerNotificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 const previousUnreadCount = sellerNotifications.filter(n => !n.read).length;
                 sellerNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 sellerNotifications.sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));
                 const currentUnreadCount = sellerNotifications.filter(n => !n.read).length;

                 updateSellerNotificationBadge();

                 // Aciona notifica√ß√£o do navegador se houver novas
                 if (currentUnreadCount > previousUnreadCount && !snapshot.metadata.hasPendingWrites) {
                     snapshot.docChanges().forEach((change) => {
                         if (change.type === "added" && !change.doc.metadata.fromCache) {
                             const newData = change.doc.data();
                             if (!newData.read) {
                                 showBrowserNotification(
                                     `Resposta de ${newData.managerName}`,
                                     `Ref. ${newData.produto} (${newData.pedido}): ${newData.replyMessage}`
                                 );
                             }
                         }
                     });
                 }
            }, (error) => {
                handleFirestoreError(error, "ouvir notifica√ß√µes do vendedor");
            });
        }

        // --- Fun√ß√µes de Renderiza√ß√£o da UI ---
        function renderOrders(samplesToDisplay, type) {
            const isPendingSection = type === 'pending';
            const container = document.getElementById(`${type}-orders-list`);
            const section = document.getElementById(`${type}-section`);

            if (!container || !section) return;

            if (samplesToDisplay.length === 0) {
                section.classList.add('hidden');
                if (isPendingSection) {
                     const countEl = document.getElementById('pending-orders-count');
                     if (countEl) countEl.textContent = `Nenhum Pedido Pendente`;
                 }
                return;
            }

            section.classList.remove('hidden');
            container.innerHTML = '';

            // Agrupa amostras por pedido
            const groupedByOrder = samplesToDisplay.reduce((acc, sample) => {
                const key = sample.pedido;
                if (!acc[key]) acc[key] = { ...sample, samples: [] };
                acc[key].samples.push(sample);
                return acc;
            }, {});

            // Ordena pedidos
             const sortedOrderKeys = Object.keys(groupedByOrder).sort((a, b) => {
                 const numA = parseInt(a, 10);
                 const numB = parseInt(b, 10);
                 if (!isNaN(numA) && !isNaN(numB)) {
                     return numA - numB;
                 }
                 return a.localeCompare(b);
             });

            if (isPendingSection) {
                const countEl = document.getElementById('pending-orders-count');
                 if (countEl) countEl.textContent = `${sortedOrderKeys.length} Pedido(s) ${sortedOrderKeys.length > 1 ? '' : ' '}com Pend√™ncias`;
            }

            // Cria o HTML para cada grupo de pedido
             sortedOrderKeys.forEach(orderId => {
                 const order = groupedByOrder[orderId];
                const orderGroup = document.createElement('div');
                const allSamplesInThisOrderAnswered = order.samples.every(s => !s.isPending);
                const statusColor = isPendingSection ? (allSamplesInThisOrderAnswered ? 'blue' : 'yellow') : 'green';
                orderGroup.className = `bg-white rounded-2xl shadow-sm border-l-4 border-${statusColor}-400 fade-in`;

                // Cria o HTML para as linhas da tabela de amostras
                const samplesTableRowsHTML = order.samples.map(sample => {
                    const qty = parseFloat(String(sample.qtde || '0').replace(',', '.'));
                    let formattedQty = '';
                    if (!isNaN(qty)) {
                        formattedQty = qty >= 1 || qty === 0 ? `${qty.toFixed(3).replace('.', ',')}kg` : `${Math.round(qty * 1000)}g`;
                    } else {
                        formattedQty = sample.qtde || 'N/A';
                    }

                    const feedbackDisplay = sample.isPending
                        ? '<span class="text-yellow-600 font-semibold">Pendente</span>'
                        : `<div>${sample.feedback || 'N/A'}</div><div class='text-gray-500 font-normal text-xs'>${sample.observation || ''}</div>`;

                    const deleteButtonHtml = !sample.isPending && isPendingSection
                        ? `<button class="delete-btn bg-red-100 text-red-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-red-200" data-sample-id='${sample.id}'>Excluir</button>`
                        : '';
                    const updateButtonText = sample.isPending ? 'Atualizar' : 'Editar';
                    
                    const updateButtonHtml = `<button class="update-btn bg-blue-100 text-blue-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-blue-200" data-sample-id='${sample.id}'>${updateButtonText}</button>`;
                    const dotColorClass = sample.isPending ? 'dot-yellow' : 'dot-green';

                    return `
                        <tr class="border-b last:border-b-0">
                            <td class="p-3">
                                <span class="status-dot ${dotColorClass}"></span>
                                <div class="inline-block align-middle">
                                    <p class="font-semibold">${sample.produto}</p>
                                    <p class="text-xs text-gray-500">${sample.descricao || ''}</p>
                                </div>
                            </td>
                            <td class="p-3">${formattedQty}</td>
                            <td class="p-3 hidden md:table-cell">${sample.originalStatus || 'N/A'}</td>
                            <td class="p-3">${feedbackDisplay}</td>
                            <td class="p-3 text-right space-x-2">
                                ${updateButtonHtml}
                                ${deleteButtonHtml}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Monta o card do pedido
                orderGroup.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer order-header">
                        <div>
                            <h3 class="font-bold text-lg flex items-center"><span class="w-3 h-3 bg-${statusColor}-400 rounded-full mr-3"></span>${order.pedido} - ${order.razaoSocial || 'Cliente Desconhecido'}</h3>
                            <p class="text-sm text-gray-500 ml-6">Nota Fiscal: ${order.notaFiscal || 'N/A'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="overflow-x-auto samples-table hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>
                                    <th class="p-3 font-medium text-gray-500">Produto</th>
                                    <th class="p-3 font-medium text-gray-500">Qtde.</th>
                                    <th class="p-3 font-medium text-gray-500 hidden md:table-cell">Status Atual</th>
                                    <th class="p-3 font-medium text-gray-500">Feedback</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody>${samplesTableRowsHTML}</tbody>
                        </table>
                        <!-- Bot√£o de Sinalizar Gestor (se pendente) -->
                        ${isPendingSection && allSamplesInThisOrderAnswered ? `
                        <div class="p-4 border-t text-right bg-blue-50">
                            <p class="text-sm text-gray-700 text-left mb-2">Todas as amostras deste pedido foram respondidas. Clique abaixo para notificar o gestor.</p>
                            <button class="signal-manager-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700" data-order-id="${order.pedido}">Sinalizar Gestor</button>
                        </div>` : ''}
                        <!-- Bot√£o de Reenviar Notifica√ß√£o (se completo) -->
                        ${!isPendingSection ? `
                        <div class="p-3 border-t text-xs text-gray-500 bg-gray-50 flex justify-between items-center">
                             <span>Este pedido j√° foi sinalizado para o gestor.</span>
                             <button class="resend-notification-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg text-xs hover:bg-gray-300" data-order-id="${order.pedido}">Reenviar Notifica√ß√£o</button>
                        </div>` : ''}
                    </div>
                `;

                container.appendChild(orderGroup);
            });

            // Adiciona listeners aos elementos rec√©m-criados
            container.querySelectorAll('.order-header').forEach(header => {
                header.addEventListener('click', () => {
                    const tableDiv = header.nextElementSibling;
                    const arrow = header.querySelector('svg');
                    tableDiv?.classList.toggle('hidden');
                    arrow?.classList.toggle('rotate-180');
                });
            });

             container.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sampleToUpdate = allSellerSamples.find(s => s.id === btn.dataset.sampleId);
                    if (sampleToUpdate) openFeedbackModal(sampleToUpdate);
                });
            });

             container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const sampleId = e.currentTarget.dataset.sampleId;
                    if (!confirm('Tem a certeza de que quer excluir este feedback e voltar a amostra para pendente?')) {
                         return;
                    }
                    e.currentTarget.disabled = true;
                    e.currentTarget.classList.add('btn-loading');
                    
                    const updates = { 
                        isPending: true, 
                        feedback: '', 
                        observation: '', 
                        finalizedByVendor: false, 
                        editedAfterCompletion: false, 
                        lastUpdate: Timestamp.now()
                    };
                    await updateSampleData(sampleId, updates, e.currentTarget);
                });
            });
            
            container.querySelectorAll('.signal-manager-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleSignalManager(e.currentTarget, false));
            });
            
            container.querySelectorAll('.resend-notification-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleSignalManager(e.currentTarget, true));
            });
        }
        
        // Fun√ß√£o para Sinalizar Gestor / Reenviar Notifica√ß√£o (v2)
        async function handleSignalManager(button, isResend) {
            const orderId = button.dataset.orderId;
            const originalText = button.textContent;
            button.disabled = true;
            button.classList.add('btn-loading');
            button.textContent = isResend ? 'A Reenviar...' : 'A Sinalizar...';

            try {
                // 1. (Apenas ao Sinalizar) Atualiza amostras para 'finalizedByVendor: true'
                if (!isResend) {
                    const batch = writeBatch(db);
                    const samplesToUpdate = allSellerSamples.filter(s => s.pedido === orderId && !s.isPending);
                    
                    samplesToUpdate.forEach(sample => {
                        // Refer√™ncia correta ao documento da amostra
                        const sampleRef = doc(db, currentSellerDocRef.path, "amostras", sample.id);
                        batch.update(sampleRef, { finalizedByVendor: true });
                    });
                    await batch.commit();
                    console.log(`Pedido ${orderId} marcado como finalizado pelo vendedor.`);
                }

                // 2. Envia notifica√ß√£o ao gestor
                const sellerName = currentSellerOriginalName;
                const message = isResend 
                    ? `<strong>${sellerName}</strong> reenviou a notifica√ß√£o do pedido: <strong>${orderId}</strong>.`
                    : `<strong>${sellerName}</strong> sinalizou o pedido: <strong>${orderId}</strong> como conclu√≠do.`;
                const color = isResend ? 'blue' : 'purple';
                
                const notifRef = collection(db, "sessoes", currentSessionId, "notificacoes");
                await addDoc(notifRef, {
                    message,
                    color: color,
                    timestamp: serverTimestamp(),
                    triggerPopup: isResend
                });

                if(isResend) {
                    button.textContent = 'Reenviado!';
                }
                
                setTimeout(() => {
                    if (isResend) {
                        button.disabled = false;
                        button.classList.remove('btn-loading');
                        button.textContent = originalText;
                    }
                }, 2000);

            } catch(error) {
                handleFirestoreError(error, `sinalizar gestor (pedido: ${orderId})`);
                button.disabled = false;
                button.classList.remove('btn-loading');
                button.textContent = originalText;
            }
        }


        // --- Fun√ß√µes do Modal de Feedback (v2) ---
        function openFeedbackModal(sample) {
            currentSample = sample;
            selectedFeedback = sample.feedback || null;
            observationInput.value = sample.observation || '';
            modalSampleInfo.textContent = `${sample.produto} - ${sample.descricao || ''}`;
            modalTitle.textContent = sample.isPending ? 'Atualizar Feedback' : 'Editar Feedback';

            feedbackOptionsContainer.innerHTML = '';
            FEEDBACK_CHOICES.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.dataset.feedback = choice;
                button.className = 'feedback-choice-btn border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg hover:bg-gray-100 transition-all';
                if (choice === selectedFeedback) button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                feedbackOptionsContainer.appendChild(button);
            });

            validateFeedbackForm();
            feedbackModal.classList.remove('hidden');
        }

        // Valida o formul√°rio
        function validateFeedbackForm() {
             saveFeedbackBtn.disabled = !observationInput.value.trim() || !selectedFeedback;
        }

        // Salva o feedback
        async function saveFeedback() {
            if (saveFeedbackBtn.disabled) return;
            
            saveFeedbackBtn.disabled = true;
            saveFeedbackBtn.classList.add('btn-loading');
            saveFeedbackBtn.textContent = 'A guardar...';

            // Verifica se √© uma edi√ß√£o
             const isEditing = !currentSample.isPending;
             const oldFeedback = currentSample.feedback;
             const oldObservation = currentSample.observation;
             const newFeedback = selectedFeedback;
             const newObservation = observationInput.value.trim();
             const wasEdited = isEditing && (oldFeedback !== newFeedback || oldObservation !== newObservation);

            // Prepara os dados para atualiza√ß√£o
            const updates = {
                isPending: false,
                feedback: newFeedback,
                observation: newObservation,
                editedAfterCompletion: wasEdited,
                lastUpdate: Timestamp.now()
            };

            // Atualiza a amostra individual
            await updateSampleData(currentSample.id, updates, saveFeedbackBtn);
            
            feedbackModal.classList.add('hidden'); // Fecha o modal

            // Envia notifica√ß√£o ao gestor SE for uma edi√ß√£o
            if (wasEdited) {
                try {
                    const sellerName = currentSellerOriginalName;
                    const message = `<strong>${sellerName}</strong> <i>editou</i> o feedback para <strong>${currentSample.produto}</strong> (Pedido ${currentSample.pedido}): ${newFeedback}`;
                    const notifRef = collection(db, "sessoes", currentSessionId, "notificacoes");
                    await addDoc(notifRef, {
                        message,
                        color: 'orange',
                        timestamp: serverTimestamp(),
                        triggerPopup: true
                    });
                    console.log("Notifica√ß√£o de edi√ß√£o enviada.");
                } catch (notifError) {
                    console.error("Erro ao enviar notifica√ß√£o de edi√ß√£o:", notifError);
                }
            }
        }

        // Fun√ß√£o de atualiza√ß√£o de amostra individual (v2)
        async function updateSampleData(sampleId, updates, buttonToReset = null) {
            if (!currentSellerDocRef) {
                console.error("Refer√™ncia do vendedor n√£o definida.");
                showAlert("Erro: N√£o foi poss√≠vel encontrar a refer√™ncia do vendedor. Tente recarregar a p√°gina.");
                return;
            }

            // Refer√™ncia correta ao documento da amostra
            const sampleRef = doc(db, currentSellerDocRef.path, "amostras", sampleId);
            
            try {
                await updateDoc(sampleRef, updates);
                console.log(`Amostra ${sampleId} atualizada.`);
            } catch (error) {
                handleFirestoreError(error, `guardar feedback (amostra: ${sampleId})`);
            } finally {
                // Re-ativa o bot√£o, quer tenha sucesso ou falhe
                if (buttonToReset) {
                    buttonToReset.disabled = false;
                    buttonToReset.classList.remove('btn-loading');
                    if(buttonToReset.id === 'save-button') buttonToReset.textContent = 'Salvar';
                    if(buttonToReset.classList.contains('delete-btn')) buttonToReset.textContent = 'Excluir';
                }
            }
        }


        // --- Fun√ß√µes de Notifica√ß√£o do Vendedor (v2) ---

        // Atualiza o crach√° do sino
        function updateSellerNotificationBadge() {
             if(!sellerNotificationCount || !notificationPrompt) return;
            const unreadCount = sellerNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                sellerNotificationCount.textContent = unreadCount;
                sellerNotificationCount.classList.remove('hidden');
                notificationPrompt.classList.remove('hidden');
            } else {
                sellerNotificationCount.classList.add('hidden');
                notificationPrompt.classList.add('hidden');
            }
        }

        // Mostra o modal de notifica√ß√µes
        function showSellerNotifications() {
            sellerNotificationsList.innerHTML = '';
            if (sellerNotifications.length === 0) {
                 sellerNotificationsList.innerHTML = '<p class="text-gray-500">Nenhuma resposta recebida.</p>';
            } else {
                 sellerNotifications.forEach(notif => {
                     const itemDiv = document.createElement('div');
                     const hasSellerReply = notif.sellerReplyMessage && notif.sellerReplyMessage.trim() !== '';

                     const replyButtonHtml = `<button class="seller-reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">
                                                  ${hasSellerReply ? 'Ver/Responder' : 'Responder'}
                                             </button>`;
                     const readButtonHtml = !notif.read
                         ? `<button class="mark-as-read-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">‚úì Marcar como Lida</button>`
                         : `<span class="text-green-500 text-xs font-semibold ml-2">‚úì Lida</span>`;

                     itemDiv.className = `seller-notification-item text-sm ${!notif.read ? 'font-semibold bg-blue-50 p-2 rounded' : 'text-gray-600 p-2'}`;
                     itemDiv.innerHTML = `
                         <p class="mb-1">
                             <span class="font-bold">${notif.managerName}</span> respondeu sobre:
                         </p>
                         <div class="mb-2 p-2 bg-gray-100 rounded border text-xs">
                             <p><strong>Cliente:</strong> ${notif.razaoSocial || 'N/A'}</p>
                             <p><strong>Produto:</strong> ${notif.produto || 'N/A'} (${notif.descricao || 'N/A'})</p>
                         </div>
                         
                         <div class="manager-reply">${notif.replyMessage}</div>

                         ${hasSellerReply ? `
                         <div class="seller-reply">
                              <p><strong>Voc√™ respondeu:</strong> ${notif.sellerReplyMessage}</p>
                         </div>` : ''}

                         ${notif.originalObservation ? `<blockquote>Observa√ß√£o Original: "${notif.originalObservation}"</blockquote>` : ''}

                         <div class="flex justify-between items-center mt-2">
                              <p class="text-xs text-gray-400">${notif.timestamp?.toDate() ? notif.timestamp.toDate().toLocaleString('pt-BR') : ''}</p>
                              <div class="flex gap-2">
                                   ${replyButtonHtml}
                                   ${readButtonHtml}
                              </div>
                         </div>
                     `;
                     sellerNotificationsList.appendChild(itemDiv);
                 });

                 sellerNotificationsList.querySelectorAll('.mark-as-read-btn').forEach(btn => {
                     btn.addEventListener('click', markNotificationAsRead);
                 });
                 sellerNotificationsList.querySelectorAll('.seller-reply-btn').forEach(btn => {
                     btn.addEventListener('click', openSellerReplyModal);
                 });
            }
            sellerNotificationsModal.classList.remove('hidden');
            notificationPrompt.classList.add('hidden');
        }

        // Esconde o modal de notifica√ß√µes
        function hideSellerNotifications() {
            sellerNotificationsModal.classList.add('hidden');
        }

        // Marca notifica√ß√£o como lida
        async function markNotificationAsRead(e) {
            const notifId = e.target.dataset.notifId;
            e.target.disabled = true;
            e.target.textContent = 'A marcar...';
            const notifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", notifId);
            try {
                await updateDoc(notifRef, { read: true });
                 const notifIndex = sellerNotifications.findIndex(n => n.id === notifId);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                 }
                 showSellerNotifications();
                 updateSellerNotificationBadge();
            } catch (err) {
                handleFirestoreError(err, "marcar notifica√ß√£o como lida");
                e.target.disabled = false;
                e.target.textContent = '‚úì Marcar como Lida';
            }
        }

        // Abre modal para responder ao gestor
        function openSellerReplyModal(e) {
            const notifId = e.target.dataset.notifId;
            const notification = sellerNotifications.find(n => n.id === notifId);
            if (!notification) return;

            currentNotificationForReply = notification;

            sellerReplyContext.textContent = `Em resposta a ${notification.managerName} (Ref. ${notification.produto}):`;
            sellerReplyOriginalMsg.textContent = `"${notification.replyMessage}"`;
            sellerReplyMessageInput.value = notification.sellerReplyMessage || '';

            sellerNotificationsModal.classList.add('hidden');
            sellerReplyModal.classList.remove('hidden');
        }

        // Envia resposta ao gestor
        async function sendReplyToManager() {
            if (!currentNotificationForReply || !currentSessionId || !currentSellerOriginalName) return;

            const replyMessage = sellerReplyMessageInput.value.trim();
            if (!replyMessage) {
                showAlert("Por favor, escreva a sua resposta.");
                return;
            }

            sendSellerReplyBtn.disabled = true;
            sendSellerReplyBtn.classList.add('btn-loading');
            sendSellerReplyBtn.textContent = 'A Enviar...';

            try {
                // 1. Cria o documento de resposta para o gestor
                const replyDataForManager = {
                    sellerName: currentSellerOriginalName,
                    replyMessage: replyMessage,
                    originalManagerMessage: currentNotificationForReply.replyMessage,
                    originalManagerName: currentNotificationForReply.managerName,
                    pedido: currentNotificationForReply.pedido,
                    produto: currentNotificationForReply.produto,
                    timestamp: serverTimestamp(),
                    readByManager: false
                };
                const managerRepliesRef = collection(db, "sessoes", currentSessionId, "respostasVendedor");
                await addDoc(managerRepliesRef, replyDataForManager);

                // 2. Atualiza a notifica√ß√£o original do vendedor
                const originalNotifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", currentNotificationForReply.id);
                await updateDoc(originalNotifRef, {
                    sellerReplyMessage: replyMessage,
                    read: true
                });

                 // Atualiza UI local
                 const notifIndex = sellerNotifications.findIndex(n => n.id === currentNotificationForReply.id);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                      sellerNotifications[notifIndex].sellerReplyMessage = replyMessage;
                 }
                 updateSellerNotificationBadge();
                 sellerReplyModal.classList.add('hidden');
                 showSellerNotifications();

            } catch (error) {
                handleFirestoreError(error, "enviar resposta ao gestor");
            } finally {
                sendSellerReplyBtn.disabled = false;
                sendSellerReplyBtn.classList.remove('btn-loading');
                sendSellerReplyBtn.textContent = 'Enviar Resposta';
                currentNotificationForReply = null;
            }
        }


        // --- Fun√ß√µes de Notifica√ß√£o do Navegador ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("Este navegador n√£o suporta notifica√ß√µes desktop");
                return;
            }
            if (Notification.permission !== 'denied') {
                 Notification.requestPermission().then(permission => {
                     console.log("Permiss√£o de notifica√ß√£o:", permission);
                 });
            }
        }

        function showBrowserNotification(title, body) {
            if (Notification.permission === 'granted') {
                 if (document.visibilityState === 'visible') {
                      console.log("Tab is active, skipping browser notification.");
                      return;
                 }
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/fluency/96/send-letter.png'
                });
            }
        }


        // --- Carregamento Inicial ---
        async function checkLocalStorage() {
            const savedSellerName = localStorage.getItem('sellerName_v2');
            const savedAccessCode = localStorage.getItem('sellerAccessCode_v2');

            if (savedSellerName && savedAccessCode) {
                 loadingMessage.textContent = 'A verificar sess√£o guardada...';
                 accessView.classList.add('hidden');
                 loadingState.classList.remove('hidden');
                 const loginSuccess = await attemptLogin(savedSellerName, savedAccessCode, true);
                 if (!loginSuccess) {
                     console.log("Auto-login falhou. A mostrar ecr√£ de login.");
                 }
            } else {
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
            }
        }

        (async () => {
             try {
                 await signInAnonymously(auth);
                 await checkLocalStorage();
             } catch (error) {
                 console.error("Firebase Auth Error:", error);
                 accessError.textContent = "N√£o foi poss√≠vel conectar ao servi√ßo.";
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
             }
        })();

    </script>
</body>
</html>

































