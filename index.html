<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela do Vendedor (v2.1 - Novos Dados)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease; }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            padding: 2px 5px;
            border-radius: 50%;
            background: red;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }
        .seller-notification-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .seller-notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .seller-notification-item blockquote {
            border-left: 3px solid #d1d5db; /* gray-300 */
            padding-left: 0.75rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            font-style: italic;
            color: #4b5563; /* gray-600 */
        }
        .manager-reply, .seller-reply {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .manager-reply {
            background-color: #f3f4f6; /* gray-100 */
            border-left: 3px solid #9ca3af; /* gray-400 */
        }
         .seller-reply {
            background-color: #f0f9ff; /* blue-50 */
            border-left: 3px solid #60a5fa; /* blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
        .status-dot {
            display: inline-block;
            width: 0.6rem; 
            height: 0.6rem;
            border-radius: 50%;
            margin-right: 0.5rem; 
            vertical-align: middle; 
        }
        .dot-yellow { background-color: #facc15; } /* yellow-400 */
        .dot-green { background-color: #4ade80; } /* green-400 */

    </style>
</head>
<body class="bg-gray-100">

    <!-- Access View -->
    <div id="access-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-md p-8 text-center">
            <div class="mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-20 w-20 text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Olá, vendedor(a) Doremus!</h1>
                <p class="text-gray-600 mt-2">Este é o seu painel de feedbacks de amostras (v2.1).</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="seller-name-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">O seu Nome de Vendedor</label>
                    <input type="text" id="seller-name-input" placeholder="Escreva seu nome (ex: JOAO SILVA)" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">Código de Acesso</label>
                    <input type="text" id="access-code-input" placeholder="Insira o código de 6 dígitos" class="w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                </div>
            </div>
            <button id="load-data-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">Aceder Amostras</button>
            <p id="access-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            <p class="text-xs text-gray-400 mt-8">Doremus, 2026 (v2.1 - Estrutura Nova)</p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden flex flex-col items-center justify-center min-h-screen text-center">
        <h1 id="loading-message" class="text-2xl font-bold text-gray-700">A carregar...</h1>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-6xl"> <!-- Aumentado para comportar novas colunas -->
             <header class="mb-8 text-center relative flex justify-between items-start">
                 <div> 
                     <h1 id="welcome-title" class="text-3xl font-bold text-gray-800 text-left">Olá!</h1>
                     <p id="session-info" class="text-gray-600 mt-2 text-left text-sm">Sessão: ...</p>
                 </div>
                 <div class="flex items-center gap-4"> 
                     <div class="relative flex flex-col items-center">
                         <button id="seller-notification-btn" class="relative text-gray-500 hover:text-gray-700" title="Ver respostas do gestor">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                             <span id="seller-notification-count" class="notification-badge hidden">0</span>
                         </button>
                         <p id="notification-prompt" class="hidden text-xs text-blue-600 font-semibold animate-pulse">↓ Verificar</p>
                     </div>
                     <button id="logout-btn" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg text-sm hover:bg-red-600 transition-colors h-fit">Sair</button>
                 </div>
            </header>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-200">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Como Funciona? (v2.1)</h3>
                    <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <li>Expanda um pedido para ver as amostras e <strong>detalhes novos (Preço/Estoque)</strong>.</li>
                        <li>Clique em <strong>"Atualizar"</strong> (ou "Editar" se já respondeu).</li>
                        <li>Selecione uma opção e escreva a observação.</li>
                        <li>Quando todas as amostras de um pedido forem respondidas (todas <span class="status-dot dot-green"></span>), clique em <strong>"Sinalizar Gestor"</strong>.</li>
                    </ol>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Suporte</h3>
                    <p class="text-sm text-gray-600">Se notar dados incorretos nos novos campos (Preço/Estoque), contate o P&D.</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-800">Equipe de Sistemas</p>
                    </div>
                </div>
            </div>

            <div id="pending-section" class="hidden">
                <h2 id="pending-orders-count" class="text-2xl font-bold text-gray-800 mb-4">Pedidos Pendentes</h2>
                <div id="pending-orders-list" class="space-y-4"></div>
            </div>

            <div id="completed-section" class="mt-12 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Concluídos e Sinalizados</h2>
                <div id="completed-orders-list" class="space-y-4"></div>
            </div>

            <div id="no-data-message" class="hidden text-center bg-white p-8 rounded-2xl shadow-sm border">
                 <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                 <h2 class="mt-4 text-2xl font-bold text-gray-800">Nenhuma amostra encontrada.</h2>
                 <p class="text-gray-600 mt-2">Verifique se os dados de acesso estão corretos ou contate o gestor.</p>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 flex flex-col max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-4 flex-shrink-0" id="modal-title">Atualizar Feedback</h3>
            
            <!-- NEW: Extra info display in modal -->
            <div id="modal-extra-info" class="mb-4 bg-gray-50 p-2 rounded text-xs text-gray-500 hidden">
                 <!-- Populated via JS -->
            </div>

            <p class="text-gray-600 mb-2 flex-shrink-0">Selecione uma das opções abaixo para a amostra:</p>
            <p class="font-semibold text-gray-800 mb-6 flex-shrink-0" id="modal-sample-info"></p>

            <div id="feedback-options" class="grid grid-cols-2 gap-3 mb-6 overflow-y-auto">
                <!-- Feedback buttons populated by JS -->
            </div>

            <div class="flex-shrink-0">
                <label for="observation" class="block text-sm font-medium text-gray-700 mb-2">Observação (Obrigatório)</label>
                <textarea id="observation" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Justifique o motivo do feedback..."></textarea>
            </div>

            <div class="mt-8 flex justify-end space-x-3 flex-shrink-0">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="save-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

     <!-- Seller Notifications Modal (Added z-30) -->
     <div id="seller-notifications-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
             <div class="flex justify-between items-center mb-4 border-b pb-2">
                  <h3 class="text-xl font-bold">Respostas do Gestor</h3>
                  <button id="close-seller-notifications-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
             </div>
             <div id="seller-notifications-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                  <p class="text-gray-500">Nenhuma resposta recebida.</p>
                  <!-- Notifications populated by JS -->
             </div>
              <div class="mt-6 flex justify-end">
                   <button id="close-seller-notifications-btn-bottom" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
              </div>
         </div>
     </div>

     <!-- Seller Reply Modal (NEW - Added z-40) -->
     <div id="seller-reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
             <h3 class="text-xl font-bold mb-4">Responder ao Gestor</h3>
             <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                 <p id="seller-reply-context" class="text-gray-600"></p>
                 <p id="seller-reply-original-msg" class="font-semibold italic"></p>
             </div>
             <div class="space-y-4">
                  <div>
                       <label for="seller-reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta</label>
                       <textarea id="seller-reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta..."></textarea>
                  </div>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-seller-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-seller-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
             </div>
         </div>
     </div>

    <!-- Custom Alert/Modal for errors -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro. Tente novamente.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, setDoc, 
            serverTimestamp, query, where, writeBatch, limit, addDoc, Timestamp,
            runTransaction, collectionGroup, getDocs
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // CONFIGURAÇÃO DINÂMICA (Idealmente viria do DB)
        const APP_CONFIG = {
            feedbackOptions: [
                'A - COM PEDIDO',
                'A - APROVADA SEM PEDIDO',
                'P - AMOSTRA NÃO TESTADA',
                'P - EM ANÁLISE',
                'P - AMOSTRA SEM FEEDBACK',
                'R - APRESENTAÇÃO PRÓ ATIVA',
                'R - CALIBRE',
                'R - EXTRAVIADA',
                'R - FORA DA ESPECIFICAÇÃO DO CLIENTE',
                'R - FORA DO PERFIL DO CLIENTE',
                'R - FRACA / ESTOURANDO / COM CHUVEIRO',
                'R - PRODUTO DESCONTINUADO',
                'R - QUANTIDADE INSUFICIENTE',
                'R - REPRESENTAÇÃO / DISTRIBUIDOR',
                'R - SEM RETORNO DO CLIENTE',
                'E - INNOVATION / EVENTOS',
                'E - EVENTO',
                'R - EXPORTACAO'
            ]
        };

        // --- DOM Elements ---
        const accessView = document.getElementById('access-view');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const loadDataBtn = document.getElementById('load-data-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const accessError = document.getElementById('access-error');
        const noDataMessage = document.getElementById('no-data-message');
        const welcomeTitle = document.getElementById('welcome-title');
        const sessionInfo = document.getElementById('session-info');

        // Seller Notification Elements
        const sellerNotificationBtn = document.getElementById('seller-notification-btn');
        const sellerNotificationCount = document.getElementById('seller-notification-count');
        const sellerNotificationsModal = document.getElementById('seller-notifications-modal');
        const sellerNotificationsList = document.getElementById('seller-notifications-list');
        const closeSellerNotificationsBtn = document.getElementById('close-seller-notifications-btn');
        const closeSellerNotificationsBtnBottom = document.getElementById('close-seller-notifications-btn-bottom');
        const notificationPrompt = document.getElementById('notification-prompt');

        // Seller Reply Modal Elements
        const sellerReplyModal = document.getElementById('seller-reply-modal');
        const sellerReplyContext = document.getElementById('seller-reply-context');
        const sellerReplyOriginalMsg = document.getElementById('seller-reply-original-msg');
        const sellerReplyMessageInput = document.getElementById('seller-reply-message-input');
        const cancelSellerReplyBtn = document.getElementById('cancel-seller-reply-btn');
        const sendSellerReplyBtn = document.getElementById('send-seller-reply-btn');
        let currentNotificationForReply = null; 

        // Feedback Modal Elements
        const feedbackModal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSampleInfo = document.getElementById('modal-sample-info');
        const modalExtraInfo = document.getElementById('modal-extra-info'); // New
        const feedbackOptionsContainer = document.getElementById('feedback-options');
        const observationInput = document.getElementById('observation');
        const cancelFeedbackModalBtn = document.getElementById('cancel-modal-btn'); 
        const saveFeedbackBtn = document.getElementById('save-button'); 

        // Custom Alert Elements
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- State Variables ---
        let currentSample = null; 
        let selectedFeedback = null; 
        let currentSellerDocRef = null; 
        let allSellerSamples = []; 
        let dataListenersUnsubscribe = []; 
        let sellerNotificationListenerUnsubscribe = null; 
        let currentSessionId = null; 
        let currentSellerOriginalName = null; 
        let sellerNotifications = []; 
        let currentActiveSessionName = "Sessão"; 

        // --- Utility Functions ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';
        const sanitizeForFirebaseId = (text) => normalizeText(text).replace(/\//g, "-");
        
        // NEW: Formatter for currency
        const formatCurrency = (value) => {
            if (value === undefined || value === null) return '---';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; 
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));
        
        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã ou contate o suporte.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança.";
            }
            showAlert(message, title, color);
        }

        // --- Authentication & Data Loading ---
        
        async function getActiveSession() {
             try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    const sessionDocId = docSnap.data().current;
                    const sessionConfigRef = doc(db, "sessoes", sessionDocId, "configuracoes", "geral");
                    const configSnap = await getDoc(sessionConfigRef);
                    const sessionName = configSnap.exists() ? configSnap.data().nome : sessionDocId;
                    return { id: sessionDocId, name: sessionName };
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }
        
        async function attemptLogin(sellerName, accessCode, isAutoLogin = false) {
            if (!sellerName || !accessCode) {
                if (!isAutoLogin) accessError.textContent = 'Nome e Código são obrigatórios.';
                return false;
            }

            loadingMessage.textContent = 'A procurar sessão ativa...';
            accessView.classList.add('hidden');
            loadingState.classList.remove('hidden');

            const session = await getActiveSession();
            if (!session) {
                accessError.textContent = 'Nenhuma sessão de feedback ativa encontrada. Contate o gestor.';
                loadingState.classList.add('hidden');
                accessView.classList.remove('hidden');
                return false;
            }
            
            currentSessionId = session.id;
            currentActiveSessionName = session.name;
            sessionInfo.textContent = `Sessão: ${currentActiveSessionName}`;
            
            const sellerId = sanitizeForFirebaseId(sellerName); 
            currentSellerOriginalName = sellerName; 

            try {
                const docRef = doc(db, "sessoes", currentSessionId, "vendedores", sellerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().accessCode === accessCode) {
                    currentSellerDocRef = docRef;
                    currentSellerOriginalName = docSnap.data().originalName; 
                    welcomeTitle.textContent = `Olá, ${currentSellerOriginalName}!`; 

                    if (!isAutoLogin) {
                        localStorage.setItem('sellerNameV2', currentSellerOriginalName); 
                        localStorage.setItem('sellerAccessCodeV2', accessCode);
                    }

                    accessError.textContent = '';
                    loadingState.textContent = 'A carregar as suas amostras...';

                    requestNotificationPermission(); 
                    startRealtimeListeners(); 
                    listenForSellerNotifications(); 
                    return true;
                } else {
                    if (isAutoLogin) {
                        localStorage.clear(); 
                        loadingState.classList.add('hidden');
                        accessView.classList.remove('hidden'); 
                    } else if (docSnap.exists()) {
                        accessError.textContent = 'Código de Acesso inválido.';
                    } else {
                        accessError.textContent = 'Vendedor não encontrado. Verifique o nome.';
                    }
                    loadingState.classList.add('hidden');
                    accessView.classList.remove('hidden');
                    return false;
                }
            } catch (e) {
                handleFirestoreError(e, "tentativa de login");
                if (isAutoLogin) localStorage.clear();
                loadingState.classList.add('hidden');
                accessView.classList.remove('hidden');
                accessError.textContent = 'Erro ao conectar. Tente novamente.';
                return false;
            } finally {
                if (!isAutoLogin && loadDataBtn) {
                     loadDataBtn.disabled = false;
                     loadDataBtn.textContent = 'Aceder Amostras';
                }
            }
        }

        // --- Event Listeners ---
        loadDataBtn.addEventListener('click', () => {
             loadDataBtn.disabled = true;
             loadDataBtn.textContent = 'A verificar...';
            const sellerName = document.getElementById('seller-name-input').value.trim();
            const accessCode = document.getElementById('access-code-input').value.trim();
            attemptLogin(sellerName, accessCode);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('sellerNameV2');
            localStorage.removeItem('sellerAccessCodeV2');
            
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();
            
            allSellerSamples = [];
            sellerNotifications = [];
            currentSellerDocRef = null;
            currentSessionId = null;
            
            window.location.reload(); 
        });

        sellerNotificationBtn.addEventListener('click', showSellerNotifications);
        closeSellerNotificationsBtn.addEventListener('click', hideSellerNotifications);
        closeSellerNotificationsBtnBottom.addEventListener('click', hideSellerNotifications);
        
        cancelSellerReplyBtn.addEventListener('click', () => {
            sellerReplyModal.classList.add('hidden');
            showSellerNotifications(); 
        });
        sendSellerReplyBtn.addEventListener('click', sendReplyToManager);

        feedbackOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('feedback-choice-btn')) {
                feedbackOptionsContainer.querySelectorAll('.feedback-choice-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedFeedback = e.target.dataset.feedback;
                validateFeedbackForm();
            }
        });
        cancelFeedbackModalBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
        observationInput.addEventListener('input', validateFeedbackForm);
        saveFeedbackBtn.addEventListener('click', saveFeedback); 


        // --- Realtime Data & Notification Listeners ---
        
        function startRealtimeListeners() {
            if (dataListenersUnsubscribe.length > 0) {
                dataListenersUnsubscribe.forEach(unsub => unsub());
                dataListenersUnsubscribe = [];
            }
            if (!currentSellerDocRef) {
                 console.error("Seller document reference not set.");
                 loadingState.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Erro.</h1><p class="mt-2">Não foi possível carregar os dados. Tente fazer login novamente.</p>`;
                 return;
            }
            
            // Pending samples
            const pendingQuery = query(
                collection(db, currentSellerDocRef.path, "amostras"),
                where("finalizedByVendor", "==", false)
            );
            const unsubPending = onSnapshot(pendingQuery, (snapshot) => {
                const pendingSamples = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                updateLocalSamples(pendingSamples, 'pending');
                renderDashboard();
            }, (error) => {
                handleFirestoreError(error, "ouvir amostras pendentes");
            });

            // Completed samples
            const completedQuery = query(
                collection(db, currentSellerDocRef.path, "amostras"),
                where("finalizedByVendor", "==", true)
            );
            const unsubCompleted = onSnapshot(completedQuery, (snapshot) => {
                const completedSamples = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                updateLocalSamples(completedSamples, 'completed');
                renderDashboard();
            }, (error) => {
                handleFirestoreError(error, "ouvir amostras concluídas");
            });
            
            dataListenersUnsubscribe.push(unsubPending, unsubCompleted);
        }
        
        function updateLocalSamples(newSamples, type) {
            const isCompleted = type === 'completed';
            
            allSellerSamples = allSellerSamples.filter(sample => {
                const wasInThisType = sample.finalizedByVendor === isCompleted;
                if (!wasInThisType) return true;
                return newSamples.some(s_new => s_new.id === sample.id);
            });
            
            newSamples.forEach(newSample => {
                 const index = allSellerSamples.findIndex(s_old => s_old.id === newSample.id);
                 if (index > -1) {
                     allSellerSamples[index] = newSample; 
                 } else {
                     allSellerSamples.push(newSample); 
                 }
            });
        }
        
        function renderDashboard() {
            loadingState.classList.add('hidden');
            mainContent.classList.remove('hidden');

            if (allSellerSamples.length === 0) {
                noDataMessage.classList.remove('hidden');
                document.getElementById('pending-section').classList.add('hidden');
                document.getElementById('completed-section').classList.add('hidden');
            } else {
                noDataMessage.classList.add('hidden');
                const pendingSamples = allSellerSamples.filter(s => !s.finalizedByVendor);
                const completedSamples = allSellerSamples.filter(s => s.finalizedByVendor);
                renderOrders(pendingSamples, 'pending'); 
                renderOrders(completedSamples, 'completed');
            }
        }


        function listenForSellerNotifications() {
            if (!currentSessionId || !currentSellerOriginalName) return;
            if (sellerNotificationListenerUnsubscribe) sellerNotificationListenerUnsubscribe();

            const q = query(
                collection(db, "sessoes", currentSessionId, "notificacoesVendedor"),
                where("sellerName", "==", currentSellerOriginalName)
            );

            sellerNotificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 const previousUnreadCount = sellerNotifications.filter(n => !n.read).length;
                 
                 sellerNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 sellerNotifications.sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));

                 updateSellerNotificationBadge(); 

                 if (sellerNotifications.filter(n => !n.read).length > previousUnreadCount && !snapshot.metadata.hasPendingWrites) {
                     snapshot.docChanges().forEach((change) => {
                         if (change.type === "added" && !change.doc.metadata.fromCache) {
                             const newData = change.doc.data();
                             if (!newData.read) {
                                 showBrowserNotification(
                                     `Resposta de ${newData.managerName}`,
                                     `Ref. ${newData.produto} (${newData.pedido}): ${newData.replyMessage}`
                                 );
                             }
                         }
                     });
                 }
            }, (error) => {
                handleFirestoreError(error, "ouvir notificações do vendedor");
            });
        }

        // --- UI Rendering Functions (UPDATED FOR NEW DATA) ---

        function renderOrders(samplesToDisplay, type) { 
            const isPendingSection = type === 'pending';
            const container = document.getElementById(`${type}-orders-list`);
            const section = document.getElementById(`${type}-section`);

            if (!container || !section) return; 

            if (samplesToDisplay.length === 0) {
                section.classList.add('hidden');
                if (isPendingSection) {
                     const countEl = document.getElementById('pending-orders-count');
                     if (countEl) countEl.textContent = `Nenhum Pedido Pendente`;
                 }
                return;
            }

            section.classList.remove('hidden');
            container.innerHTML = ''; 

            const groupedByOrder = samplesToDisplay.reduce((acc, sample) => {
                const key = sample.pedido;
                if (!acc[key]) acc[key] = { ...sample, samples: [] }; 
                acc[key].samples.push(sample);
                return acc;
            }, {});

             const sortedOrderKeys = Object.keys(groupedByOrder).sort((a, b) => {
                 const numA = parseInt(a, 10);
                 const numB = parseInt(b, 10);
                 if (!isNaN(numA) && !isNaN(numB)) {
                     return numA - numB; 
                 }
                 return a.localeCompare(b); 
             });

            if (isPendingSection) {
                const countEl = document.getElementById('pending-orders-count');
                 if (countEl) countEl.textContent = `${sortedOrderKeys.length} Pedido(s) ${sortedOrderKeys.length > 1 ? '' : ' '}com Pendências`;
            }

             sortedOrderKeys.forEach(orderId => {
                 const order = groupedByOrder[orderId];
                const orderGroup = document.createElement('div');
                const allSamplesInThisOrderAnswered = order.samples.every(s => !s.isPending);
                const statusColor = isPendingSection ? (allSamplesInThisOrderAnswered ? 'blue' : 'yellow') : 'green';
                orderGroup.className = `bg-white rounded-2xl shadow-sm border-l-4 border-${statusColor}-400 fade-in`;

                orderGroup.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer order-header" data-order-id="${orderId}">
                        <div>
                            <h3 class="font-bold text-lg flex items-center"><span class="w-3 h-3 bg-${statusColor}-400 rounded-full mr-3"></span>${order.pedido} - ${order.razaoSocial || 'Cliente Desconhecido'}</h3>
                            <p class="text-sm text-gray-500 ml-6">Nota Fiscal: ${order.notaFiscal || 'N/A'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="overflow-x-auto samples-table hidden">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 text-left">
                                <tr>
                                    <th class="p-3 font-medium text-gray-500 w-1/4">Produto</th>
                                    <th class="p-3 font-medium text-gray-500">Qtde.</th>
                                    <!-- NEW COLUMNS -->
                                    <th class="p-3 font-medium text-gray-500">Preço Sug.</th>
                                    <th class="p-3 font-medium text-gray-500">Estoque</th>
                                    <!-- END NEW COLUMNS -->
                                    <th class="p-3 font-medium text-gray-500 hidden md:table-cell">Status Atual</th>
                                    <th class="p-3 font-medium text-gray-500 w-1/4">Feedback</th>
                                    <th class="p-3 w-24"></th> 
                                </tr>
                            </thead>
                            <tbody>${
                                order.samples.map(sample => {
                                    const qty = parseFloat(String(sample.qtde || '0').replace(',', '.'));
                                    let formattedQty = '';
                                    if (!isNaN(qty)) {
                                        formattedQty = qty >= 1 || qty === 0 ? `${qty.toFixed(3).replace('.', ',')}kg` : `${Math.round(qty * 1000)}g`;
                                    } else {
                                        formattedQty = sample.qtde || 'N/A';
                                    }
                                    
                                    // New Data Safe Handling
                                    const priceDisplay = sample.price ? formatCurrency(sample.price) : '<span class="text-gray-300">---</span>';
                                    const stockDisplay = sample.stock ? `${sample.stock} un` : '<span class="text-gray-300">---</span>';

                                    const feedbackDisplay = sample.isPending
                                        ? '<span class="text-yellow-600 font-semibold">Pendente</span>'
                                        : `<div>${sample.feedback || 'N/A'}</div><div class='text-gray-500 font-normal text-xs'>${sample.observation || ''}</div>`;

                                    const deleteButtonHtml = !sample.isPending && isPendingSection
                                        ? `<button class="delete-btn bg-red-100 text-red-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-red-200" data-sample-id='${sample.id}'>Excluir</button>`
                                        : '';
                                    const updateButtonText = sample.isPending ? 'Atualizar' : 'Editar';
                                    
                                    const updateButtonHtml = `<button class="update-btn bg-blue-100 text-blue-800 font-bold py-1 px-3 rounded-md text-xs hover:bg-blue-200" data-sample-id='${sample.id}'>${updateButtonText}</button>`;

                                    const dotColorClass = sample.isPending ? 'dot-yellow' : 'dot-green';

                                    return `
                                        <tr class="border-b last:border-b-0 hover:bg-gray-50">
                                            <td class="p-3">
                                                <span class="status-dot ${dotColorClass}"></span>
                                                <div class="inline-block align-middle">
                                                    <p class="font-semibold text-gray-800">${sample.produto}</p>
                                                    <p class="text-xs text-gray-500">${sample.descricao || ''}</p>
                                                </div>
                                            </td>
                                            <td class="p-3 font-medium">${formattedQty}</td>
                                            <!-- NEW DATA CELLS -->
                                            <td class="p-3 text-gray-600">${priceDisplay}</td>
                                            <td class="p-3 text-gray-600">${stockDisplay}</td>
                                            <!-- END NEW DATA CELLS -->
                                            <td class="p-3 hidden md:table-cell text-gray-600">${sample.originalStatus || 'N/A'}</td>
                                            <td class="p-3">${feedbackDisplay}</td>
                                            <td class="p-3 text-right space-x-2">
                                                ${updateButtonHtml}
                                                ${deleteButtonHtml}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')
                            }</tbody>
                        </table>
                        ${isPendingSection && allSamplesInThisOrderAnswered ? `
                        <div class="p-4 border-t text-right bg-blue-50">
                            <p class="text-sm text-gray-700 text-left mb-2">Todas as amostras deste pedido foram respondidas. Clique abaixo para notificar o gestor.</p>
                            <button class="signal-manager-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700" data-order-id="${order.pedido}">Sinalizar Gestor</button>
                        </div>` : ''}
                        ${!isPendingSection ? `
                        <div class="p-3 border-t text-xs text-gray-500 bg-gray-50 text-center flex justify-center">
                             Este pedido já foi sinalizado.
                             <button class="resignal-manager-btn bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg text-xs hover:bg-blue-200 ml-4" data-order-id="${order.pedido}">Reenviar Notificação</button>
                        </div>` : ''}
                    </div>
                `;

                container.appendChild(orderGroup);
            });

            container.querySelectorAll('.order-header').forEach(header => {
                header.addEventListener('click', () => {
                    const tableDiv = header.nextElementSibling;
                    const arrow = header.querySelector('svg');
                    tableDiv?.classList.toggle('hidden'); 
                    arrow?.classList.toggle('rotate-180');
                });
            });

             container.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sampleToUpdate = allSellerSamples.find(s => s.id === btn.dataset.sampleId);
                    if (sampleToUpdate) openFeedbackModal(sampleToUpdate);
                });
            });
             container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const sampleId = e.currentTarget.dataset.sampleId;
                    if (!confirm('Tem a certeza que quer excluir este feedback e voltar a amostra para pendente?')) {
                         return;
                    }
                    
                    e.currentTarget.disabled = true;
                    const sampleRef = doc(db, currentSellerDocRef.path, "amostras", sampleId);
                    try {
                        await updateDoc(sampleRef, {
                            isPending: true, 
                            feedback: '', 
                            observation: '', 
                            finalizedByVendor: false, 
                            editedAfterCompletion: false, 
                            lastUpdate: serverTimestamp() 
                        });
                    } catch (error) {
                         handleFirestoreError(error, "excluir feedback");
                         e.currentTarget.disabled = false;
                    }
                });
            });
              container.querySelectorAll('.signal-manager-btn, .resignal-manager-btn').forEach(btn => {
                  btn.addEventListener('click', (e) => signalManager(e, btn.dataset.orderId));
              });
        }
        
        async function signalManager(event, orderId) {
             const btn = event.currentTarget;
             const isResignal = btn.classList.contains('resignal-manager-btn');
             btn.disabled = true;
             btn.textContent = 'A sinalizar...';

             try {
                const samplesToUpdateQuery = query(
                    collection(db, currentSellerDocRef.path, "amostras"),
                    where("pedido", "==", orderId),
                    where("isPending", "==", false) 
                );
                
                const samplesSnapshot = await getDocs(samplesToUpdateQuery);
                
                if (samplesSnapshot.empty && !isResignal) {
                     showAlert("Nenhuma amostra respondida encontrada para este pedido.", "Aviso", "text-amber-600");
                     btn.disabled = false;
                     btn.textContent = 'Sinalizar Gestor';
                     return;
                }
                
                const batch = writeBatch(db);
                samplesSnapshot.forEach(sampleDoc => {
                    batch.update(sampleDoc.ref, { finalizedByVendor: true });
                });
                await batch.commit();
                
                const sellerName = currentSellerOriginalName;
                const message = `<strong>${sellerName}</strong> ${isResignal ? 'reenviou a notificação' : 'sinalizou'} do pedido: <strong>${orderId}</strong>.`;
                const notifId = sanitizeForFirebaseId(`${sellerName}-${orderId}-concluido-${Date.now()}`);
                const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                await setDoc(notifRef, {
                    message,
                    color: isResignal ? 'orange' : 'purple',
                    timestamp: serverTimestamp(),
                    triggerPopup: true 
                });
                
                if (isResignal) {
                    btn.textContent = 'Reenviado!';
                    setTimeout(() => {
                        btn.textContent = 'Reenviar Notificação';
                        btn.disabled = false;
                    }, 2000);
                }
                
             } catch(error) {
                 handleFirestoreError(error, "sinalizar gestor");
                 btn.disabled = false;
                 btn.textContent = isResignal ? 'Reenviar Notificação' : 'Sinalizar Gestor';
             }
        }

        // --- Feedback Modal Functions ---
        function openFeedbackModal(sample) {
            currentSample = sample;
            selectedFeedback = sample.feedback || null; 
            observationInput.value = sample.observation || '';
            modalSampleInfo.textContent = `${sample.produto} - ${sample.descricao || ''}`;
            modalTitle.textContent = sample.isPending ? 'Atualizar Feedback' : 'Editar Feedback'; 
            
            // NEW: Show extra info in modal
            if (sample.price || sample.stock) {
                 modalExtraInfo.innerHTML = `Info Adicional: <strong>Preço:</strong> ${formatCurrency(sample.price)} | <strong>Estoque:</strong> ${sample.stock || '---'}`;
                 modalExtraInfo.classList.remove('hidden');
            } else {
                 modalExtraInfo.classList.add('hidden');
            }

            feedbackOptionsContainer.innerHTML = ''; 
            APP_CONFIG.feedbackOptions.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.dataset.feedback = choice;
                button.className = 'feedback-choice-btn border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg hover:bg-gray-100 transition-all';
                if (choice === selectedFeedback) button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                feedbackOptionsContainer.appendChild(button);
            });

            validateFeedbackForm(); 
            feedbackModal.classList.remove('hidden'); 
        }

        function validateFeedbackForm() {
             saveFeedbackBtn.disabled = !observationInput.value.trim() || !selectedFeedback;
        }

        async function saveFeedback() { 
            if (saveFeedbackBtn.disabled) return;
            saveFeedbackBtn.disabled = true;
            saveFeedbackBtn.textContent = 'A guardar...';

             const isEditing = !currentSample.isPending;
             const oldFeedback = currentSample.feedback;
             const oldObservation = currentSample.observation;
             const newFeedback = selectedFeedback;
             const newObservation = observationInput.value.trim();
             const wasEdited = isEditing && (oldFeedback !== newFeedback || oldObservation !== newObservation);

            const updates = {
                isPending: false, 
                feedback: newFeedback,
                observation: newObservation,
                editedAfterCompletion: wasEdited, 
                lastUpdate: serverTimestamp() 
            };
            
            const sampleRef = doc(db, currentSellerDocRef.path, "amostras", currentSample.id);

            try {
                await updateDoc(sampleRef, updates);
                feedbackModal.classList.add('hidden');
                
                if (wasEdited) {
                    const sellerName = currentSellerOriginalName;
                    const message = `<strong>${sellerName}</strong> <i>editou</i> o feedback para <strong>${currentSample.produto}</strong> (Pedido ${currentSample.pedido}): ${newFeedback}`;
                    const notifId = sanitizeForFirebaseId(`edit-${currentSample.id}-${Date.now()}`);
                    const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                    await setDoc(notifRef, {
                        message,
                        color: 'orange', 
                        timestamp: serverTimestamp(), 
                        triggerPopup: true 
                    });
                }
                
            } catch (error) {
                 handleFirestoreError(error, "guardar feedback");
            } finally {
                saveFeedbackBtn.disabled = false;
                saveFeedbackBtn.textContent = 'Salvar';
            }
        }

        // --- Seller Notification Functions ---

        function updateSellerNotificationBadge() {
             if(!sellerNotificationCount || !notificationPrompt) return; 
            const unreadCount = sellerNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                sellerNotificationCount.textContent = unreadCount;
                sellerNotificationCount.classList.remove('hidden');
                notificationPrompt.classList.remove('hidden'); 
            } else {
                sellerNotificationCount.classList.add('hidden');
                notificationPrompt.classList.add('hidden'); 
            }
        }

        function showSellerNotifications() {
            sellerNotificationsList.innerHTML = ''; 
            if (sellerNotifications.length === 0) {
                 sellerNotificationsList.innerHTML = '<p class="text-gray-500">Nenhuma resposta recebida.</p>';
            } else {
                 sellerNotifications.forEach(notif => {
                     const itemDiv = document.createElement('div');
                     const hasSellerReply = notif.sellerReplyMessage && notif.sellerReplyMessage.trim() !== '';

                     const replyButtonHtml = `<button class="seller-reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">
                                                  ${hasSellerReply ? 'Ver/Responder' : 'Responder'}
                                             </button>`;
                    
                    const goToSampleButtonHtml = `<button class="go-to-sample-btn bg-green-100 text-green-700 hover:bg-green-200 px-2 py-1 rounded text-xs font-semibold ml-2" 
                                                      data-pedido="${notif.pedido}" 
                                                      data-produto="${notif.produto}" 
                                                      data-descricao="${notif.descricao || ''}">
                                                      Ir para Amostra
                                                  </button>`;

                     const readButtonHtml = !notif.read
                         ? `<button class="mark-as-read-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-2 py-1 rounded text-xs font-semibold ml-2" data-notif-id="${notif.id}">✓ Marcar como Lida</button>`
                         : `<span class="text-green-500 text-xs font-semibold ml-2">✓ Lida</span>`;

                     itemDiv.className = `seller-notification-item text-sm ${!notif.read ? 'font-semibold bg-blue-50 p-2 rounded' : 'text-gray-600 p-2'}`;
                     
                     itemDiv.innerHTML = `
                         <p class="mb-1">
                             <span class="font-bold">${notif.managerName}</span> respondeu sobre:
                         </p>
                         <div class="p-2 bg-gray-50 rounded border border-gray-200 mb-2">
                            <p><strong>Pedido:</strong> ${notif.pedido || 'N/A'}</p>
                            <p><strong>Produto:</strong> ${notif.produto || 'N/A'}</p>
                         </div>
                         
                         <div class="manager-reply">${notif.replyMessage}</div>

                         ${hasSellerReply ? `
                         <div class="seller-reply">
                              <p><strong>Você respondeu:</strong> ${notif.sellerReplyMessage}</p>
                         </div>` : ''}

                         ${notif.originalObservation ? `<blockquote>Observação Original: "${notif.originalObservation}"</blockquote>` : ''}

                         <div class="flex justify-between items-center mt-2">
                              <p class="text-xs text-gray-400">${notif.timestamp?.toDate() ? notif.timestamp.toDate().toLocaleString('pt-BR') : 'Data indisponível'}</p>
                              <div class="flex gap-2">
                                   ${goToSampleButtonHtml} 
                                   ${replyButtonHtml}
                                   ${readButtonHtml}
                              </div>
                         </div>
                     `;
                     sellerNotificationsList.appendChild(itemDiv);
                 });

                 sellerNotificationsList.querySelectorAll('.mark-as-read-btn').forEach(btn => {
                     btn.addEventListener('click', markNotificationAsRead);
                 });
                 sellerNotificationsList.querySelectorAll('.seller-reply-btn').forEach(btn => {
                     btn.addEventListener('click', openSellerReplyModal);
                 });
                 sellerNotificationsList.querySelectorAll('.go-to-sample-btn').forEach(btn => {
                     btn.addEventListener('click', findAndOpenSample);
                 });
            }
            sellerNotificationsModal.classList.remove('hidden'); 
             notificationPrompt.classList.add('hidden'); 
        }
        
        function findAndOpenSample(e) {
            const { pedido, produto } = e.currentTarget.dataset;
            
            const sampleToFind = allSellerSamples.find(s => 
                s.pedido === pedido && 
                s.produto === produto
            );
            
            if (sampleToFind) {
                hideSellerNotifications();
                
                const orderHeader = document.querySelector(`.order-header[data-order-id="${pedido}"]`);
                if (orderHeader) {
                    const tableDiv = orderHeader.nextElementSibling;
                    const arrow = orderHeader.querySelector('svg');
                    if (tableDiv?.classList.contains('hidden')) {
                         tableDiv.classList.remove('hidden');
                         arrow?.classList.add('rotate-180');
                    }
                    orderHeader.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                openFeedbackModal(sampleToFind);
            } else {
                showAlert("Amostra não encontrada. Pode ter sido alterada ou o pedido já não está visível.");
            }
        }


        function hideSellerNotifications() {
            sellerNotificationsModal.classList.add('hidden');
        }

        async function markNotificationAsRead(e) {
            const notifId = e.target.dataset.notifId;
            e.target.disabled = true;
            e.target.textContent = 'A marcar...';
            const notifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", notifId);
            try {
                await updateDoc(notifRef, { read: true });
                 const notifIndex = sellerNotifications.findIndex(n => n.id === notifId);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                 }
                 showSellerNotifications(); 
                 updateSellerNotificationBadge(); 
            } catch (err) {
                 handleFirestoreError(err, "marcar notificação como lida");
                 e.target.disabled = false;
                 e.target.textContent = '✓ Marcar como Lida';
            }
        }

        function openSellerReplyModal(e) {
            const notifId = e.target.dataset.notifId;
            const notification = sellerNotifications.find(n => n.id === notifId);
            if (!notification) return;

            currentNotificationForReply = notification; 

            sellerReplyContext.textContent = `Em resposta a ${notification.managerName} (Ref. ${notification.produto}):`;
            sellerReplyOriginalMsg.textContent = `"${notification.replyMessage}"`;
            sellerReplyMessageInput.value = notification.sellerReplyMessage || ''; 

            sellerNotificationsModal.classList.add('hidden'); 
            sellerReplyModal.classList.remove('hidden'); 
        }

        async function sendReplyToManager() {
            if (!currentNotificationForReply || !currentSessionId || !currentSellerOriginalName) return;

            const replyMessage = sellerReplyMessageInput.value.trim();
            if (!replyMessage) {
                showAlert("Por favor, escreva a sua resposta."); 
                return;
            }

            sendSellerReplyBtn.disabled = true;
            sendSellerReplyBtn.textContent = 'A Enviar...';

            try {
                const replyDataForManager = {
                    sellerName: currentSellerOriginalName,
                    replyMessage: replyMessage,
                    originalManagerMessage: currentNotificationForReply.replyMessage,
                    originalManagerName: currentNotificationForReply.managerName,
                    pedido: currentNotificationForReply.pedido,
                    produto: currentNotificationForReply.produto,
                    timestamp: serverTimestamp(), 
                    readByManager: false,
                    readByPd: false
                };
                const managerRepliesRef = collection(db, "sessoes", currentSessionId, "respostasVendedor");
                await addDoc(managerRepliesRef, replyDataForManager);

                const originalNotifRef = doc(db, "sessoes", currentSessionId, "notificacoesVendedor", currentNotificationForReply.id);
                await updateDoc(originalNotifRef, {
                    sellerReplyMessage: replyMessage, 
                    read: true 
                });

                 const notifIndex = sellerNotifications.findIndex(n => n.id === currentNotificationForReply.id);
                 if (notifIndex > -1) {
                      sellerNotifications[notifIndex].read = true;
                      sellerNotifications[notifIndex].sellerReplyMessage = replyMessage;
                 }
                 updateSellerNotificationBadge(); 

                 sellerReplyModal.classList.add('hidden'); 
                 showSellerNotifications(); 

            } catch (error) {
                handleFirestoreError(error, "enviar resposta ao gestor");
            } finally {
                sendSellerReplyBtn.disabled = false;
                sendSellerReplyBtn.textContent = 'Enviar Resposta';
                currentNotificationForReply = null; 
            }
        }


        // --- Browser Notification Functions ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("Este navegador não suporta notificações desktop");
                return;
            }
            if (Notification.permission !== 'denied') {
                 Notification.requestPermission().then(permission => {
                     console.log("Permissão de notificação:", permission);
                 });
            }
        }

        function showBrowserNotification(title, body) {
            if (Notification.permission === 'granted') {
                 if (document.visibilityState === 'visible') { 
                      console.log("Tab is active, skipping browser notification.");
                      return;
                 }
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/fluency/96/send-letter.png' 
                });
            }
        }


        // --- Initial Load Logic ---
        async function checkLocalStorage() {
            const savedSellerName = localStorage.getItem('sellerNameV2');
            const savedAccessCode = localStorage.getItem('sellerAccessCodeV2');

            if (savedSellerName && savedAccessCode) {
                 loadingMessage.textContent = 'A verificar sessão guardada...';
                 accessView.classList.add('hidden');
                 loadingState.classList.remove('hidden');
                 const loginSuccess = await attemptLogin(savedSellerName, savedAccessCode, true); 
                 if (!loginSuccess) {
                     console.log("Auto-login falhou. A mostrar ecrã de login.");
                 }
            } else {
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
            }
        }

        (async () => {
             try {
                 await signInAnonymously(auth); 
                 await checkLocalStorage(); 
             } catch (error) {
                 console.error("Firebase Auth Error:", error);
                 accessError.textContent = "Não foi possível conectar ao serviço.";
                 accessView.classList.remove('hidden');
                 loadingState.classList.add('hidden');
             }
        })();

    </script>
</body>
</html>









































